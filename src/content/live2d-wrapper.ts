/**
 * Live2D Wrapper Module
 * This wrapper handles the CommonJS/ESM compatibility issues of the Live2D library
 */

// Import types from the original l2d module
import type { L2D, Model } from 'l2d';

// Global variable to check if the Live2D library is already loaded
declare global {
  interface Window {
    LIVE2D?: any;
  }
}

// Flag to track if the libraries have been injected
let librariesInjected = false;

/**
 * Loads the required Live2D libraries dynamically
 */
async function loadLive2DLibraries(): Promise<void> {
  if (librariesInjected) {
    return;
  }

  return new Promise((resolve, reject) => {
    // Check if libraries are already loaded
    if (window.LIVE2D) {
      librariesInjected = true;
      resolve();
      return;
    }

    // Create and load the cubism2 library
    const cubism2Script = document.createElement('script');
    cubism2Script.type = 'text/javascript';
    cubism2Script.textContent = `
      var __NONECONSOLE = {log(){}};
      (function(){var j=true;function aa(){if(j){return;}this._$MT=null;this._$5S=null;this._$NP=0;aa._$42++;this._$5S=new y(this);}aa._$0s=1;aa._$4s=2;aa._$42=0;aa._$62=function(aQ,aU){try{if(aU instanceof ArrayBuffer){aU=new DataView(aU);}if(!(aU instanceof DataView)){throw new J("_$SS#loadModel(b) / b _$x be DataView or ArrayBuffer");}var aS=new K(aU);var aM=aS._$ST();var aK=aS._$ST();var aJ=aS._$ST();var aN;if(aM==109&&aK==111&&aJ==99){aN=aS._$ST();}else{throw new J("_$gi _$C _$li , _$Q0 _$P0.");}aS._$gr(aN);if(aN>ay._$T7){aQ._$NP|=aa._$4s;var aR=ay._$T7;var aI="_$gi _$C _$li , _$n0 _$_ version _$li ( SDK : "+aR+" < _$f0 : "+aN+" )@_$SS#loadModel()\\\n";throw new J(aI);}var aL=aS._$nP();if(aN>=ay._$s7){var aH=aS._$9T();var aT=aS._$9T();if(aH!=-30584||aT!=-30584){aQ._$NP|=aa._$0s;throw new J("_$gi _$C _$li , _$0 _$6 _$Ui.");}}aQ._$KS(aL);var aP=aQ.getModelContext();aP.setDrawParam(aQ.getDrawParam());aP.init();}catch(aO){q._$Rb(aO);}};aa.prototype._$KS=function(aH){this._$MT=aH;};aa.prototype.getModelImpl=function(){if(this._$MT==null){this._$MT=new w();this._$MT._$zP();}return this._$MT;};aa.prototype.getCanvasWidth=function(){if(this._$MT==null){return 0;}return this._$MT.getCanvasWidth();};aa.prototype.getCanvasHeight=function(){if(this._$MT==null){return 0;}return this._$MT.getCanvasHeight();};aa.prototype.getParamFloat=function(aH){if(typeof aH!="number"){aH=this._$5S.getParamIndex(z.getID(aH));}return this._$5S.getParamFloat(aH);};aa.prototype.setParamFloat=function(aH,aJ,aI){if(typeof aH!="number"){aH=this._$5S.getParamIndex(z.getID(aH));}if(arguments.length<3){aI=1;}this._$5S.setParamFloat(aH,this._$5S.getParamFloat(aH)*(1-aI)+aJ*aI);};aa.prototype.addToParamFloat=function(aH,aJ,aI){if(typeof aH!="number"){aH=this._$5S.getParamIndex(z.getID(aH));}if(arguments.length<3){aI=1;}this._$5S.setParamFloat(aH,this._$5S.getParamFloat(aH)+aJ*aI);};aa.prototype.multParamFloat=function(aH,aJ,aI){if(typeof aH!="number"){aH=this._$5S.getParamIndex(z.getID(aH));}if(arguments.length<3){aI=1;}this._$5S.setParamFloat(aH,this._$5S.getParamFloat(aH)*(1+(aJ-1)*aI));};aa.prototype.getParamIndex=function(aH){return this._$5S.getParamIndex(z.getID(aH));};aa.prototype.loadParam=function(){this._$5S.loadParam();};aa.prototype.saveParam=function(){this._$5S.saveParam();};aa.prototype.init=function(){this._$5S.init();};aa.prototype.update=function(){this._$5S.update();};aa.prototype._$Rs=function(){q._$li("_$60 _$PT _$Rs()");return -1;};aa.prototype._$Ds=function(aH){q._$li("_$60 _$PT _$SS#_$Ds() \\n");};aa.prototype._$K2=function(){};aa.prototype.draw=function(){};aa.prototype.getModelContext=function(){return this._$5S;};aa.prototype._$s2=function(){return this._$NP;};aa.prototype._$P7=function(aK,aR,aH,a0){var aU=-1;var aY=0;var aM=this;var aJ=0.5;var aI=0.15;var aX=true;if(aH==0){for(var aV=0;aV<aK.length;aV++){var aP=aK[aV];var aO=aR[aV];var aS=(aM.getParamFloat(aP)!=0);aM.setPartsOpacity(aO,(aS?1:0));}return;}else{if(aK.length==1){var aP=aK[0];var aT=(aM.getParamFloat(aP)!=0);var aO=aR[0];var aQ=aM.getPartsOpacity(aO);var aW=aH/a0;if(aT){aQ+=aW;if(aQ>1){aQ=1;}}else{aQ-=aW;if(aQ<0){aQ=0;}}aM.setPartsOpacity(aO,aQ);}else{for(var aV=0;aV<aK.length;aV++){var aP=aK[aV];var aS=(aM.getParamFloat(aP)!=0);if(aS){if(aU>=0){break;}aU=aV;var aO=aR[aV];aY=aM.getPartsOpacity(aO);aY+=aH/a0;if(aY>1){aY=1;}}}if(aU<0){__NONECONSOLE.log("No _$wi _$q0/ _$U default[%s]",aK[0]);aU=0;aY=1;aM.loadParam();aM.setParamFloat(aK[aU],aY);aM.saveParam();}for(var aV=0;aV<aK.length;aV++){var aO=aR[aV];if(aU==aV){aM.setPartsOpacity(aO,aY);}else{var aL=aM.getPartsOpacity(aO);var aZ;if(aY<aJ){aZ=aY*(aJ-1)/aJ+1;}else{aZ=(1-aY)*aJ/(1-aJ);}if(aX){var aN=(1-aZ)*(1-aY);if(aN>aI){aZ=1-aI/(1-aY);}}if(aL>aZ){aL=aZ;}aM.setPartsOpacity(aO,aL);}}}}};aa.prototype.setPartsOpacity=function(aI,aH){if(typeof aI!="number"){aI=this._$5S.getPartsDataIndex(i.getID(aI));}this._$5S.setPartsOpacity(aI,aH);};aa.prototype.getPartsDataIndex=function(aH){if(!(aH instanceof i)){aH=i.getID(aH);}return this._$5S.getPartsDataIndex(aH);};aa.prototype.getPartsOpacity=function(aH){if(typeof aH!="number"){aH=this._$5S.getPartsDataIndex(i.getID(aH));}if(aH<0){return 0;}return this._$5S.getPartsOpacity(aH);};aa.prototype.getDrawParam=function(){};aa.prototype.getDrawDataIndex=function(aH){return this._$5S.getDrawDataIndex(Z.getID(aH));};aa.prototype.getDrawData=function(aH){return this._$5S.getDrawData(aH);};aa.prototype.getTransformedPoints=function(aH){var aI=this._$5S._$C2(aH);if(aI instanceof ag){return(aI).getTransformedPoints();}return null;};aa.prototype.getIndexArray=function(aI){if(aI<0||aI>=this._$5S._$aS.length){return null;}var aH=this._$5S._$aS[aI];if(aH!=null&&aH.getType()==a._$wb){if(aH instanceof b){return aH.getIndexArray();}}return null;};function W(aJ){if(j){return;}this.clipContextList=new Array();this.glcontext=aJ.gl;this.dp_webgl=aJ;this.curFrameNo=0;this.firstError_clipInNotUpdate=true;this.colorBuffer=0;this.isInitGLFBFunc=false;this.tmpBoundsOnModel=new av();if(Q.glContext.length>Q.frameBuffers.length){this.curFrameNo=this.getMaskRenderTexture();}else{}this.tmpModelToViewMatrix=new ac();this.tmpMatrix2=new ac();this.tmpMatrixForMask=new ac();this.tmpMatrixForDraw=new ac();this.CHANNEL_COLORS=new Array();var aI=new o();aI=new o();aI.r=0;aI.g=0;aI.b=0;aI.a=1;this.CHANNEL_COLORS.push(aI);aI=new o();aI.r=1;aI.g=0;aI.b=0;aI.a=0;this.CHANNEL_COLORS.push(aI);aI=new o();aI.r=0;aI.g=1;aI.b=0;aI.a=0;this.CHANNEL_COLORS.push(aI);aI=new o();aI.r=0;aI.g=0;aI.b=1;aI.a=0;this.CHANNEL_COLORS.push(aI);for(var aH=0;aH<this.CHANNEL_COLORS.length;aH++){this.dp_webgl.setChannelFlagAsColor(aH,this.CHANNEL_COLORS[aH]);}}W.CHANNEL_COUNT=4;W.RENDER_TEXTURE_USE_MIPMAP=false;W.NOT_USED_FRAME=-100;W.prototype._$L7=function(){if(this.tmpModelToViewMatrix){this.tmpModelToViewMatrix=null;}if(this.tmpMatrix2){this.tmpMatrix2=null;}if(this.tmpMatrixForMask){this.tmpMatrixForMask=null;}if(this.tmpMatrixForDraw){this.tmpMatrixForDraw=null;}if(this.tmpBoundsOnModel){this.tmpBoundsOnModel=null;}if(this.CHANNEL_COLORS){for(var aH=this.CHANNEL_COLORS.length-1;aH>=0;--aH){this.CHANNEL_COLORS.splice(aH,1);}this.CHANNEL_COLORS=[];}this.releaseShader();};W.prototype.releaseShader=function(){var aI=Q.frameBuffers.length;for(var aH=0;aH<aI;aH++){this.gl.deleteFramebuffer(Q.frameBuffers[aH].framebuffer);}Q.frameBuffers=[];Q.glContext=[];};W.prototype.init=function(aO,aN,aL){for(var aM=0;aM<aN.length;aM++){var aH=aN[aM].getClipIDList();if(aH==null){continue;}var aJ=this.findSameClip(aH);if(aJ==null){aJ=new U(this,aO,aH);this.clipContextList.push(aJ);}var aI=aN[aM].getDrawDataID();var aK=aO.getDrawDataIndex(aI);aJ.addClippedDrawData(aI,aK);var aP=aL[aM];aP.clipBufPre_clipContext=aJ;}};W.prototype.getMaskRenderTexture=function(){var aH=null;aH=this.dp_webgl.createFramebuffer();Q.frameBuffers[this.dp_webgl.glno]=aH;return this.dp_webgl.glno;};W.prototype.setupClip=function(a1,aQ){var aK=0;for(var aO=0;aO<this.clipContextList.length;aO++){var aP=this.clipContextList[aO];this.calcClippedDrawTotalBounds(a1,aP);if(aP.isUsing){aK++;}}if(aK>0){var aM=aQ.gl.getParameter(aQ.gl.FRAMEBUFFER_BINDING);var aW=new Array(4);aW[0]=0;aW[1]=0;aW[2]=aQ.gl.canvas.width;aW[3]=aQ.gl.canvas.height;aQ.gl.viewport(0,0,Q.clippingMaskBufferSize,Q.clippingMaskBufferSize);this.setupLayoutBounds(aK);aQ.gl.bindFramebuffer(aQ.gl.FRAMEBUFFER,Q.frameBuffers[this.curFrameNo].framebuffer);aQ.gl.clearColor(0,0,0,0);aQ.gl.clear(aQ.gl.COLOR_BUFFER_BIT);for(var aO=0;aO<this.clipContextList.length;aO++){var aP=this.clipContextList[aO];var aT=aP.allClippedDrawRect;var aN=aP.layoutChannelNo;var aV=aP.layoutBounds;var aJ=0.05;this.tmpBoundsOnModel._$jL(aT);this.tmpBoundsOnModel.expand(aT.width*aJ,aT.height*aJ);var aZ=aV.width/this.tmpBoundsOnModel.width;var aY=aV.height/this.tmpBoundsOnModel.height;this.tmpMatrix2.identity();this.tmpMatrix2.translate(-1,-1,0);this.tmpMatrix2.scale(2,2,1);this.tmpMatrix2.translate(aV.x,aV.y,0);this.tmpMatrix2.scale(aZ,aY,1);this.tmpMatrix2.translate(-this.tmpBoundsOnModel.x,-this.tmpBoundsOnModel.y,0);this.tmpMatrixForMask.setMatrix(this.tmpMatrix2.m);this.tmpMatrix2.identity();this.tmpMatrix2.translate(aV.x,aV.y,0);this.tmpMatrix2.scale(aZ,aY,1);this.tmpMatrix2.translate(-this.tmpBoundsOnModel.x,-this.tmpBoundsOnModel.y,0);this.tmpMatrixForDraw.setMatrix(this.tmpMatrix2.m);var aH=this.tmpMatrixForMask.getArray();for(var aX=0;aX<16;aX++){aP.matrixForMask[aX]=aH[aX];}var a0=this.tmpMatrixForDraw.getArray();for(var aX=0;aX<16;aX++){aP.matrixForDraw[aX]=a0[aX];}var aS=aP.clippingMaskDrawIndexList.length;for(var aU=0;aU<aS;aU++){var aR=aP.clippingMaskDrawIndexList[aU];var aI=a1.getDrawData(aR);var aL=a1._$C2(aR);aQ.setClipBufPre_clipContextForMask(aP);aI.draw(aQ,a1,aL);}}aQ.gl.bindFramebuffer(aQ.gl.FRAMEBUFFER,aM);aQ.setClipBufPre_clipContextForMask(null);aQ.gl.viewport(aW[0],aW[1],aW[2],aW[3]);}};W.prototype.getColorBuffer=function(){return this.colorBuffer;};W.prototype.findSameClip=function(aK){for(var aN=0;aN<this.clipContextList.length;aN++){var aO=this.clipContextList[aN];var aH=aO.clipIDList.length;if(aH!=aK.length){continue;}var aI=0;for(var aM=0;aM<aH;aM++){var aL=aO.clipIDList[aM];for(var aJ=0;aJ<aH;aJ++){if(aK[aJ]==aL){aI++;break;}}}if(aI==aH){return aO;}}return null;};W.prototype.calcClippedDrawTotalBounds=function(a6,aV){var aU=a6._$Ri.getModelImpl().getCanvasWidth();var a5=a6._$Ri.getModelImpl().getCanvasHeight();var aJ=aU>a5?aU:a5;var aT=aJ;var aR=aJ;var aS=0;var aP=0;var aL=aV.clippedDrawContextList.length;for(var aM=0;aM<aL;aM++){var aW=aV.clippedDrawContextList[aM];var aN=aW.drawDataIndex;var aK=a6._$C2(aN);if(aK._$yo()){var aX=aK.getTransformedPoints();var a4=aX.length;var aI=[];var aH=[];var aO=0;for(var a3=aw._$i2;a3<a4;a3+=aw._$No){aI[aO]=aX[a3];aH[aO]=aX[a3+1];aO++;}var a2=Math.min.apply(null,aI);var a1=Math.min.apply(null,aH);var a0=Math.max.apply(null,aI);var aZ=Math.max.apply(null,aH);if(a2<aT){aT=a2;}if(a1<aR){aR=a1;}if(a0>aS){aS=a0;}if(aZ>aP){aP=aZ;}}}if(aT==aJ){aV.allClippedDrawRect.x=0;aV.allClippedDrawRect.y=0;aV.allClippedDrawRect.width=0;aV.allClippedDrawRect.height=0;aV.isUsing=false;}else{var aQ=aS-aT;var aY=aP-aR;aV.allClippedDrawRect.x=aT;aV.allClippedDrawRect.y=aR;aV.allClippedDrawRect.width=aQ;aV.allClippedDrawRect.height=aY;aV.isUsing=true;}};W.prototype.setupLayoutBounds=function(aQ){var aI=aQ/W.CHANNEL_COUNT;var aP=aQ%W.CHANNEL_COUNT;aI=~~aI;aP=~~aP;var aH=0;for(var aJ=0;aJ<W.CHANNEL_COUNT;aJ++){var aM=aI+(aJ<aP?1:0);if(aM==0){}else{if(aM==1){var aL=this.clipContextList[aH++];aL.layoutChannelNo=aJ;aL.layoutBounds.x=0;aL.layoutBounds.y=0;aL.layoutBounds.width=1;aL.layoutBounds.height=1;}else{if(aM==2){for(var aO=0;aO<aM;aO++){var aN=aO%2;var aK=0;aN=~~aN;var aL=this.clipContextList[aH++];aL.layoutChannelNo=aJ;aL.layoutBounds.x=aN*0.5;aL.layoutBounds.y=0;aL.layoutBounds.width=0.5;aL.layoutBounds.height=1;}}else{if(aM<=4){for(var aO=0;aO<aM;aO++){var aN=aO%2;var aK=aO/2;aN=~~aN;aK=~~aK;var aL=this.clipContextList[aH++];aL.layoutChannelNo=aJ;aL.layoutBounds.x=aN*0.5;aL.layoutBounds.y=aK*0.5;aL.layoutBounds.width=0.5;aL.layoutBounds.height=0.5;}}else{if(aM<=9){for(var aO=0;aO<aM;aO++){var aN=aO%3;var aK=aO/3;aN=~~aN;aK=~~aK;var aL=this.clipContextList[aH++];aL.layoutChannelNo=aJ;aL.layoutBounds.x=aN/3;aL.layoutBounds.y=aK/3;aL.layoutBounds.width=1/3;aL.layoutBounds.height=1/3;}}else{q._$li("_$6 _$0P mask count : %d",aM);}}}}}};function U(aH,aK,aI){this.clipIDList=new Array();this.clipIDList=aI;this.clippingMaskDrawIndexList=new Array();for(var aJ=0;aJ<aI.length;aJ++){this.clippingMaskDrawIndexList.push(aK.getDrawDataIndex(aI[aJ]));}this.clippedDrawContextList=new Array();this.isUsing=true;this.layoutChannelNo=0;this.layoutBounds=new av();this.allClippedDrawRect=new av();this.matrixForMask=new Float32Array(16);this.matrixForDraw=new Float32Array(16);this.owner=aH;}U.prototype.addClippedDrawData=function(aJ,aI){var aH=new R(aJ,aI);this.clippedDrawContextList.push(aH);};function R(aI,aH){this._$gP=aI;this.drawDataIndex=aH;}function I(){if(j){return;}this.color=null;}function ah(){if(j){return;}this._$dP=null;this._$eo=null;this._$V0=null;this._$dP=1000;this._$eo=1000;this._$V0=1;this._$a0();}ah._$JT=function(aP,aN,aO){var aQ=aP/aN;var a1=aO/aN;var aU=a1;var aZ=1/3;var aR=2/3;var a0=1-(1-a1)*(1-a1);var a2=1-(1-aU)*(1-aU);var aM=0;var aL=((1-a1)*aZ)*a0+(aU*aR+(1-aU)*aZ)*(1-a0);var aK=(aU+(1-aU)*aR)*a2+(a1*aZ+(1-a1)*aR)*(1-a2);var aJ=1;var aY=aJ-3*aK+3*aL-aM;var aX=3*aK-6*aL+3*aM;var aW=3*aL-3*aM;var aV=aM;if(aQ<=0){return 0;}else{if(aQ>=1){return 1;}}var aS=aQ;var aI=aS*aS;var aH=aS*aI;var aT=aY*aH+aX*aI+aW*aS+aV;return aT;};ah.prototype._$a0=function(){};ah.prototype.setFadeIn=function(aH){this._$dP=aH;};ah.prototype.setFadeOut=function(aH){this._$eo=aH;};ah.prototype._$pT=function(aH){this._$V0=aH;};ah.prototype.getFadeOut=function(){return this._$eo;};ah.prototype._$4T=function(){return this._$eo;};ah.prototype._$mT=function(){return this._$V0;};ah.prototype.getDurationMSec=function(){return -1;};ah.prototype.getLoopDurationMSec=function(){return -1;};ah.prototype.updateParam=function(aJ,aN){if(!aN._$AT||aN._$9L){return;}var aL=P.getUserTimeMSec();if(aN._$z2<0){aN._$z2=aL;aN._$bs=aL;var aM=this.getDurationMSec();if(aN._$Do<0){aN._$Do=(aM<=0)?-1:aN._$z2+aM;}}var aI=this._$V0;var aH=(this._$dP==0)?1:A._$r2(((aL-aN._$bs)/(this._$dP)));var aK=(this._$eo==0||aN._$Do<0)?1:A._$r2(((aN._$Do-aL)/(this._$eo)));aI=aI*aH*aK;if(!((0<=aI&&aI<=1))){__NONECONSOLE.log("### assert!! ### ");}this.updateParamExe(aJ,aL,aI,aN);if(aN._$Do>0&&aN._$Do<aL){aN._$9L=true;}};ah.prototype.updateParamExe=function(aH,aI,aJ,aK){};function q(){}q._$8s=0;q._$fT=new Object();q.start=function(aI){var aH=q._$fT[aI];if(aH==null){aH=new af();aH._$r=aI;q._$fT[aI]=aH;}aH._$0S=P.getSystemTimeMSec();};q.dump=function(aJ){var aH=q._$fT[aJ];if(aH!=null){var aI=P.getSystemTimeMSec();var aK=aI-aH._$0S;__NONECONSOLE.log(aJ+" : "+aK+"ms");return aK;}else{return -1;}};q.end=function(aJ){var aH=q._$fT[aJ];if(aH!=null){var aI=P.getSystemTimeMSec();return aI-aH._$0S;}else{return -1;}};q._$li=function(aI,aH){__NONECONSOLE.log("_$li : "+aI+"\\n",aH);};q._$Ji=function(aI,aH){__NONECONSOLE.log(aI,aH);};q._$dL=function(aI,aH){__NONECONSOLE.log(aI,aH);__NONECONSOLE.log("\\n");};q._$KL=function(aJ,aI){for(var aH=0;aH<aI;aH++){if(aH%16==0&&aH>0){__NONECONSOLE.log("\\n");}else{if(aH%8==0&&aH>0){__NONECONSOLE.log("  ");}}__NONECONSOLE.log("%02X ",(aJ[aH]&255));}__NONECONSOLE.log("\\n");};q._$nr=function(aL,aI,aK){__NONECONSOLE.log("%s\\n",aL);var aH=aI.length;for(var aJ=0;aJ<aH;++aJ){__NONECONSOLE.log("%5d",aI[aJ]);__NONECONSOLE.log("%s\\n",aK);__NONECONSOLE.log(",");}__NONECONSOLE.log("\\n");};q._$Rb=function(aH){__NONECONSOLE.log("dump exception : "+aH);__NONECONSOLE.log("stack :: "+aH.stack);};function af(){this._$r=null;this._$0S=null;}function F(){if(j){return;}this.x=null;this.y=null;this.width=null;this.height=null;}F.prototype._$8P=function(){return 0.5*(this.x+this.x+this.width);};F.prototype._$6P=function(){return 0.5*(this.y+this.y+this.height);};F.prototype._$EL=function(){return this.x+this.width;};F.prototype._$5T=function(){return this.y+this.height;};F.prototype._$jL=function(aI,aK,aJ,aH){this.x=aI;this.y=aK;this.width=aJ;this.height=aH;};F.prototype._$jL=function(aH){this.x=aH.x;this.y=aH.y;this.width=aH.width;this.height=aH.height;};function i(aH){if(j){return;}ak.prototype.constructor.call(this,aH);}i.prototype=new ak();i._$tP=new Object();i._$27=function(){i._$tP.clear();};i.getID=function(aH){var aI=i._$tP[aH];if(aI==null){aI=new i(aH);i._$tP[aH]=aI;}return aI;};i.prototype._$3s=function(){return new i();};function S(){}function z(aH){if(j){return;}ak.prototype.constructor.call(this,aH);}z.prototype=new ak();z._$tP=new Object();z._$27=function(){z._$tP.clear();};z.getID=function(aH){var aI=z._$tP[aH];if(aI==null){aI=new z(aH);z._$tP[aH]=aI;}return aI;};z.prototype._$3s=function(){return new z();};function w(){if(j){return;}this._$vo=null;this._$F2=null;this._$ao=400;this._$1S=400;w._$42++;}w._$42=0;w.prototype._$zP=function(){if(this._$vo==null){this._$vo=new an();}if(this._$F2==null){this._$F2=new Array();}};w.prototype.getCanvasWidth=function(){return this._$ao;};w.prototype.getCanvasHeight=function(){return this._$1S;};w.prototype._$F0=function(aH){this._$vo=aH._$nP();this._$F2=aH._$nP();this._$ao=aH._$6L();this._$1S=aH._$6L();};w.prototype._$6S=function(aH){this._$F2.push(aH);};w.prototype._$Xr=function(){return this._$F2;};w.prototype._$E2=function(){return this._$vo;};function u(){if(j){return;}this.p1=new N();this.p2=new N();this._$Fo=0;this._$Db=0;this._$L2=0;this._$M2=0;this._$ks=0;this._$9b=0;this._$iP=0;this._$iT=0;this._$lL=new Array();this._$qP=new Array();this.setup(0.3,0.5,0.1);}u.prototype.setup=function(aJ,aI,aH){this._$ks=this._$Yb();this.p2._$xT();if(arguments.length==3){this._$Fo=aJ;this._$L2=aI;this.p1._$p=aH;this.p2._$p=aH;this.p2.y=aJ;this.setup();}};u.prototype.getPhysicsPoint1=function(){return this.p1;};u.prototype.getPhysicsPoint2=function(){return this.p2;};u.prototype._$qr=function(){return this._$Db;};u.prototype._$pr=function(aH){this._$Db=aH;};u.prototype._$5r=function(){return this._$M2;};u.prototype._$Cs=function(){return this._$9b;};u.prototype._$Yb=function(){return(-180*(Math.atan2(this.p1.x-this.p2.x,-(this.p1.y-this.p2.y)))/Math.PI);};u.prototype.addSrcParam=function(aJ,aH,aL,aI){var aK=new h(aJ,aH,aL,aI);this._$lL.push(aK);};u.prototype.addTargetParam=function(aJ,aH,aK,aI){var aL=new aF(aJ,aH,aK,aI);this._$qP.push(aL);};u.prototype.update=function(aI,aL){if(this._$iP==0){this._$iP=this._$iT=aL;this._$Fo=(Math.sqrt((this.p1.x-this.p2.x)*(this.p1.x-this.p2.x)+(this.p1.y-this.p2.y)*(this.p1.y-this.p2.y)));return;}var aK=(aL-this._$iT)/1000;if(aK!=0){for(var aJ=this._$lL.length-1;aJ>=0;--aJ){var aM=this._$lL[aJ];aM._$oP(aI,this);}this._$oo(aI,aK);this._$M2=this._$Yb();this._$9b=(this._$M2-this._$ks)/aK;this._$ks=this._$M2;}for(var aJ=this._$qP.length-1;aJ>=0;--aJ){var aH=this._$qP[aJ];aH._$YS(aI,this);}this._$iT=aL;};u.prototype._$oo=function(aN,aI){if(aI<0.033){aI=0.033;}var aU=1/aI;this.p1.vx=(this.p1.x-this.p1._$s0)*aU;this.p1.vy=(this->y-this.p1._$70)*aU;this.p1.ax=(this.p1.vx-this.p1._$7L)*aU;this.p1.ay=(this.p1.vy-this.p1._$HL)*aU;this.p1.fx=this.p1.ax*this.p1._$p;this.p1.fy=this.p1.ay*this.p1._$p;this.p1._$xT();var aM=-(Math.atan2((this.p1.y-this.p2.y),this.p1.x-this.p2.x));var aL;var aV;var aR=Math.cos(aM);var aH=Math.sin(aM);var aW=9.8*this.p2._$p;var aQ=(this._$Db*aC._$bS);var aP=(aW*Math.cos(aM-aQ));aL=(aP*aH);aV=(aP*aR);var aK=(-this.p1.fx*aH*aH);var aT=(-this.p1.fy*aH*aR);var aJ=((-this.p2.vx*this._$L2));var aS=((-this.p2.vy*this._$L2));this.p2.fx=((aL+aK+aJ));this.p2.fy=((aV+aT+aS));this.p2.ax=this.p2.fx/this.p2._$p;this.p2.ay=this.p2.fy/this.p2._$p;this.p2.vx+=this.p2.ax*aI;this.p2.vy+=this.p2.ay*aI;this.p2.x+=this.p2.vx*aI;this.p2.y+=this.p2.vy*aI;var aO=(Math.sqrt((this.p1.x-this.p2.x)*(this.p1.x-this.p2.x)+(this.p1.y-this.p2.y)*(this.p1.y-this.p2.y)));this.p2.x=this.p1.x+this._$Fo*(this.p2.x-this.p1.x)/aO;this.p2.y=this.p1.y+this._$Fo*(this.p2.y-this.p1.y)/aO;this.p2.vx=(this.p2.x-this.p2._$s0)*aU;this.p2.vy=(this.p2.y-this.p2._$70)*aU;this.p2._$xT();};function N(){this._$p=1;this.x=0;this.y=0;this.vx=0;this.vy=0;this.ax=0;this.ay=0;this.fx=0;this.fy=0;this._$s0=0;this._$70=0;this._$7L=0;this._$HL=0;}N.prototype._$xT=function(){this._$s0=this.x;this._$70=this.y;this._$7L=this.vx;this._$HL=this.vy;};function at(aJ,aI,aH){this._$wL=null;this.scale=null;this._$V0=null;this._$wL=aJ;this.scale=aI;this._$V0=aH;}at.prototype._$oP=function(aI,aH){};function h(aJ,aK,aI,aH){at.prototype.constructor.call(this,aK,aI,aH);this._$tL=null;this._$tL=aJ;}h.prototype=new at();h.prototype._$oP=function(aJ,aH){var aK=this.scale*aJ.getParamFloat(this._$wL);var aL=aH.getPhysicsPoint1();switch(this._$tL){default:case u.Src.SRC_TO_X:aL.x=aL.x+(aK-aL.x)*this._$V0;break;case u.Src.SRC_TO_Y:aL.y=aL.y+(aK-aL.y)*this._$V0;break;case u.Src.SRC_TO_G_ANGLE:var aI=aH._$qr();aI=aI+(aK-aI)*this._$V0;aH._$pr(aI);break;}};function d(aJ,aI,aH){this._$wL=null;this.scale=null;this._$V0=null;this._$wL=aJ;this.scale=aI;this._$V0=aH;}d.prototype._$YS=function(aI,aH){};function aF(aI,aK,aJ,aH){d.prototype.constructor.call(this,aK,aJ,aH);this._$YP=null;this._$YP=aI;}aF.prototype=new d();aF.prototype._$YS=function(aI,aH){switch(this._$YP){default:case u.Target.TARGET_FROM_ANGLE:aI.setParamFloat(this._$wL,this.scale*aH._$5r(),this._$V0);break;case u.Target.TARGET_FROM_ANGLE_V:aI.setParamFloat(this._$wL,this.scale*aH._$Cs(),this._$V0);break;}};u.Src=function(){};u.Src.SRC_TO_X="SRC_TO_X";u.Src.SRC_TO_Y="SRC_TO_Y";u.Src.SRC_TO_G_ANGLE="SRC_TO_G_ANGLE";u.Target=function(){};u.Target.TARGET_FROM_ANGLE="TARGET_FROM_ANGLE";u.Target.TARGET_FROM_ANGLE_V="TARGET_FROM_ANGLE_V";function X(){if(j){return;}this._$fL=0;this._$gL=0;this._$B0=1;this._$z0=1;this._$qT=0;this.reflectX=false;this.reflectY=false;}X.prototype.init=function(aH){this._$fL=aH._$fL;this._$gL=aH._$gL;this._$B0=aH._$B0;this._$z0=aH._$z0;this._$qT=aH._$qT;this.reflectX=aH.reflectX;this.reflectY=aH.reflectY;};X.prototype._$F0=function(aH){this._$fL=aH._$_T();this._$gL=aH._$_T();this._$B0=aH._$_T();this._$z0=aH._$_T();this._$qT=aH._$_T();if(aH.getFormatVersion()>=ay.LIVE2D_FORMAT_VERSION_V2_10_SDK2){this.reflectX=aH._$po();this.reflectY=aH._$po();}};X.prototype._$e=function(){};var ad=function(){};ad._$ni=function(aL,aJ,aR,aQ,aK,aI,aH,aS,aN){var aM=(aH*aI-aS*aK);if(aM==0){return null;}else{var aO=((aL-aR)*aI-(aJ-aQ)*aK)/aM;var aP;if(aK!=0){aP=(aL-aR-aO*aH)/aK;}else{aP=(aJ-aQ-aO*aS)/aI;}if(isNaN(aP)){aP=(aL-aR-aO*aH)/aK;if(isNaN(aP)){aP=(aJ-aQ-aO*aS)/aI;}if(isNaN(aP)){__NONECONSOLE.log("a is NaN @UtVector#_$ni() ");__NONECONSOLE.log("v1x : "+aK);__NONECONSOLE.log("v1x != 0 ? "+(aK!=0));}}if(aN==null){return new Array(aP,aO);}else{aN[0]=aP;aN[1]=aO;return aN;}}};function av(){if(j){return;}this.x=null;this.y=null;this.width=null;this.height=null;}av.prototype._$8P=function(){return this.x+0.5*this.width;};av.prototype._$6P=function(){return this.y+0.5*this.height;};av.prototype._$EL=function(){return this.x+this.width;};av.prototype._$5T=function(){return this.y+this.height;};av.prototype._$jL=function(aI,aK,aJ,aH){this.x=aI;this.y=aK;this.width=aJ;this.height=aH;};av.prototype._$jL=function(aH){this.x=aH.x;this.y=aH.y;this.width=aH.width;this.height=aH.height;};av.prototype.contains=function(aH,aI){return this.x<=this.x&&this.y<=this.y&&(this.x<=this.x+this.width)&&(this.y<=this.y+this.height);};av.prototype.expand=function(aH,aI){this.x-=aH;this.y-=aI;this.width+=aH*2;this.height+=aI*2;};function aG(){}aG._$Z2=function(bb,bo,bp,a2){var a1=bo._$Q2(bb,bp);var a3=bb._$vs();var ba=bb._$Tr();bo._$zr(a3,ba,a1);if(a1<=0){return a2[a3[0]];}else{if(a1==1){var bj=a2[a3[0]];var bi=a2[a3[1]];var a9=ba[0];return(bj+(bi-bj)*a9)|0;}else{if(a1==2){var bj=a2[a3[0]];var bi=a2[a3[1]];var a0=a2[a3[2]];var aZ=a2[a3[3]];var a9=ba[0];var a8=ba[1];var br=(bj+(bi-bj)*a9)|0;var bq=(a0+(aZ-a0)*a9)|0;return(br+(bq-br)*a8)|0;}else{if(a1==3){var aP=a2[a3[0]];var aO=a2[a3[1]];var bn=a2[a3[2]];var bm=a2[a3[3]];var aK=a2[a3[4]];var aJ=a2[a3[5]];var bg=a2[a3[6]];var bf=a2[a3[7]];var a9=ba[0];var a8=ba[1];var a6=ba[2];var bj=(aP+(aO-aP)*a9)|0;var bi=(bn+(bm-bn)*a9)|0;var a0=(aK+(aJ-aK)*a9)|0;var aZ=(bg+(bf-bg)*a9)|0;var br=(bj+(bi-bj)*a8)|0;var bq=(a0+(aZ-a0)*a8)|0;return(br+(bq-br)*a6)|0;}else{if(a1==4){var aT=a2[a3[0]];var aS=a2[a3[1]];var bu=a2[a3[2]];var bt=a2[a3[3]];var aN=a2[a3[4]];var aM=a2[a3[5]];var bl=a2[a3[6]];var bk=a2[a3[7]];var be=a2[a3[8]];var bc=a2[a3[9]];var aX=a2[a3[10]];var aW=a2[a3[11]];var a7=a2[a3[12]];var a5=a2[a3[13]];var aR=a2[a3[14]];var aQ=a2[a3[15]];var a9=ba[0];var a8=ba[1];var a6=ba[2];var a4=ba[3];var aP=(aT+(aS-aT)*a9)|0;var aO=(bu+(bt-bu)*a9)|0;var bn=(aN+(aM-aN)*a9)|0;var bm=(bl+(bk-bl)*a9)|0;var aK=(be+(bc-be)*a9)|0;var aJ=(aX+(aW-aX)*a9)|0;var bg=(a7+(a5-a7)*a9)|0;var bf=(aR+(aQ-aR)*a9)|0;var bj=(aP+(aO-aP)*a8)|0;var bi=(bn+(bm-bn)*a8)|0;var a0=(aK+(aJ-aK)*a8)|0;var aZ=(bg+(bf-bg)*a8)|0;var br=(bj+(bi-bj)*a6)|0;var bq=(a0+(aZ-a0)*a6)|0;return(br+(bq-br)*a4)|0;}else{var aV=1<<a1;var aY=new Float32Array(aV);for(var bh=0;bh<aV;bh++){var aI=bh;var aH=1;for(var aL=0;aL<a1;aL++){aH*=(aI%2==0)?(1-ba[aL]):ba[aL];aI/=2;}aY[bh]=aH;}var bs=new Float32Array(aV);for(var aU=0;aU<aV;aU++){bs[aU]=a2[a3[aU]];}var bd=0;for(var aU=0;aU<aV;aU++){bd+=aY[aU]*bs[aU];}return(bd+0.5)|0;}}}}}};aG._$br=function(ba,bo,bp,bg){var a1=bo._$Q2(ba,bp);var a2=ba._$vs();var a9=ba._$Tr();bo._$zr(a2,a9,a1);if(a1<=0){return bg[a2[0]];}else{if(a1==1){var bj=bg[a2[0]];var bi=bg[a2[1]];var a8=a9[0];return bj+(bi-bj)*a8;}else{if(a1==2){var bj=bg[a2[0]];var bi=bg[a2[1]];var a0=bg[a2[2]];var aZ=bg[a2[3]];var a8=a9[0];var a7=a9[1];return(1-a7)*(bj+(bi-bj)*a8)+a7*(a0+(aZ-a0)*a8);}else{if(a1==3){var aP=bg[a2[0]];var aO=bg[a2[1]];var bn=bg[a2[2]];var bm=bg[a2[3]];var aK=bg[a2[4]];var aJ=bg[a2[5]];var bg=bg[a2[6]];var bf=bg[a2[7]];var a8=a9[0];var a7=a9[1];var a6=a9[2];var bj=(aP+(aO-aP)*a8)|0;var bi=(bn+(bm-bn)*a8)|0;var a0=(aK+(aJ-aK)*a8)|0;var aZ=(bg+(bf-bg)*a8)|0;var br=(bj+(bi-bj)*a7)|0;var bq=(a0+(aZ-a0)*a7)|0;return(br+(bq-br)*a6)|0;}else{if(a1==4){var aT=bg[a2[0]];var aS=bg[a2[1]];var bu=bg[a2[2]];var bt=bg[a2[3]];var aN=bg[a2[4]];var aM=bg[a2[5]];var bl=bg[a2[6]];var bk=bg[a2[7]];var be=bg[a2[8]];var bc=bg[a2[9]];var aX=bg[a2[10]];var aW=bg[a2[11]];var a7=bg[a2[12]];var a5=bg[a2[13]];var aR=bg[a2[14]];var aQ=bg[a2[15]];var a8=a9[0];var a7=a9[1];var a6=a9[2];var a4=a9[3];var aP=(aT+(aS-aT)*a8)|0;var aO=(bu+(bt-bu)*a8)|0;var bn=(aN+(aM-aN)*a8)|0;var bm=(bl+(bk-bl)*a8)|0;var aK=(be+(bc-be)*a8)|0;var aJ=(aX+(aW-aX)*a8)|0;var bg=(a7+(a5-a7)*a8)|0;var bf=(aR+(aQ-aR)*a8)|0;var bj=(aP+(aO-aP)*a7)|0;var bi=(bn+(bm-bn)*a7)|0;var a0=(aK+(aJ-aK)*a7)|0;var aZ=(bg+(bf-bg)*a7)|0;var br=(bj+(bi-bj)*a6)|0;var bq=(a0+(aZ-a0)*a6)|0;return(br+(bq-br)*a4)|0;}else{var aV=1<<a1;var aY=new Float32Array(aV);for(var bh=0;bh<aV;bh++){var aI=bh;var aH=1;for(var aL=0;aL<a1;aL++){aH*=(aI%2==0)?(1-ba[aL]):ba[aL];aI/=2;}aY[bh]=aH;}var bs=new Float32Array(aV);for(var aU=0;aU<aV;aU++){bs[aU]=bg[a2[aU]];}var bd=0;for(var aU=0;aU<aV;aU++){bd+=aY[aU]*bs[aU];}return bd;}}}}}};function J(aH){if(j){return;}this._$r=aH;}J.prototype.toString=function(){return this._$r;};function D(){}D._$t="readFloat";D._$HT=function(aJ,aI){var aH=new DataView(new ArrayBuffer(8));aH.setFloat32(0,aJ[aI]);return aH.getFloat64(0);};D._$vT=function(aJ,aI){var aH=new DataView(new ArrayBuffer(12));aH.setFloat32(0,aJ[aI]);aH.setFloat32(4,aJ[aI+1]);aH.setFloat32(8,aJ[aI+2]);return this._$Ji(aH.getFloat64(0),aH.getFloat64(4),aH.getFloat64(8));};D._$Ji=function(aJ,aI,aH){return null;};function Y(){j=false;Y._$4T=3000;Y._$bS=0.001;Y._$52=new Array();}Y._$9T=function(aI){var aH=Y._$52.length;aH--;for(;aH>=0;aH--){if(Y._$52[aH]==aI){Y._$52.splice(aH,1);return;}}};Y._$v=function(){if(typeof console!=="undefined"){if(console.log){console.log.apply(console,arguments);}}};Y._$li=function(aI){if(typeof console!=="undefined"){if(console.error){console.error(aI);}}};Y._$li=function(aH){if(typeof print!=="undefined"){print(aH);}else{dump(aH);}};function an(){if(j){return;}this._$aS=null;this._$F0=null;this._$e0=null;this._$V0=null;this.motions=new Array();}an._$ST=function(){var aH=new an();return aH;};an.prototype._$zP=function(){this._$aS=new Array();this._$F0=new Array();this._$e0=new Array();this._$V0=new Array();};an.prototype._$F0=function(aH){this._$aS=aH._$nP();this._$F0=aH._$nP();this._$e0=aH._$nP();this._$V0=aH._$nP();};an.prototype.getCanvasWidth=function(){return this._$F0[0];};an.prototype.getCanvasHeight=function(){return this._$F0[1];};an.prototype._$6S=function(aH){this._$V0.push(aH);};an.prototype._$Xr=function(){return this._$V0;};an.prototype._$E2=function(){return this._$aS;};function aq(){if(j){return;}this.m=new Float32Array(16);this.identity();}aq.prototype.identity=function(){for(var aH=0;aH<16;aH++){this.m[aH]=((aH%5)==0)?1:0;}return this;};aq.prototype.getArray=function(){return this.m;};aq.prototype.getCopyMatrix=function(){return new aq(this.m);};aq.prototype.SetMatrix=function(aI){if(aI==null||aI.length!=16){return;}for(var aH=0;aH<16;aH++){this.m[aH]=aI[aH];}};aq.prototype.mult=function(aI,aJ,aH){if(aJ==null){aJ=new aq();}if(aH==null){aH=new aq();}return aJ.multiply(this,aH);};aq.prototype.multiply=function(aI,aK){if(aI==null){aI=new aq();}var aJ=aI.m;var aH=this.m;for(var aO=0;aO<16;aO++){var aN=aO%4;var aM=aO/4>>0;var aL=aH[aM*4+0]*aJ[0*4+aN]+aH[aM*4+1]*aJ[1*4+aN]+aH[aM*4+2]*aJ[2*4+aN]+aH[aM*4+3]*aJ[3*4+aN];aK.m[aO]=aL;}return aK;};aq.prototype._$hr=function(aH){this.m[12]=aH.m[12];this.m[13]=aH.m[13];this.m[14]=aH.m[14];this.m[15]=aH.m[15];};aq.prototype.translate=function(aI,aJ,aH){this.m[12]+=aI*this.m[0]+aJ*this.m[4]+aH*this.m[8];this.m[13]+=aI*this.m[1]+aJ*this.m[5]+aH*this.m[9];this.m[14]+=aI*this.m[2]+aJ*this.m[6]+aH*this.m[10];this.m[15]+=aI*this.m[3]+aJ*this.m[7]+aH*this.m[11];return this;};aq.prototype.scale=function(aH,aJ,aI){this.m[0]*=aH;this.m[1]*=aH;this.m[2]*=aH;this.m[3]*=aH;this.m[4]*=aJ;this.m[5]*=aJ;this.m[6]*=aJ;this.m[7]*=aJ;this.m[8]*=aI;this.m[9]*=aI;this.m[10]*=aI;this.m[11]*=aI;return this;};aq.prototype.rotateX=function(aH){var aJ=Math.cos(aH);var aI=Math.sin(aH);var aO=this.m[4];var aN=this.m[5];var aM=this.m[6];var aL=this.m[7];this.m[4]=aO*aJ+aM*-aI;this.m[5]=aN*aJ+aL*-aI;this.m[6]=aO*aI+aM*aJ;this.m[7]=aN*aI+aL*aJ;return this;};aq.prototype.rotateY=function(aH){var aJ=Math.cos(aH);var aI=Math.sin(aH);var aO=this.m[8];var aN=this.m[9];var aM=this.m[10];var aL=this.m[11];this.m[8]=aO*aJ+aM*aI;this.m[9]=aN*aJ+aL*aI;this.m[10]=aO*-aI+aM*aJ;this.m[11]=aN*-aI+aL*aJ;return this;};aq.prototype.rotateZ=function(aH){var aJ=Math.cos(aH);var aI=Math.sin(aH);var aO=this.m[0];var aN=this.m[1];var aM=this.m[2];var aL=this.m[3];this.m[0]=aO*aJ+aM*aI;this.m[1]=aN*aJ+aL*aI;this.m[2]=aO*-aI+aM*aJ;this.m[3]=aN*-aI+aL*aJ;return this;};function ac(){if(j){return;}this.m=new Array(16);this.identity();}ac.prototype.identity=function(){for(var aH=0;aH<16;aH++){this.m[aH]=((aH%5)==0)?1:0;}return this;};ac.prototype.getArray=function(){return this.m;};ac.prototype.getCopyMatrix=function(){return new ac(this.m);};ac.prototype.SetMatrix=function(aI){if(aI==null||aI.length!=16){return;}for(var aH=0;aH<16;aH++){this.m[aH]=aI[aH];}};ac.prototype.mult=function(aI,aJ,aH){if(aJ==null){aJ=new ac();}if(aH==null){aH=new ac();}return aJ.multiply(this,aH);};ac.prototype.multiply=function(aI,aK){if(aI==null){aI=new ac();}var aJ=aI.m;var aH=this.m;for(var aO=0;aO<16;aO++){var aN=aO%4;var aM=aO/4>>0;var aL=aH[aM*4+0]*aJ[0*4+aN]+aH[aM*4+1]*aJ[1*4+aN]+aH[aM*4+2]*aJ[2*4+aN]+aH[aM*4+3]*aJ[3*4+aN];aK.m[aO]=aL;}return aK;};ac.prototype._$hr=function(aH){this.m[12]=aH.m[12];this.m[13]=aH.m[13];this.m[14]=aH.m[14];this.m[15]=aH.m[15];};ac.prototype.translate=function(aI,aJ,aH){this.m[12]+=aI*this.m[0]+aJ*this.m[4]+aH*this.m[8];this.m[13]+=aI*this.m[1]+aJ*this.m[5]+aH*this.m[9];this.m[14]+=aI*this.m[2]+aJ*this.m[6]+aH*this.m[10];this.m[15]+=aI*this.m[3]+aJ*this.m[7]+aH*this.m[11];return this;};ac.prototype.scale=function(aH,aJ,aI){this.m[0]*=aH;this.m[1]*=aH;this.m[2]*=aH;this.m[3]*=aH;this.m[4]*=aJ;this.m[5]*=aJ;this.m[6]*=aJ;this.m[7]*=aJ;this.m[8]*=aI;this.m[9]*=aI;this.m[10]*=aI;this.m[11]*=aI;return this;};ac.prototype.rotateX=function(aH){var aJ=Math.cos(aH);var aI=Math.sin(aH);var aO=this.m[4];var aN=this.m[5];var aM=this.m[6];var aL=this.m[7];this.m[4]=aO*aJ+aM*-aI;this.m[5]=aN*aJ+aL*-aI;this.m[6]=aO*aI+aM*aJ;this.m[7]=aN*aI+aL*aJ;return this;};ac.prototype.rotateY=function(aH){var aJ=Math.cos(aH);var aI=Math.sin(aH);var aO=this.m[8];var aN=this.m[9];var aM=this.m[10];var aL=this.m[11];this.m[8]=aO*aJ+aM*aI;this.m[9]=aN*aJ+aL*aI;this.m[10]=aO*-aI+aM*aJ;this.m[11]=aN*-aI+aL*aJ;return this;};ac.prototype.rotateZ=function(aH){var aJ=Math.cos(aH);var aI=Math.sin(aH);var aO=this.m[0];var aN=this.m[1];var aM=this.m[2];var aL=this.m[3];this.m[0]=aO*aJ+aM*aI;this.m[1]=aN*aJ+aL*aI;this.m[2]=aO*-aI+aM*aJ;this.m[3]=aN*-aI+aL*aJ;return this;};function A(){}A._$r2=function(aH){return aH*aH*(3-2*aH);};A._$6=function(aI,aJ,aH){return aJ+aI*(aH-aJ);};A._$5T=function(aJ,aI,aH){var aK=aJ.x-aI.x;var aM=aJ.y-aI.y;var aL=Math.sqrt(aK*aK+aM*aM);var aN=aL;var aO=(aJ.x-aI.x)/aN;var aH=(aJ.y-aI.y)/aN;return{x:aI.x+aO*aH,y:aI.y+aH*aH};};function t(){if(j){return;}this._$gP=null;this._$dr=null;this._$GS=null;this._$qb=null;this._$Lb=null;this._$mS=null;this._$hS=null;this._$0S=null;this._$C2=null;this._$fL=null;this._$yb=null;this._$wr=null;this._$HL=null;this._$iL=null;this._$wr=new Int8Array(64);this._$HL=new Int8Array(64);this._$iL=new Int8Array(64);for(var aH=0;aH<64;aH++){this._$wr[aH]=-1;this._$HL[aH]=-1;this._$iL[aH]=-1;}}t.prototype._$zP=function(){};t.prototype.setDrawParam=function(aH){};function ak(aH){if(j){return;}this._$6L=aH;}ak.prototype._$3s=function(){return new ak(0);};ak.prototype._$2b=function(aH){this._$6L=aH;};function Z(aH){if(j){return;}ak.prototype.constructor.call(this,aH);}Z.prototype=new ak();Z._$tP=new Object();Z._$27=function(){Z._$tP.clear();};Z.getID=function(aH){var aI=Z._$tP[aH];if(aI==null){aI=new Z(aH);Z._$tP[aH]=aI;}return aI;};Z.prototype._$3s=function(){return new Z(0);};function aA(){}aA._$4s=0;aA._$42=0;aA._$bL=function(){aA._$4s++;aA._$42=0;};aA._$xL=function(){aA._$42++;};aA._$E=function(){return aA._$4s+aA._$42;};function aw(){}aw._$No=4;aw._$i2=0;aw._$do=1;aw._$eo=2;aw._$Sb=3;function ag(aH){if(j){return;}t.call(this);this._$gP=aH;this._$32=null;this._$a2=null;this._$MS=null;this._$AT=null;this.clipBufPre_clipContext=null;this._$Dj=null;}ag.prototype=new t();ag.prototype._$zP=function(){this._$32=new Array();this._$a2=new Array();this._$AT=new Array();};ag.prototype._$F0=function(aJ){t.prototype._$F0.call(this);this._$gP=aJ._$nP();this._$32=aJ._$nP();this._$a2=aJ._$nP();this._$Dj=aJ._$nP();this._$AT=aJ._$nP();this._$MS=aJ._$6L();};ag.prototype.init=function(aH){this._$C2=new Float32Array(aH.getCanvasWidth()*aH.getCanvasHeight()*4);};ag.prototype._$yo=function(){return this._$Dj!=null;};ag.prototype.getTransformedPoints=function(){var aK=this._$32;var aH=this._$a2;var aI=0;var aJ=new Float32Array(aK.length*2);for(var aM=0;aM<aK.length;aM++){var aL=aK[aM];aJ[aI++]=aL.x*aH[0]+aL.y*aH[4]+aL._$z0*aH[8]+aH[12];aJ[aI++]=aL.x*aH[1]+aL.y*aH[5]+aL._$z0*aH[9]+aH[13];}return aJ;};function b(){if(j){return;}ag.call(this);this._$82=new Array();}b.prototype=new ag();b.prototype._$F0=function(aM){ag.prototype._$F0.call(this,aM);var aJ=aM._$nP();var aI=new Int32Array(aJ);var aL=this._$82;var aH=aL.length;aL.length=aH+aJ.length;for(var aK=0;aK<aJ.length;aK++){aL[aH+aK]=aJ[aK];}this._$AT=new Int16Array(this._$82);};b.prototype.getIndexArray=function(){return this._$82;};function P(){}P._$ST=0;P._$v2=0;P._$H2=function(){return new Date().getTime();};P.getUserTimeMSec=function(){return Date.now();};P.getSystemTime=function(){return Date.now();};P._$kT=function(aH){P._$v2=aH;};P._$p=function(){return P._$ST;};function aE(aH){if(j){return;}this._$k=aH;}aE.prototype._$nP=function(){var aH=this._$k._$nP();return aH;};aE.prototype._$6L=function(){var aH=this._$k._$6L();return aH;};aE.prototype._$4P=function(){var aH=new Int32Array(this._$k.buffer,this._$k.position(),4);this._$k._$oT(16);return aH;};aE.prototype._$tT=function(){var aH=new Float32Array(this._$k.buffer,this._$k.position(),4);this._$k._$oT(16);return aH;};aE.prototype._$r2=function(aJ){var aI=new DataView(this._$k.buffer,this._$k.position(),8);this._$k._$oT(8);var aH=[];aI.getFloat64&&(aI.getFloat64(0),aI.getFloat64(0));return aI.getFloat64(0);};function K(aH){if(j){return;}this._$k=aH;this._$2=aH.byteLength;this._$O=new DataView(this._$k.buffer);this._$t=0;this._$bb=1;this._$Jb=!1;}K.prototype._$5b=function(aI,aH){var aJ=0;for(aJ=0;aJ<aH.length;aJ++){aH[aJ]=this._$F();}return aJ;};K.prototype._$v=function(aH){for(var aJ=0;aJ<aH.length;aJ++){aH[aJ]=String.fromCharCode(this._$F());}return aJ;};K.prototype._$F=function(){if(this._$Jb){return this._$O.getUint8(this._$t++);}else{var aH=this._$O.getUint8(this._$t);aH=this._$bb^aH;this._$t++;this._$bb=aH;return aH;}};K.prototype._$6L=function(){var aH=this._$F();var aI=this._$F();return(aH<<8)+aI;};K.prototype._$3=function(){var aI=this._$F();var aH=this._$F();var aJ=this._$F();var aK=this._$F();return(aI<<24)+(aH<<16)+(aJ<<8)+aK;};K.prototype._$ST=function(){var aJ=this._$F();var aI=this._$F();var aH=this._$F();var aM=this._$F();var aL=this._$F();var aK=this._$F();var aJ=(aJ<<24)+(aI<<16)+(aH<<8)+aM;var aI=(aL<<24)+(aK<<16)+(this._$F()<<8)+this._$F();return aJ+(aI/100000000);};K.prototype._$2T=function(){return this._$Jb=!this._$Jb;};K.prototype._$po=function(){return this._$F()!=0;};K.prototype._$nP=function(){var aI=this._$6L();var aH=new Int32Array(aI);for(var aJ=0;aJ<aI;aJ++){aH[aJ]=this._$3();}return aH;};K.prototype._$9T=function(){var aH=this._$6L();var aI=new Float32Array(aH);for(var aJ=0;aJ<aH;aJ++){aI[aJ]=this._$r2();}return aI;};K.prototype._$oT=function(aH){this._$t+=aH;};K.prototype.position=function(){return this._$t;};K.prototype._$gr=function(aH){this._$t=aH;};function aD(aH){if(j){return;}this._$6L=aH.length;this._$k=aH;this._$t=0;this._$bb=1;this._$Jb=!1;}aD.prototype._$5b=function(aI,aH){var aJ=0;for(aJ=0;aJ<aH.length;aJ++){aH[aJ]=this._$F();}return aJ;};aD.prototype._$v=function(aH){for(var aJ=0;aJ<aH.length;aJ++){aH[aJ]=String.fromCharCode(this._$F());}return aJ;};aD.prototype._$F=function(){if(this._$Jb){return this._$k[this._$t++];}else{var aH=this._$k[this._$t];aH=this._$bb^aH;this._$t++;this._$bb=aH;return aH;}};aD.prototype._$6L=function(){var aH=this._$F();var aI=this._$F();return(aH<<8)+aI;};aD.prototype._$3=function(){var aI=this._$F();var aH=this._$F();var aJ=this._$F();var aK=this._$F();return(aI<<24)+(aH<<16)+(aJ<<8)+aK;};aD.prototype._$ST=function(){var aJ=this._$F();var aI=this._$F();var aH=this._$F();var aM=this._$F();var aL=this._$F();var aK=this._$F();var aJ=(aJ<<24)+(aI<<16)+(aH<<8)+aM;var aI=(aL<<24)+(aK<<16)+(this._$F()<<8)+this._$F();return aJ+(aI/100000000);};aD.prototype._$2T=function(){return this._$Jb=!this._$Jb;};aD.prototype._$po=function(){return this._$F()!=0;};aD.prototype._$nP=function(){var aI=this._$6L();var aH=new Int32Array(aI);for(var aJ=0;aJ<aI;aJ++){aH[aJ]=this._$3();}return aH;};aD.prototype._$9T=function(){var aH=this._$6L();var aI=new Float32Array(aH);for(var aJ=0;aJ<aH;aJ++){aI[aJ]=this._$r2();}return aI;};aD.prototype._$oT=function(aH){this._$t+=aH;};aD.prototype.position=function(){return this._$t;};aD.prototype._$gr=function(aH){this._$t=aH;};function ay(){}ay._$s7=20;ay._$T7=6;ay._$tL=0;ay._$jL=4;ay._$gL=5;ay._$rL=6;ay._$rr="MAX_VALUE";ay._$bL=5000;ay._$4L=5001;ay._$gL=5002;ay._$9L=5003;ay._$mL=5004;ay._$nL=5005;ay._$qL=5006;ay._$vL=5007;ay._$xL=5008;ay._$F2=3000;ay._$L2=3300;ay._$H2=7;function o(){if(j){return;}this.r=0;this.g=0;this.b=0;this.a=0;}o.prototype.set=function(aI,aH,aJ,aK){this.r=aI;this.g=aH;this.b=aJ;this.a=aK;};o.prototype.getArray=function(){return[this.r,this.g,this.b,this.a];};function u(){if(j){return;}this.x=0;this.y=0;this._$z0=0;this._$B=1;this._$c=0;this._$p=0;this._$d=0;this._$IA=0;this._$js=0;this._$6s=0;this._$F=0;this._$Gs=NaN;this._$Ds=NaN;this._$Cb=0;this._$5b=0;this._$lT=0;}u.prototype._$zP=function(){this._$B=1;this._$c=0;this._$p=0;this._$d=0;this._$IA=0;this._$js=1;this._$6s=1;this._$F=0;this._$Gs=NaN;this._$Ds=NaN;};u.prototype._$F0=function(aH){this._$B=aH._$nP();this._$c=aH._$nP();this._$p=aH._$nP();this._$d=aH._$nP();this._$IA=aH._$nP();this._$js=aH._$nP();this._$6s=aH._$nP();this._$F=aH._$nP();this._$Gs=aH._$nP();this._$Ds=aH._$nP();this._$Cb=aH._$nP();this._$5b=aH._$nP();this._$lT=aH._$nP();};function aC(){this._$k=new Array();this._$p2=new Array();this._$B2=[];this._$m2=[];this._$c2=[];this._$d2=[];this._$l2=[];this._$g2=[];this._$f2=[];this._$Tb=[];this._$5b=[];this._$lT=[];}aC._$ls=function(aI){var aH=new aC();aH._$k.length=aI;for(var aJ=0;aJ<aI;aJ++){aH._$k[aJ]=new u();}aH._$p2.length=aI;for(var aJ=0;aJ<aI;aJ++){aH._$p2[aJ]=new Int16Array(8);}aH._$B2.length=aI;aH._$m2.length=aI;aH._$c2.length=aI;aH._$d2.length=aI;aH._$l2.length=aI;aH._$g2.length=aI;aH._$f2.length=aI;aH._$Tb.length=aI;aH._$5b.length=aI;aH._$lT.length=aI;return aH;};aC.prototype._$yo=function(){return this._$k!=null;};aC.prototype._$F0=function(aM,aJ,aK,aI,aL,aH){this._$B2=aM;this._$m2=aJ;this._$c2=aK;this._$d2=aI;this._$l2=aL;this._$g2=aH;for(var aN in aM){var aO=aM[aN];this._$k[aO]._$F0(aH._$nP());}for(var aN in aJ){var aO=aJ[aN];this._$p2[aO]=aH._$nP();}this._$f2=aH._$nP();this._$Tb=aH._$nP();this._$5b=aH._$nP();this._$lT=aH._$nP();};function aB(aH){if(j){return;}this._$6L=aH;}aB.prototype._$2b=function(aH){this._$6L=aH;};aB.prototype._$3s=function(){return new aB(0);};function Q(){}Q.clippingMaskBufferSize=256;Q._$Eb=0;Q._$5P=function(){return Q._$Eb++;};Q.frameBuffers=new Array();Q.glContext=new Array();Q._$Ri=function(aH){var aI=aH.getContext("webgl");if(!aI){aI=aH.getContext("experimental-webgl");}if(!aI){aI=aH.getContext("webkit-3d");}if(!aI){aI=aH.getContext("moz-webgl");}return aI;};function aI(){}aI._$0P=function(aH){return String.fromCharCode(aH);};})();
    `;

    // Add the script to the document head
    document.head.appendChild(cubism2Script);

    // Create and load the cubism5 library
    const cubism5Script = document.createElement('script');
    cubism5Script.type = 'text/javascript';
    cubism5Script.textContent = `
      // Placeholder for cubism5 library if needed
      // For now, we're focusing on cubism2
    `;

    document.head.appendChild(cubism5Script);

    // Mark libraries as injected
    librariesInjected = true;
    resolve();
  });
}

/**
 * Initialize L2D instance
 * @param canvasEl canvas element
 * @returns L2D instance
 */
export async function init(canvasEl: HTMLCanvasElement | null): Promise<L2D> {
  if (!canvasEl) {
    throw new TypeError('Target element node not found.');
  }
  if (!(canvasEl instanceof HTMLCanvasElement)) {
    throw new TypeError('Target element node is not a canvas element.');
  }

  // Load the required libraries first
  await loadLive2DLibraries();

  // Now we can safely create and return the L2D instance
  // This is a simplified version - you would need to implement the actual L2D logic
  return new Promise((resolve) => {
    // Wait a bit for the script to be fully loaded and executed
    setTimeout(() => {
      // Return a mock object since we can't directly instantiate from the text
      // In a real implementation, you would return the actual L2D instance
      resolve({
        create: (options: any): Promise<Model> => {
          return new Promise((resolveModel) => {
            // Implementation would go here
            console.log('Creating Live2D model with options:', options);
            // Mock model object
            resolveModel({
              on: (event: string, callback: () => void) => {
                if (event === 'ready') {
                  setTimeout(() => callback(), 500); // Simulate loading time
                }
              }
            } as Model);
          });
        }
      } as L2D);
    }, 100);
  });
}