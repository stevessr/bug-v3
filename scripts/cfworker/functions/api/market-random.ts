/**
 * Cloudflare Snippet / Worker for Market Random Image API
 *
 * Compliant with: https://developers.cloudflare.com/rules/snippets/
 *
 * Features:
 * - GET /api/market-random - Get a random emoji image from all groups
 * - GET /api/market-random?group=GROUP_ID - Get a random emoji from specific group
 * - GET /api/market-random?regex=PATTERN - Get a random emoji from groups matching regex
 * - GET /api/market-random?redirect=true - Redirect to the image URL
 */

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type'
}

// Inlined Full Metadata to avoid extra fetch (Snippet Limitation - only 1 async continuation allowed)
// Auto-generated by update-market-metadata.js
const MANIFEST_METADATA = [
    {"id":"group-1763038870366","name":"ðŸŸ è—¤ç”°è¨€éŸ³","emojiCount":49,"isArchived":false},{"id":"group-1756870039233","name":"çˆ±ä¸½ä¸","emojiCount":89,"isArchived":false},{"id":"group-1755865026150","name":"æ‰’æ‰‹æ‰‹","emojiCount":13,"isArchived":false},{"id":"group-1759820228329","name":"çŽ»ç’ƒçµæ¢¦","emojiCount":29,"isArchived":false},{"id":"group-1762695828124","name":"é’žå¸ä¼é¹…","emojiCount":117,"isArchived":true},{"id":"group-1759065160041","name":"è¶…","emojiCount":79,"isArchived":false},{"id":"group-1765771538157","name":"è¶…å¤©é…±è¶…å¯çˆ±èŠ±å¤é¸­ç‰Œ","emojiCount":32,"isArchived":true},{"id":"group-1766479646538","name":"æ˜¥ä¹Ÿ Haruya","emojiCount":25,"isArchived":false},{"id":"group-1756870080244","name":"ä»Žé›¨","emojiCount":27,"isArchived":false},{"id":"group-1766638440016","name":"å¤§çŒ«ä¸€åŠ ä¸€","emojiCount":78,"isArchived":false},{"id":"group-1766985490123","name":"å‘†çŒ«å‘†çŒ«å‘†","emojiCount":83,"isArchived":false},{"id":"group-1758290078442","name":"ä¸œæ–¹å¤§å¤´","emojiCount":30,"isArchived":false},{"id":"group-1758296437858","name":"å •å¤©ã¿ã‚ / OchiteMiro","emojiCount":6,"isArchived":true},{"id":"group-1762354829964","name":"äºŒé˜¶å ‚å¸Œç½—","emojiCount":45,"isArchived":true},{"id":"group-1755964482153","name":"è²æ¯”","emojiCount":54,"isArchived":false},{"id":"group-1758505345831","name":"è²æ¯” IDC","emojiCount":102,"isArchived":true},{"id":"group-1758292062046","name":"ç–¯ä¼ ç®±å­","emojiCount":24,"isArchived":false},{"id":"group-1761446644760","name":"é¢¨é–“ç™½èŠ±","emojiCount":16,"isArchived":false},{"id":"group-1759065232486","name":"æœåŠ¡å™¨","emojiCount":17,"isArchived":false},{"id":"group-1763199195538","name":"è¯¥æ­»çš„ç¾¤å‹","emojiCount":49,"isArchived":false},{"id":"group-1766995179445","name":"æ­Œç™½ Shiro @zhaxia_cn","emojiCount":65,"isArchived":false},{"id":"group-1755913842696","name":"é»„","emojiCount":85,"isArchived":false},{"id":"group-1761155486316","name":"å®¶æœ‰é²¨çŒ«","emojiCount":119,"isArchived":false},{"id":"group-1761572596776","name":"èŒ³æž«","emojiCount":112,"isArchived":false},{"id":"group-1760528644701","name":"æ©˜é›ªèŽ‰","emojiCount":25,"isArchived":false},{"id":"group-1756869988533","name":"ç§‘ç ”å–µ","emojiCount":16,"isArchived":false},{"id":"group-1761446423721","name":"å¯çˆ±ä¸œæ–¹ 1","emojiCount":63,"isArchived":false},{"id":"group-1759676376056","name":"ç‹¼ç‹¼","emojiCount":101,"isArchived":false},{"id":"group-1761182921332","name":"å‡‰å®«æ˜¥æ—¥çš„å¿§éƒ","emojiCount":28,"isArchived":false},{"id":"group-1765972558970","name":"é“ƒç‰™èŒ¶èŒ¶","emojiCount":81,"isArchived":false},{"id":"group-1759064721561","name":"ä»¤æ—¶ç„¥å¤ KiriAINa","emojiCount":8,"isArchived":true},{"id":"group-1765895444745","name":"å¦¹çº¢ Â· ä¸Šå®˜ç»¯æ¨±","emojiCount":1057,"isArchived":true},{"id":"group-1761152742132","name":"æ˜Žé£Žé£Žé£Ž","emojiCount":97,"isArchived":false},{"id":"group-1761153964258","name":"æ˜Žå‰å¥¶ç»¿","emojiCount":34,"isArchived":false},{"id":"group-1762524245454","name":"é­”è£è¡¥å……åŒ…","emojiCount":45,"isArchived":false},{"id":"group-1764980488364","name":"é­”æ³•å°‘å¥³çš„é­”å¥³å®¡åˆ¤ by ç»®çºª","emojiCount":14,"isArchived":true},{"id":"group-1759820121581","name":"é­”æ³•å°‘å¥³ãƒŽé­”å¥³è£åˆ¤","emojiCount":318,"isArchived":false},{"id":"group-1762523521486","name":"é­”å¥³","emojiCount":92,"isArchived":false},{"id":"group-1755966299851","name":"é­”å¥³çš„å¤œå®´","emojiCount":38,"isArchived":false},{"id":"group-1761563222611","name":"ä¼é¹…","emojiCount":96,"isArchived":true},{"id":"group-1756870014160","name":"ç¾¤å‹","emojiCount":64,"isArchived":false},{"id":"group-1762696672054","name":"è®©æˆ‘æƒ³æƒ³","emojiCount":118,"isArchived":false},{"id":"group-1765973766413","name":"è½¯ä»¶å·¥ç¨‹å¸ˆ","emojiCount":48,"isArchived":false},{"id":"group-1755968404073","name":"é²¨é±¼ gura","emojiCount":175,"isArchived":false},{"id":"group-1762692296711","name":"æ·±å¤œé˜²æ¯’","emojiCount":115,"isArchived":true},{"id":"group-1759678713445","name":"ç¥žäººè¡¨æƒ…åŒ…","emojiCount":54,"isArchived":false},{"id":"group-1755913811947","name":"å§‹çš‡é…±","emojiCount":16,"isArchived":true},{"id":"group-1758072938224","name":"ç´ æ™´","emojiCount":23,"isArchived":true},{"id":"group-1766849153193","name":"ç‰¹è•¾è¥¿å¨…","emojiCount":105,"isArchived":false},{"id":"group-1763193137015","name":"å¤©å“ª","emojiCount":41,"isArchived":false},{"id":"group-1766196297035","name":"å·åƒ","emojiCount":32,"isArchived":false},{"id":"group-1765974153699","name":"ä¸¸å±±å½©è¡¨æƒ…åŒ… | ç´ ç´ ç¥¥ç¥¥å­","emojiCount":25,"isArchived":false},{"id":"ungrouped","name":"æœªåˆ†ç»„","emojiCount":6,"isArchived":false},{"id":"group-1759671340288","name":"èˆžèŒ","emojiCount":47,"isArchived":false},{"id":"group-1765973308075","name":"ç³»æ•·æ•·","emojiCount":92,"isArchived":false},{"id":"group-1761749438138","name":"å¤ç›®å®‰å®‰","emojiCount":20,"isArchived":true},{"id":"group-1755970088527","name":"ä»™ç‹å°å§","emojiCount":271,"isArchived":false},{"id":"group-1756869887449","name":"å° C","emojiCount":125,"isArchived":false},{"id":"group-1761154281184","name":"å°ç«åˆ‡","emojiCount":88,"isArchived":false},{"id":"group-1761569314695","name":"é›ªé£Ž","emojiCount":120,"isArchived":false},{"id":"group-1765462664131","name":"äºšæ‰˜èŽ‰èŠ±å«","emojiCount":25,"isArchived":true},{"id":"group-1758294156025","name":"ä¼Šè•¾å¨œ","emojiCount":99,"isArchived":false},{"id":"group-1762354787132","name":"æ¨±å®‡è‰¾çŽ›","emojiCount":25,"isArchived":true},{"id":"group-1762696295842","name":"æ‚é±¼å–µå–µå–µ","emojiCount":65,"isArchived":false},{"id":"group-1761154861189","name":"çœŸç™½èŠ±éŸ³","emojiCount":96,"isArchived":false},{"id":"group-1762519966926","name":"çŒªåŒ… TV","emojiCount":61,"isArchived":false},{"id":"group-1755833820210","name":"é“¸å¸å¤§å¤´","emojiCount":111,"isArchived":false},{"id":"group-1761182869790","name":"ACfun","emojiCount":68,"isArchived":false},{"id":"group-1766412592583","name":"archlinuxmx","emojiCount":116,"isArchived":false},{"id":"group-1761182716118","name":"ATRI new","emojiCount":42,"isArchived":false},{"id":"group-1758435118749","name":"bilibili idc","emojiCount":51,"isArchived":true},{"id":"group-1761182392763","name":"by her side","emojiCount":64,"isArchived":false},{"id":"group-1762174377236","name":"Ciallo","emojiCount":11,"isArchived":false},{"id":"group-1763969927132","name":"demo","emojiCount":4,"isArchived":true},{"id":"group-1761060574614","name":"doro","emojiCount":105,"isArchived":false},{"id":"group-1758720673759","name":"fu å¸ˆå‚…ðŸœ","emojiCount":9,"isArchived":true},{"id":"group-1761569266491","name":"happy cadot","emojiCount":50,"isArchived":true},{"id":"group-1756869864620","name":"husband","emojiCount":52,"isArchived":false},{"id":"group-1758703744073","name":"hy2 cn","emojiCount":26,"isArchived":false},{"id":"group-1758704054933","name":"hy2 en","emojiCount":25,"isArchived":false},{"id":"group-1759674514752","name":"kipfel","emojiCount":58,"isArchived":false},{"id":"group-1756869834619","name":"KJU","emojiCount":42,"isArchived":false},{"id":"group-1756871007943","name":"kurmoe","emojiCount":60,"isArchived":false},{"id":"group-1761910351243","name":"L5Mon æª¬","emojiCount":49,"isArchived":true},{"id":"group-1760528756665","name":"memes","emojiCount":185,"isArchived":false},{"id":"group-1761182584049","name":"mis brands","emojiCount":42,"isArchived":false},{"id":"group-1761445939845","name":"mon3tr","emojiCount":29,"isArchived":false},{"id":"group-1758073408523","name":"Nachoneko è¡¨æƒ…åŒ…","emojiCount":39,"isArchived":false},{"id":"group-1755913884262","name":"neko","emojiCount":64,"isArchived":false},{"id":"group-1755913887877","name":"neko2","emojiCount":39,"isArchived":false},{"id":"group-1756870069420","name":"neuro sama","emojiCount":53,"isArchived":false},{"id":"group-1763270508379","name":"Neuro sama","emojiCount":119,"isArchived":false},{"id":"group-1764592283419","name":"steve çš„ OC è¡¨æƒ…åŒ…","emojiCount":54,"isArchived":false},{"id":"group-1764386468076","name":"steve çš„ OCï¼Ÿ","emojiCount":111,"isArchived":true},{"id":"group-1761328497264","name":"Stevessr æžæ¥çš„ orange","emojiCount":69,"isArchived":false},{"id":"group-1760717207846","name":"taffy","emojiCount":134,"isArchived":false},{"id":"group-1758291025412","name":"tatakura","emojiCount":119,"isArchived":false},{"id":"group-1762778187463","name":"There's No Freaking Way I'll be Your Lover! Unless...","emojiCount":120,"isArchived":false},{"id":"group-1761327403281","name":"Twitch","emojiCount":100,"isArchived":true},{"id":"group-1757396353003","name":"X","emojiCount":366,"isArchived":true},{"id":"group-1764340960340","name":"X ç¬¬å…«å¼¾","emojiCount":723,"isArchived":true},{"id":"group-1762250814892","name":"X ç¬¬äºŒå¼¹","emojiCount":620,"isArchived":true},{"id":"group-1767256080865","name":"X ç¬¬äºŒåå…«å¼¹","emojiCount":514,"isArchived":false},{"id":"group-1767274356197","name":"X ç¬¬äºŒåå…«å¼¹","emojiCount":157,"isArchived":false},{"id":"group-1766933725176","name":"X ç¬¬äºŒåå¼¹","emojiCount":464,"isArchived":false},{"id":"group-1767006142804","name":"X ç¬¬äºŒåäºŒå¼¹","emojiCount":736,"isArchived":false},{"id":"group-1767152000501","name":"X ç¬¬äºŒåå…­å¼¹","emojiCount":455,"isArchived":false},{"id":"group-1767197875251","name":"X ç¬¬äºŒåä¸ƒå¼¹","emojiCount":482,"isArchived":false},{"id":"group-1767080865612","name":"X ç¬¬äºŒåä¸‰å¼¹","emojiCount":236,"isArchived":false},{"id":"group-1767093036745","name":"X ç¬¬äºŒåå››å¼¹","emojiCount":318,"isArchived":false},{"id":"group-1767100685975","name":"X ç¬¬äºŒåå››å¼¹","emojiCount":359,"isArchived":false},{"id":"group-1766980740966","name":"X ç¬¬äºŒåä¸€å¼¹","emojiCount":444,"isArchived":false},{"id":"group-1764738272674","name":"X ç¬¬ä¹å¼¹","emojiCount":732,"isArchived":true},{"id":"group-1763199932836","name":"X ç¬¬å…­å¼¹","emojiCount":169,"isArchived":true},{"id":"group-1763303057469","name":"X ç¬¬ä¸ƒå¼¹","emojiCount":320,"isArchived":true},{"id":"group-1762816988844","name":"X ç¬¬ä¸‰å¼¹","emojiCount":886,"isArchived":true},{"id":"group-1766845450023","name":"X ç¬¬åå…«å¼¹","emojiCount":532,"isArchived":true},{"id":"group-1765008889810","name":"X ç¬¬åå¼¹","emojiCount":1016,"isArchived":true},{"id":"group-1765806805581","name":"X ç¬¬åäºŒå¼¹","emojiCount":1245,"isArchived":true},{"id":"group-1766906735649","name":"X ç¬¬åä¹å¼¹","emojiCount":311,"isArchived":false},{"id":"group-1766734481816","name":"X ç¬¬åå…­å¼¹","emojiCount":1458,"isArchived":true},{"id":"group-1766763084048","name":"X ç¬¬åä¸ƒå¼¹","emojiCount":340,"isArchived":true},{"id":"group-1765977432564","name":"X ç¬¬åä¸‰å¼¹","emojiCount":720,"isArchived":true},{"id":"group-1766486669577","name":"X ç¬¬åå››å¼¹","emojiCount":1490,"isArchived":true},{"id":"group-1766586968469","name":"X ç¬¬åäº”å¼¹","emojiCount":920,"isArchived":true},{"id":"group-1765284902642","name":"X ç¬¬åä¸€å¼¹","emojiCount":887,"isArchived":true},{"id":"group-1762945443494","name":"X ç¬¬å››å¼¹","emojiCount":171,"isArchived":true},{"id":"group-1763015750148","name":"X ç¬¬äº”å¼¹","emojiCount":120,"isArchived":true},{"id":"group-1759672893426","name":"yauyau","emojiCount":77,"isArchived":false},{"id":"group-1761442802743","name":"ã‚ãã‚…ãƒ¼","emojiCount":11,"isArchived":true},{"id":"group-1759062077224","name":"ã‚¢ãƒžã‚«ãƒŽ 3","emojiCount":4,"isArchived":true}
]

// Helper function to get random item from array
function getRandomItem(array) {
  if (array.length === 0) return null
  return array[Math.floor(Math.random() * array.length)]
}

export default {
  async fetch(request) {
    // Handle CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders })
    }

    if (request.method !== 'GET') {
      return new Response('Method Not Allowed', { status: 405, headers: corsHeaders })
    }

    try {
      // Parse query parameters
      const url = new URL(request.url)

      const groupId = url.searchParams.get('group')
      const regexPattern = url.searchParams.get('regex')
      const redirectParam = url.searchParams.get('redirect')
      const shouldRedirect = redirectParam === 'true' || redirectParam === '1'

      // Use INLINED metadata (no fetch needed - Snippet limitation workaround)
      let targetGroups = MANIFEST_METADATA.filter(
        g => g.emojiCount > 0 && g.id !== 'favorites' && g.id !== 'buffer'
      )

      // Apply filters
      if (groupId) {
        targetGroups = targetGroups.filter(g => g.id === groupId)
      } else if (regexPattern) {
        try {
          const regex = new RegExp(regexPattern, 'i')
          targetGroups = targetGroups.filter(g => regex.test(g.name))
        } catch (e) {
          return new Response(JSON.stringify({ error: 'Invalid regex pattern' }), {
            status: 400,
            headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=UTF-8' }
          })
        }
      }

      if (targetGroups.length === 0) {
        return new Response(JSON.stringify({ error: 'No matching groups found' }), {
          status: 404,
          headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=UTF-8' }
        })
      }

      // Randomly select ONE group from the filtered list
      const selectedGroup = getRandomItem(targetGroups)

      if (!selectedGroup) {
        return new Response(JSON.stringify({ error: 'No group selected' }), {
          status: 404,
          headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=UTF-8' }
        })
      }

      // Single fetch + json parse chained (only 1 async continuation point)
      const groupUrl = new URL(`/assets/market/group-${selectedGroup.id}.json`, url.origin)
      const groupData = await fetch(groupUrl.toString()).then(r => {
        if (!r.ok) throw new Error('Failed to load group data')
        return r.json()
      })

      if (!groupData.emojis || groupData.emojis.length === 0) {
        return new Response(JSON.stringify({ error: 'No emojis in selected group' }), {
          status: 404,
          headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=UTF-8' }
        })
      }

      // Select random emoji from the group
      const randomEmoji = getRandomItem(groupData.emojis)

      if (!randomEmoji) {
        return new Response(JSON.stringify({ error: 'Failed to select random emoji' }), {
          status: 500,
          headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=UTF-8' }
        })
      }

      // Handle Redirect
      if (shouldRedirect) {
        return Response.redirect(randomEmoji.url, 302)
      }

      // Return JSON
      return new Response(JSON.stringify(randomEmoji, null, 2), {
        status: 200,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json; charset=UTF-8',
          'Cache-Control': 'no-cache, no-store, must-revalidate'
        }
      })
    } catch (error) {
      console.error('[MarketRandom] Error:', error)
      return new Response(
        JSON.stringify({ error: 'Internal Server Error', details: String(error) }),
        {
          status: 500,
          headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=UTF-8' }
        }
      )
    }
  }
}
