<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manual Test - Upload & Injection</title>
    <script type="module" src="/src/utils/theme.ts"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 20px;
        line-height: 1.6;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .toolbar-test {
        border: 1px solid #ccc;
        padding: 10px;
        background: white;
        border-radius: 4px;
        margin: 10px 0;
      }
      .d-editor-button-bar {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      .chat-composer__inner-container {
        display: flex;
        gap: 5px;
        align-items: center;
        padding: 10px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 8px;
      }
      .d-editor-input {
        width: 100%;
        height: 100px;
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .btn {
        background: #007cff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
      }
      .btn:hover {
        background: #0056cc;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª Manual Test Page - Image Upload & Injection</h1>

    <div class="status info">
      <strong>è¯´æ˜ï¼š</strong>
      è¿™ä¸ªé¡µé¢ç”¨äºæ‰‹åŠ¨æµ‹è¯•å›¾ç‰‡ä¸Šä¼ å’ŒæŒ‰é’®æ³¨å…¥åŠŸèƒ½ã€‚åœ¨å®é™…çš„linux.doç½‘ç«™ä¸Šï¼Œè¿™äº›åŠŸèƒ½ä¼šè‡ªåŠ¨æ³¨å…¥åˆ°ç›¸åº”çš„å·¥å…·æ ä¸­ã€‚
    </div>

    <div class="test-section">
      <h2>1. æ ‡å‡†ç¼–è¾‘å™¨å·¥å…·æ æµ‹è¯•</h2>
      <p>æ¨¡æ‹Ÿ linux.do æ ‡å‡†ç¼–è¾‘å™¨çš„å·¥å…·æ ç¯å¢ƒ</p>
      <div class="toolbar-test">
        <div class="d-editor-button-bar" role="toolbar">
          <button class="btn">B</button>
          <button class="btn">I</button>
          <button class="btn">ğŸ”—</button>
          <!-- æ³¨å…¥çš„æŒ‰é’®ä¼šå‡ºç°åœ¨è¿™é‡Œ -->
        </div>
      </div>
      <textarea class="d-editor-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥å†…å®¹..."></textarea>
    </div>

    <div class="test-section">
      <h2>2. èŠå¤©ç¼–è¾‘å™¨å·¥å…·æ æµ‹è¯•</h2>
      <p>æ¨¡æ‹Ÿ linux.do èŠå¤©ç¼–è¾‘å™¨çš„å·¥å…·æ ç¯å¢ƒ</p>
      <div class="toolbar-test">
        <div class="chat-composer__inner-container">
          <button class="btn">+</button>
          <textarea
            style="flex: 1; height: 40px; border: 1px solid #ddd; border-radius: 4px; padding: 8px"
            placeholder="ä¸ discobot èŠå¤©"
          ></textarea>
          <button class="btn">ğŸ˜Š</button>
          <!-- æ³¨å…¥çš„æŒ‰é’®ä¼šå‡ºç°åœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2>3. æ‰‹åŠ¨åŠŸèƒ½æµ‹è¯•</h2>
      <div style="display: flex; gap: 10px; flex-wrap: wrap">
        <button class="btn" id="testUpload">ğŸ“· æµ‹è¯•å›¾ç‰‡ä¸Šä¼ </button>
        <button class="btn" id="testGenerator">ğŸ¨ æ‰“å¼€AIç”Ÿæˆå™¨</button>
        <button class="btn" id="testInjection">ğŸ”„ é‡æ–°æ³¨å…¥æŒ‰é’®</button>
      </div>
      <div id="testStatus"></div>
    </div>

    <div class="test-section">
      <h2>4. æµ‹è¯•ç»“æœ</h2>
      <div id="results">
        <div class="status info">
          <strong>ç­‰å¾…æµ‹è¯•...</strong>
          ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹æµ‹è¯•å„é¡¹åŠŸèƒ½ã€‚
        </div>
      </div>
    </div>

    <script>
      // æ¨¡æ‹Ÿ chrome.runtime API
      if (!window.chrome) {
        window.chrome = {
          runtime: {
            getURL: path => `/dist/${path}`
          }
        }
      }

      const results = document.getElementById('results')
      const testStatus = document.getElementById('testStatus')

      // Minimal createEl helper for this test page (mirrors project utility subset)
      function createEl(tag, opts) {
        const el = document.createElement(tag)
        if (opts) {
          if (opts.className) el.className = opts.className
          if (opts.text) el.textContent = opts.text
          if (opts.innerHTML) el.innerHTML = opts.innerHTML
        }
        return el
      }

      function addResult(message, type = 'info') {
        const div = createEl('div', { className: `status ${type}`, innerHTML: message })
        results.appendChild(div)
      }

      function updateStatus(message, type = 'info') {
        testStatus.innerHTML = `<div class="status ${type}">${message}</div>`
      }

      // æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
      document.getElementById('testUpload').addEventListener('click', async () => {
        updateStatus('æ­£åœ¨æµ‹è¯•å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½...', 'info')
        try {
          // è¿™é‡Œä¼šè°ƒç”¨å®é™…çš„ä¸Šä¼ åŠŸèƒ½
          if (window.showImageUploadDialog) {
            await window.showImageUploadDialog()
            addResult('âœ… å›¾ç‰‡ä¸Šä¼ å¯¹è¯æ¡†æ­£å¸¸æ‰“å¼€', 'success')
          } else {
            addResult('âŒ å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æœªåŠ è½½', 'error')
          }
        } catch (error) {
          addResult(`âŒ å›¾ç‰‡ä¸Šä¼ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
        }
        updateStatus('')
      })

      // æµ‹è¯•AIç”Ÿæˆå™¨
      document.getElementById('testGenerator').addEventListener('click', () => {
        updateStatus('æ­£åœ¨æ‰“å¼€AIå›¾ç‰‡ç”Ÿæˆå™¨...', 'info')
        try {
          // image-generator page removed
          window.open(url, '_blank')
          addResult('âœ… AIå›¾ç‰‡ç”Ÿæˆå™¨é¡µé¢å·²æ‰“å¼€', 'success')
        } catch (error) {
          addResult(`âŒ AIç”Ÿæˆå™¨æ‰“å¼€å¤±è´¥: ${error.message}`, 'error')
        }
        updateStatus('')
      })

      // æµ‹è¯•æŒ‰é’®æ³¨å…¥
      document.getElementById('testInjection').addEventListener('click', () => {
        updateStatus('æ­£åœ¨æµ‹è¯•æŒ‰é’®æ³¨å…¥åŠŸèƒ½...', 'info')
        try {
          // æ£€æŸ¥æ˜¯å¦æœ‰æ³¨å…¥å‡½æ•°
          if (window.injectButton && window.findAllToolbars) {
            const toolbars = window.findAllToolbars()
            if (toolbars.length > 0) {
              toolbars.forEach(toolbar => {
                window.injectButton(toolbar)
              })
              addResult(`âœ… æ‰¾åˆ° ${toolbars.length} ä¸ªå·¥å…·æ ï¼Œå·²æ³¨å…¥æŒ‰é’®`, 'success')
            } else {
              addResult('âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„å·¥å…·æ ', 'error')
            }
          } else {
            addResult('âŒ æ³¨å…¥åŠŸèƒ½æœªåŠ è½½', 'error')
          }
        } catch (error) {
          addResult(`âŒ æŒ‰é’®æ³¨å…¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
        }
        updateStatus('')
      })

      // æ—§çš„ è‡ªåŠ¨è¯·æ±‚ç»‘å®š æµ‹è¯•æŒ‰é’®å·²ç§»é™¤

      // é¡µé¢åŠ è½½æ—¶çš„æ£€æŸ¥
      window.addEventListener('load', () => {
        addResult('ğŸ” é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ç¯å¢ƒ...', 'info')

        // æ£€æŸ¥å·¥å…·æ 
        const standardToolbar = document.querySelector('.d-editor-button-bar[role="toolbar"]')
        const chatToolbar = document.querySelector('.chat-composer__inner-container')

        if (standardToolbar) {
          addResult('âœ… æ‰¾åˆ°æ ‡å‡†ç¼–è¾‘å™¨å·¥å…·æ ', 'success')
        }
        if (chatToolbar) {
          addResult('âœ… æ‰¾åˆ°èŠå¤©ç¼–è¾‘å™¨å·¥å…·æ ', 'success')
        }

        // æ£€æŸ¥è¾“å…¥æ¡†
        const textArea = document.querySelector('.d-editor-input')
        if (textArea) {
          addResult('âœ… æ‰¾åˆ°ç¼–è¾‘å™¨è¾“å…¥æ¡†', 'success')
        }

        addResult('ğŸ“‹ æµ‹è¯•ç¯å¢ƒå‡†å¤‡å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ‰‹åŠ¨æµ‹è¯•', 'info')
      })
    </script>
  </body>
</html>
