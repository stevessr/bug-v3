# 联动上传协调服务器

本地部署的轻量级 WebSocket 服务器，用于协调多个插件用户并行上传，绕过单账户速率限制。

## 快速开始

```bash
# 安装依赖
npm install

# 启动服务器（默认端口 9527）
npm start

# 或指定端口
node server.js 8080
```

## 架构说明

```
┌─────────────────────────────────────────────────────────────┐
│                    本地协调服务器 (Node.js)                   │
│  - 任务队列管理                                               │
│  - 工作者注册/心跳                                            │
│  - 任务分发与结果收集                                          │
└─────────────────────────────────────────────────────────────┘
        ▲              ▲              ▲
        │ WebSocket    │ WebSocket    │ WebSocket
        ▼              ▼              ▼
   ┌─────────┐    ┌─────────┐    ┌─────────┐
   │ 主控端   │    │ 工作者1  │    │ 工作者2  │
   │ (插件)   │    │ (插件)   │    │ (插件)   │
   └─────────┘    └─────────┘    └─────────┘
```

## 使用方式

### 1. 运行协调服务器

在局域网内的一台机器上运行此服务器。其他用户需要能够访问这台机器的 IP。

```bash
npm start
```

服务器启动后会显示：

- WebSocket 地址：`ws://localhost:9527`
- 状态页面：`http://localhost:9527`

### 2. 配置插件

在插件的「设置 → 联动上传」页面：

1. 输入服务器地址（如 `ws://192.168.1.100:9527`）
2. 选择模式：
   - **工作者模式**: 帮助其他用户上传，贡献你的上传配额
   - **主控模式**: 将上传任务分发给工作者

### 3. 工作流程

1. 工作者连接到服务器，等待任务
2. 主控端选择文件，提交上传任务
3. 服务器将任务分发给空闲的工作者
4. 工作者使用自己的账户完成上传
5. 上传结果返回给主控端

## API 协议

### 客户端 → 服务器

| 类型               | 说明                   |
| ------------------ | ---------------------- |
| `WORKER_REGISTER`  | 注册为工作者           |
| `WORKER_HEARTBEAT` | 工作者心跳             |
| `CREATE_SESSION`   | 创建上传会话（主控端） |
| `SUBMIT_TASKS`     | 提交上传任务           |
| `TASK_COMPLETED`   | 报告任务完成           |
| `TASK_FAILED`      | 报告任务失败           |
| `GET_STATS`        | 获取服务器状态         |

### 服务器 → 客户端

| 类型                | 说明                       |
| ------------------- | -------------------------- |
| `WORKER_REGISTERED` | 工作者注册成功             |
| `SESSION_CREATED`   | 会话创建成功               |
| `TASKS_SUBMITTED`   | 任务提交确认               |
| `TASK_ASSIGNED`     | 任务分配（发给工作者）     |
| `TASK_COMPLETED`    | 任务完成通知（发给主控端） |
| `TASK_FAILED`       | 任务失败通知               |
| `SESSION_COMPLETED` | 会话完成                   |
| `STATS_UPDATE`      | 状态更新                   |

## 安全注意事项

1. **仅在可信网络中使用**: 此服务器没有身份验证，任何能访问的人都可以连接
2. **文件数据传输**: 文件以 Base64 编码通过 WebSocket 传输
3. **账户安全**: 工作者使用自己的账户上传，请确保只与信任的人共享服务器

## 高级配置

### 使用 nginx 反向代理（可选）

```nginx
location /ws {
    proxy_pass http://127.0.0.1:9527;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
}
```

### 添加简单认证（可选扩展）

可以修改 server.js 在 `handleMessage` 中添加 token 验证逻辑。

## 常见问题

**Q: 工作者断开连接后任务会丢失吗？**

A: 不会。服务器会自动将该工作者的任务重新放入队列，由其他工作者处理。

**Q: 上传失败会重试吗？**

A: 会。每个任务最多重试 3 次，之后标记为失败。

**Q: 如何查看服务器状态？**

A: 访问 `http://localhost:9527` 查看实时状态页面。
