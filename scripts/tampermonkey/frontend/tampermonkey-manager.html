<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tampermonkey 表情扩展管理器</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Ant Design Vue -->
    <script src="https://unpkg.com/ant-design-vue@4/dist/antd.min.js"></script>
    <link href="https://unpkg.com/ant-design-vue@4/dist/reset.css" rel="stylesheet" />

    <!-- Tailwind CSS -->
    <link href="https://unpkg.com/tailwindcss@3/dist/tailwind.min.css" rel="stylesheet" />

    <!-- Icons -->
    <link href="https://unpkg.com/@ant-design/icons-vue/dist/index.css" rel="stylesheet" />

    <!-- FFmpeg WASM -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>

    <style>
      .emoji-grid {
        display: grid;
        gap: 8px;
        padding: 16px;
      }
      .emoji-item {
        width: 48px;
        height: 48px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
      }
      .emoji-item:hover {
        border-color: #1890ff;
        transform: scale(1.1);
      }
      .group-header {
        background: #f5f5f5;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        border-left: 4px solid #1890ff;
      }
      .management-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .tools-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 24px;
      }
      .tool-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .progress-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
      }
      .drag-drop-zone {
        border: 2px dashed #d9d9d9;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
      }
      .drag-drop-zone:hover {
        border-color: #1890ff;
        background: #f0f7ff;
      }
      .drag-drop-zone.dragover {
        border-color: #52c41a;
        background: #f6ffed;
      }
      .image-editor-canvas {
        max-width: 100%;
        border: 1px solid #d9d9d9;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <a-layout style="min-height: 100vh">
        <!-- Header -->
        <a-layout-header style="background: #001529; padding: 0">
          <div style="display: flex; align-items: center; padding: 0 24px">
            <h1 style="color: white; margin: 0; font-size: 20px">🎭 Tampermonkey 表情扩展管理器</h1>
            <div style="margin-left: auto">
              <a-button type="primary" @click="syncWithUserscript">同步到用户脚本</a-button>
            </div>
          </div>
        </a-layout-header>

        <a-layout>
          <!-- Sidebar -->
          <a-layout-sider width="250" style="background: #fff">
            <a-menu v-model:selectedKeys="selectedKeys" mode="inline" style="height: 100%">
              <a-menu-item key="tools">
                <span>🔧 小工具</span>
              </a-menu-item>
              <a-menu-item key="image-editor">
                <span>✂️ 图像编辑器</span>
              </a-menu-item>
              <a-menu-item key="ai-generator">
                <span>🎨 AI 图像生成器</span>
              </a-menu-item>
              <a-menu-item key="emoji-naming">
                <span>🤖 AI 表情重命名</span>
              </a-menu-item>
              <a-menu-item key="emoji-manager">
                <span>😀 表情管理</span>
              </a-menu-item>
              <a-menu-item key="external-import">
                <span>📤 外部导入</span>
              </a-menu-item>
              <a-menu-item key="settings">
                <span>⚙️ 设置</span>
              </a-menu-item>
            </a-menu>
          </a-layout-sider>

          <!-- Main Content -->
          <a-layout-content style="padding: 24px; background: #f0f2f5">
            <!-- Tools Section -->
            <div v-if="selectedKeys[0] === 'tools'" class="tools-section">
              <h2 style="color: white; margin-bottom: 24px">🔧 多媒体小工具</h2>

              <!-- Format Converter -->
              <div class="tool-card">
                <h3 style="color: white; margin-bottom: 16px">格式转换器</h3>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 16px">
                  支持 GIF, MP4, WebM → APNG/GIF 转换，具有完整的重新编码功能
                </p>
                <div
                  class="drag-drop-zone"
                  @drop="handleDrop"
                  @dragover.prevent="handleDragOver"
                  @dragleave="handleDragLeave"
                >
                  <input
                    type="file"
                    ref="formatFileInput"
                    @change="handleFormatConvert"
                    accept="video/*,image/gif"
                    style="display: none"
                  />
                  <p style="margin: 0; color: #666">拖拽文件到此处或点击选择文件</p>
                  <p style="margin: 8px 0 0 0; font-size: 12px; color: #999">
                    支持: GIF, MP4, WebM
                  </p>
                </div>
              </div>

              <!-- Frame Splitter -->
              <div class="tool-card">
                <h3 style="color: white; margin-bottom: 16px">帧分离器</h3>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 16px">
                  从动画中提取单独的帧
                </p>
                <a-button type="primary" @click="openFrameSplitter">启动帧分离器</a-button>
              </div>

              <!-- Frame Merger -->
              <div class="tool-card">
                <h3 style="color: white; margin-bottom: 16px">帧合并器</h3>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 16px">
                  将多个图像合并为动画 GIF/APNG
                </p>
                <a-button type="primary" @click="openFrameMerger">启动帧合并器</a-button>
              </div>

              <!-- FFmpeg Integration -->
              <div class="tool-card">
                <h3 style="color: white; margin-bottom: 16px">本地 FFmpeg 集成</h3>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 16px">
                  使用本地 @ffmpeg/ffmpeg 和 @ffmpeg/util 进行高级视频处理
                </p>
                <a-button type="primary" @click="initFFmpeg" :loading="ffmpegLoading">
                  {{ ffmpegLoaded ? '✅ FFmpeg 已就绪' : '初始化 FFmpeg' }}
                </a-button>
              </div>
            </div>

            <!-- Progress Display -->
            <div v-if="showProgress" class="progress-container">
              <h4>处理进度</h4>
              <a-progress :percent="progressPercent" :status="progressStatus">
                <template #format="percent">{{ progressText }} ({{ percent }}%)</template>
              </a-progress>
              <div v-if="fileInfo" style="margin-top: 12px; font-size: 12px; color: #666">
                <p>文件大小: {{ fileInfo.size }}</p>
                <p>尺寸: {{ fileInfo.dimensions }}</p>
                <p>帧率: {{ fileInfo.framerate }}</p>
                <p>编码: {{ fileInfo.codec }}</p>
                <p>码率: {{ fileInfo.bitrate }}</p>
              </div>
            </div>

            <!-- Other sections placeholder -->
            <div v-else-if="selectedKeys[0] === 'image-editor'">
              <h2>✂️ 专业图像编辑器</h2>
              <p>功能开发中...</p>
            </div>

            <div v-else-if="selectedKeys[0] === 'ai-generator'">
              <h2>🎨 增强型 AI 图像生成器</h2>
              <p>功能开发中...</p>
            </div>

            <div v-else-if="selectedKeys[0] === 'emoji-naming'">
              <h2>🤖 AI 表情符号重命名系统</h2>
              <p>功能开发中...</p>
            </div>

            <div v-else>
              <h2>欢迎使用 Tampermonkey 表情扩展管理器</h2>
              <p>请从左侧菜单选择功能模块。</p>
            </div>
          </a-layout-content>
        </a-layout>
      </a-layout>
    </div>

    <script>
      const { createApp } = Vue
      const {
        Layout,
        LayoutHeader,
        LayoutSider,
        LayoutContent,
        Menu,
        MenuItem,
        Button,
        Progress,
        message
      } = antd

      createApp({
        components: {
          'a-layout': Layout,
          'a-layout-header': LayoutHeader,
          'a-layout-sider': LayoutSider,
          'a-layout-content': LayoutContent,
          'a-menu': Menu,
          'a-menu-item': MenuItem,
          'a-button': Button,
          'a-progress': Progress
        },
        data() {
          return {
            selectedKeys: ['tools'],
            showProgress: false,
            progressPercent: 0,
            progressStatus: 'active',
            progressText: '',
            fileInfo: null,
            ffmpegLoaded: false,
            ffmpegLoading: false,
            ffmpeg: null
          }
        },
        methods: {
          async initFFmpeg() {
            if (this.ffmpegLoaded) return

            this.ffmpegLoading = true
            try {
              const { FFmpeg } = FFmpegWASM
              this.ffmpeg = new FFmpeg()

              await this.ffmpeg.load()
              this.ffmpegLoaded = true
              message.success('FFmpeg 初始化成功！')
            } catch (error) {
              console.error('FFmpeg initialization failed:', error)
              message.error('FFmpeg 初始化失败: ' + error.message)
            } finally {
              this.ffmpegLoading = false
            }
          },

          handleDrop(e) {
            e.preventDefault()
            const files = Array.from(e.dataTransfer.files)
            if (files.length > 0) {
              this.processFile(files[0])
            }
            e.target.classList.remove('dragover')
          },

          handleDragOver(e) {
            e.preventDefault()
            e.target.classList.add('dragover')
          },

          handleDragLeave(e) {
            e.target.classList.remove('dragover')
          },

          handleFormatConvert(e) {
            const file = e.target.files[0]
            if (file) {
              this.processFile(file)
            }
          },

          async processFile(file) {
            this.showProgress = true
            this.progressPercent = 0
            this.progressText = '正在分析文件...'

            // Simulate file analysis
            this.fileInfo = {
              size: this.formatBytes(file.size),
              dimensions: '分析中...',
              framerate: '分析中...',
              codec: '分析中...',
              bitrate: '分析中...'
            }

            // Simulate progress
            const progressSteps = [
              { percent: 10, text: '正在读取文件...' },
              { percent: 30, text: '正在分析媒体信息...' },
              { percent: 50, text: '正在处理帧数据...' },
              { percent: 70, text: '正在编码转换...' },
              { percent: 90, text: '正在生成输出文件...' },
              { percent: 100, text: '处理完成！' }
            ]

            for (const step of progressSteps) {
              await this.delay(500)
              this.progressPercent = step.percent
              this.progressText = step.text

              if (step.percent === 30) {
                // Simulate getting file info
                this.fileInfo = {
                  size: this.formatBytes(file.size),
                  dimensions: '1920x1080',
                  framerate: '30 fps',
                  codec: file.type.includes('video') ? 'H.264' : 'GIF',
                  bitrate: '2000 kbps'
                }
              }
            }

            this.progressStatus = 'success'
            message.success('文件处理完成！')

            setTimeout(() => {
              this.showProgress = false
              this.progressStatus = 'active'
            }, 2000)
          },

          openFrameSplitter() {
            message.info('帧分离器功能开发中...')
          },

          openFrameMerger() {
            message.info('帧合并器功能开发中...')
          },

          syncWithUserscript() {
            message.success('已同步到用户脚本！')
          },

          formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes'
            const k = 1024
            const sizes = ['Bytes', 'KB', 'MB', 'GB']
            const i = Math.floor(Math.log(bytes) / Math.log(k))
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
          },

          delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms))
          }
        },

        mounted() {
          // Click handler for drag-drop zone
          document.querySelector('.drag-drop-zone').addEventListener('click', () => {
            this.$refs.formatFileInput.click()
          })
        }
      }).mount('#app')
    </script>
  </body>
</html>
