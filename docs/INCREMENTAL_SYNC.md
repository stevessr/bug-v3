# å¢é‡åŒæ­¥ä¸å†²çªåˆå¹¶ç³»ç»Ÿ

å®Œæ•´çš„å¢é‡åŒæ­¥è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå¤šç«¯æ•°æ®åŒæ­¥ã€æ™ºèƒ½å†²çªæ£€æµ‹å’Œè‡ªåŠ¨åˆå¹¶ã€‚

## ğŸ“‹ ç›®å½•

- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [API æ–‡æ¡£](#api-æ–‡æ¡£)
- [å†²çªè§£å†³ç­–ç•¥](#å†²çªè§£å†³ç­–ç•¥)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## æ ¸å¿ƒåŠŸèƒ½

### âœ¨ ä¸»è¦ç‰¹æ€§

1. **å¢é‡åŒæ­¥**
   - åªåŒæ­¥å˜æ›´çš„æ•°æ®ï¼ŒèŠ‚çœå¸¦å®½
   - ç‰ˆæœ¬æ§åˆ¶å’Œå˜æ›´è¿½è¸ª
   - æ”¯æŒç¦»çº¿é˜Ÿåˆ—å’Œè‡ªåŠ¨é‡è¯•

2. **æ™ºèƒ½å†²çªæ£€æµ‹**
   - å­—æ®µçº§å†²çªæ£€æµ‹
   - ä¸‰æ–¹åˆå¹¶ç®—æ³•
   - å¤šç§è‡ªåŠ¨è§£å†³ç­–ç•¥

3. **å¯è§†åŒ–å†²çªè§£å†³**
   - ç›´è§‚çš„å¯¹æ¯”ç•Œé¢
   - æ‰‹åŠ¨å’Œè‡ªåŠ¨è§£å†³é€‰é¡¹
   - å†²çªå†å²è¿½è¸ª

4. **ç¦»çº¿æ”¯æŒ**
   - ç¦»çº¿å˜æ›´é˜Ÿåˆ—
   - ç½‘ç»œæ¢å¤è‡ªåŠ¨åŒæ­¥
   - å¤±è´¥é‡è¯•æœºåˆ¶

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (App Layer)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ EmojiStore   â”‚  â”‚  UIç»„ä»¶      â”‚  â”‚  ç”¨æˆ·æ“ä½œ    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â–¼                  â–¼                  â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         å˜æ›´è·Ÿè¸ªå™¨ (ChangeTracker)               â”‚   â”‚
â”‚  â”‚  - æ‹¦æˆªæ‰€æœ‰æ•°æ®å˜æ›´                               â”‚   â”‚
â”‚  â”‚  - ç”Ÿæˆ DeltaRecord                              â”‚   â”‚
â”‚  â”‚  - æ‰¹é‡å†™å…¥ä¼˜åŒ–                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                    â”‚
â”‚         åŒæ­¥æœåŠ¡å±‚ (Sync Service Layer)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    å¢é‡åŒæ­¥æœåŠ¡ (IncrementalSyncService)          â”‚  â”‚
â”‚  â”‚  - ç‰ˆæœ¬ç®¡ç†                                       â”‚  â”‚
â”‚  â”‚  - å¢é‡å˜æ›´è®¡ç®—                                   â”‚  â”‚
â”‚  â”‚  - å†²çªæ£€æµ‹ä¸è§£å†³                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                  â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å†²çªè§£å†³å™¨     â”‚            â”‚  ç¦»çº¿é˜Ÿåˆ—ç®¡ç†å™¨      â”‚ â”‚
â”‚  â”‚ (Conflict     â”‚            â”‚  (OfflineQueue)     â”‚ â”‚
â”‚  â”‚  Resolver)    â”‚            â”‚  - ç½‘ç»œçŠ¶æ€ç›‘å¬      â”‚ â”‚
â”‚  â”‚ - ä¸‰æ–¹åˆå¹¶     â”‚            â”‚  - è‡ªåŠ¨é‡è¯•         â”‚ â”‚
â”‚  â”‚ - æ™ºèƒ½æ£€æµ‹     â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                        â”‚
â”‚         å­˜å‚¨å±‚ (Storage Layer)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     IndexedDB (SyncDatabase)                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚ deltaRecords â”‚  â”‚ syncVersions â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚ conflictHist â”‚  â”‚ offlineQueue â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     è¿œç¨‹å­˜å‚¨ (Remote Storage)                     â”‚  â”‚
â”‚  â”‚  - Cloudflare R2                                 â”‚  â”‚
â”‚  â”‚  - Chrome Sync                                   â”‚  â”‚
â”‚  â”‚  - WebDAV (æ‰©å±•)                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–åŒæ­¥ç³»ç»Ÿ

```typescript
import { changeTracker } from '@/services/change-tracker'
import { incrementalSyncService } from '@/services/incremental-sync'

// ç³»ç»Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
```

### 2. è®°å½•å˜æ›´

```typescript
import { changeTracker } from '@/services/change-tracker'
import { OperationType } from '@/types/sync'

// åœ¨æ•°æ®å˜æ›´æ—¶è‡ªåŠ¨è®°å½•
await changeTracker.trackChange({
  operation: OperationType.UPDATE,
  entityType: 'emoji',
  entityId: 'emoji-123',
  changes: [
    {
      field: 'name',
      oldValue: 'old name',
      newValue: 'new name'
    }
  ]
})
```

### 3. æ‰§è¡ŒåŒæ­¥

```typescript
import { incrementalSyncService } from '@/services/incremental-sync'

// å¢é‡åŒæ­¥
const result = await incrementalSyncService.sync({
  provider: 'cloudflare',
  conflictStrategy: 'newest-wins'
})

if (result.success) {
  console.log('åŒæ­¥æˆåŠŸï¼')
} else if (result.conflicts) {
  // å¤„ç†å†²çª
  console.log('æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³')
}
```

### 4. å¤„ç†å†²çª

```vue
<template>
  <ConflictResolver
    v-if="conflicts.length > 0"
    :conflicts="conflicts"
    @resolved="handleResolved"
    @cancel="handleCancel"
    @continue="handleContinue"
  />
</template>

<script setup>
import ConflictResolver from '@/components/ConflictResolver.vue'
import { ref } from 'vue'

const conflicts = ref([])

async function handleResolved(conflict, resolution) {
  console.log(`å†²çª ${conflict.id} å·²è§£å†³ï¼š${resolution}`)
}
</script>
```

## API æ–‡æ¡£

### ChangeTracker

#### trackChange(params)

è®°å½•æ•°æ®å˜æ›´ã€‚

**å‚æ•°ï¼š**
- `operation`: æ“ä½œç±»å‹ (CREATE, UPDATE, DELETE, MOVE, REORDER)
- `entityType`: å®ä½“ç±»å‹ (emoji, group, settings, favorites)
- `entityId`: å®ä½“ ID
- `changes`: å˜æ›´å†…å®¹æ•°ç»„
- `immediate`: æ˜¯å¦ç«‹å³å†™å…¥ (å¯é€‰ï¼Œé»˜è®¤æ‰¹é‡)

**è¿”å›ï¼š** `Promise<void>`

**ç¤ºä¾‹ï¼š**
```typescript
await changeTracker.trackChange({
  operation: OperationType.CREATE,
  entityType: 'emoji',
  entityId: 'new-emoji-123',
  changes: [{
    field: 'emojis',
    oldValue: null,
    newValue: { id: 'new-emoji-123', name: 'New Emoji', url: '...' }
  }]
})
```

#### flush()

æ‰‹åŠ¨è§¦å‘æ‰¹é‡å†™å…¥ã€‚

**è¿”å›ï¼š** `Promise<void>`

#### getStats()

è·å–ç»Ÿè®¡ä¿¡æ¯ã€‚

**è¿”å›ï¼š** `Promise<{ currentVersion, deviceId, totalRecords, pendingBatch }>`

### IncrementalSyncService

#### sync(options)

æ‰§è¡ŒåŒæ­¥æ“ä½œã€‚

**å‚æ•°ï¼š**
- `provider`: åŒæ­¥æä¾›å•† (cloudflare, chrome)
- `fullSync`: æ˜¯å¦å¼ºåˆ¶å…¨é‡åŒæ­¥ (å¯é€‰)
- `conflictStrategy`: å†²çªè§£å†³ç­–ç•¥ (å¯é€‰)

**è¿”å›ï¼š** `Promise<SyncResult>`

**ç¤ºä¾‹ï¼š**
```typescript
const result = await incrementalSyncService.sync({
  provider: 'cloudflare',
  conflictStrategy: 'auto'
})
```

#### getSyncState()

è·å–å½“å‰åŒæ­¥çŠ¶æ€ã€‚

**è¿”å›ï¼š** `SyncState`

#### getStats()

è·å–åŒæ­¥ç»Ÿè®¡ä¿¡æ¯ã€‚

**è¿”å›ï¼š** `Promise<{ localVersion, remoteVersion, pendingChanges, unresolvedConflicts }>`

### ConflictResolver

#### detectConflicts(localDeltas, remoteDeltas)

æ£€æµ‹å†²çªã€‚

**å‚æ•°ï¼š**
- `localDeltas`: æœ¬åœ°å˜æ›´æ•°ç»„
- `remoteDeltas`: è¿œç¨‹å˜æ›´æ•°ç»„

**è¿”å›ï¼š** `ConflictInfo[]`

#### autoResolve(conflicts, strategy)

è‡ªåŠ¨è§£å†³å†²çªã€‚

**å‚æ•°ï¼š**
- `conflicts`: å†²çªæ•°ç»„
- `strategy`: è§£å†³ç­–ç•¥ (auto, manual, local-first, remote-first, newest-wins)

**è¿”å›ï¼š** `Promise<ConflictInfo[]>`

#### manualResolve(conflictId, resolution, mergedData?)

æ‰‹åŠ¨è§£å†³å†²çªã€‚

**å‚æ•°ï¼š**
- `conflictId`: å†²çª ID
- `resolution`: è§£å†³æ–¹æ¡ˆ (local, remote, merged)
- `mergedData`: åˆå¹¶åçš„æ•°æ® (å¯é€‰)

**è¿”å›ï¼š** `Promise<void>`

#### threeWayMerge(base, local, remote, entityType)

ä¸‰æ–¹åˆå¹¶ã€‚

**å‚æ•°ï¼š**
- `base`: åŸºç¡€ç‰ˆæœ¬
- `local`: æœ¬åœ°ç‰ˆæœ¬
- `remote`: è¿œç¨‹ç‰ˆæœ¬
- `entityType`: å®ä½“ç±»å‹

**è¿”å›ï¼š** `Promise<MergeResult>`

## å†²çªè§£å†³ç­–ç•¥

### 1. auto (è‡ªåŠ¨)

å°è¯•æ™ºèƒ½åˆå¹¶ï¼Œå¤±è´¥åˆ™ä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**
- å¤§éƒ¨åˆ†å¸¸è§„åŒæ­¥
- éå…³é”®æ•°æ®

### 2. manual (æ‰‹åŠ¨)

æ£€æµ‹åˆ°å†²çªæ—¶æš‚åœåŒæ­¥ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è§£å†³ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**
- é‡è¦æ•°æ®ä¿®æ”¹
- éœ€è¦äººå·¥åˆ¤æ–­çš„æƒ…å†µ

### 3. local-first (æœ¬åœ°ä¼˜å…ˆ)

å§‹ç»ˆä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**
- ç¦»çº¿ç¼–è¾‘åçš„é¦–æ¬¡åŒæ­¥
- ç¡®ä¿¡æœ¬åœ°æ•°æ®æ­£ç¡®

### 4. remote-first (è¿œç¨‹ä¼˜å…ˆ)

å§‹ç»ˆä½¿ç”¨è¿œç¨‹ç‰ˆæœ¬ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**
- ä»äº‘ç«¯æ¢å¤æ•°æ®
- å¤šè®¾å¤‡é—´ä»¥æœåŠ¡å™¨ä¸ºå‡†

### 5. newest-wins (æœ€æ–°ä¼˜å…ˆ)

æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**
- é»˜è®¤ç­–ç•¥
- å¤§éƒ¨åˆ†åœºæ™¯çš„åˆç†é€‰æ‹©

## æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®åŒæ­¥é¢‘ç‡

```typescript
// ä¸è¦è¿‡äºé¢‘ç¹åŒæ­¥
let syncTimer: NodeJS.Timeout | null = null

function scheduleSyncfunction scheduleSync() {
  if (syncTimer) clearTimeout(syncTimer)
  
  syncTimer = setTimeout(async () => {
    await incrementalSyncService.sync({
      provider: 'cloudflare',
      conflictStrategy: 'newest-wins'
    })
  }, 60000) // æ¯åˆ†é’Ÿæœ€å¤šåŒæ­¥ä¸€æ¬¡
}
```

### 2. æ‰¹é‡æ“ä½œä½¿ç”¨æ‰¹å¤„ç†

```typescript
import { useEmojiStore } from '@/stores/emojiStore'

const store = useEmojiStore()

// å¼€å§‹æ‰¹å¤„ç†
store.beginBatch()

try {
  // æ‰¹é‡æ·»åŠ  emoji
  for (const emoji of emojis) {
    store.addEmojiWithoutSave(groupId, emoji)
  }
} finally {
  // ç»“æŸæ‰¹å¤„ç†ï¼Œè§¦å‘ä¸€æ¬¡æ€§ä¿å­˜å’ŒåŒæ­¥
  await store.endBatch()
}
```

### 3. å¤„ç†ç¦»çº¿åœºæ™¯

```typescript
import { offlineQueue } from '@/services/offline-queue'

// ç›‘å¬ç½‘ç»œçŠ¶æ€
window.addEventListener('online', async () => {
  console.log('ç½‘ç»œå·²æ¢å¤ï¼Œå¼€å§‹åŒæ­¥ç¦»çº¿å˜æ›´')
  await offlineQueue.processQueue()
})

// æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
const status = offlineQueue.getStatus()
if (status.queueLength > 0) {
  console.log(`æœ‰ ${status.queueLength} ä¸ªå˜æ›´å¾…åŒæ­¥`)
}
```

### 4. å®šæœŸæ¸…ç†æ—§è®°å½•

```typescript
import { changeTracker } from '@/services/change-tracker'

// æ¯å‘¨æ¸…ç†ä¸€æ¬¡è¶…è¿‡ 30 å¤©çš„è®°å½•
setInterval(async () => {
  const removed = await changeTracker.cleanupOldRecords(30)
  console.log(`æ¸…ç†äº† ${removed} æ¡æ—§è®°å½•`)
}, 7 * 24 * 60 * 60 * 1000)
```

### 5. ç›‘æ§åŒæ­¥çŠ¶æ€

```typescript
import { incrementalSyncService } from '@/services/incremental-sync'

// å®šæœŸæ£€æŸ¥åŒæ­¥çŠ¶æ€
setInterval(async () => {
  const stats = await incrementalSyncService.getStats()
  
  if (stats.unresolvedConflicts > 0) {
    console.warn(`æœ‰ ${stats.unresolvedConflicts} ä¸ªæœªè§£å†³çš„å†²çª`)
  }
  
  if (stats.pendingChanges > 100) {
    console.warn(`æœ‰ ${stats.pendingChanges} ä¸ªå¾…åŒæ­¥å˜æ›´`)
  }
}, 60000)
```

## æ•…éšœæ’é™¤

### é—®é¢˜ï¼šåŒæ­¥å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
1. ç½‘ç»œè¿æ¥é—®é¢˜
2. è¿œç¨‹å­˜å‚¨é…ç½®é”™è¯¯
3. æƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
const result = await incrementalSyncService.sync({
  provider: 'cloudflare',
  conflictStrategy: 'newest-wins'
})

if (!result.success) {
  console.error('åŒæ­¥å¤±è´¥ï¼š', result.error)
  
  // æ£€æŸ¥ç½‘ç»œ
  if (!navigator.onLine) {
    console.log('ç½‘ç»œç¦»çº¿ï¼Œå˜æ›´å·²åŠ å…¥é˜Ÿåˆ—')
  }
  
  // æ£€æŸ¥é…ç½®
  const config = cloudflareSyncService.getConfig()
  if (!config) {
    console.error('æœªé…ç½®åŒæ­¥æœåŠ¡')
  }
}
```

### é—®é¢˜ï¼šå†²çªæ— æ³•è‡ªåŠ¨è§£å†³

**å¯èƒ½åŸå› ï¼š**
1. ç›¸åŒå­—æ®µè¢«ä¸åŒè®¾å¤‡ä¿®æ”¹
2. å†²çªè§£å†³ç­–ç•¥ä¸é€‚åˆ

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// ä½¿ç”¨æ‰‹åŠ¨è§£å†³ç­–ç•¥
const result = await incrementalSyncService.sync({
  provider: 'cloudflare',
  conflictStrategy: 'manual'
})

if (result.conflicts && result.conflicts.length > 0) {
  // æ˜¾ç¤ºå†²çªè§£å†³ç•Œé¢
  showConflictResolver(result.conflicts)
}
```

### é—®é¢˜ï¼šIndexedDB é”™è¯¯

**å¯èƒ½åŸå› ï¼š**
1. æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB
2. å­˜å‚¨ç©ºé—´ä¸è¶³
3. éšç§æ¨¡å¼é™åˆ¶

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
try {
  const db = new SyncDatabase()
  await db.open()
} catch (error) {
  console.error('IndexedDB åˆå§‹åŒ–å¤±è´¥ï¼š', error)
  
  // é™çº§åˆ° localStorage
  // æˆ–æç¤ºç”¨æˆ·å¯ç”¨ IndexedDB
}
```

### é—®é¢˜ï¼šå˜æ›´è®°å½•è¿‡å¤š

**å¯èƒ½åŸå› ï¼š**
1. é•¿æ—¶é—´æœªæ¸…ç†
2. é¢‘ç¹çš„å°å˜æ›´

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// å®šæœŸæ¸…ç†
await changeTracker.cleanupOldRecords(7) // åªä¿ç•™ 7 å¤©

// æˆ–æ‰‹åŠ¨æ¸…ç†
const stats = await changeTracker.getStats()
if (stats.totalRecords > 10000) {
  await changeTracker.cleanupOldRecords(7)
}
```

## é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰å†²çªè§£å†³ç­–ç•¥

```typescript
import { conflictResolver } from '@/services/conflict-resolver'

async function customResolve(conflict: ConflictInfo): Promise<'local' | 'remote' | 'merged'> {
  // è‡ªå®šä¹‰é€»è¾‘
  if (conflict.entityType === 'settings') {
    // è®¾ç½®æ€»æ˜¯ä½¿ç”¨æœ€æ–°çš„
    return conflict.localChange.timestamp > conflict.remoteChange.timestamp 
      ? 'local' 
      : 'remote'
  }
  
  if (conflict.entityType === 'emoji') {
    // Emoji å°è¯•åˆå¹¶
    const mergeResult = await conflictResolver.threeWayMerge(
      baseData,
      conflict.localChange,
      conflict.remoteChange,
      'emoji'
    )
    
    return mergeResult.success ? 'merged' : 'local'
  }
  
  return 'local'
}
```

### å®ç°è‡ªå®šä¹‰åŒæ­¥æä¾›å•†

```typescript
import type { SyncOptions, SyncResult, DeltaRecord } from '@/types/sync'

class CustomSyncProvider {
  async push(deltas: DeltaRecord[]): Promise<void> {
    // å®ç°æ¨é€é€»è¾‘
  }
  
  async pull(sinceVersion: number): Promise<DeltaRecord[]> {
    // å®ç°æ‹‰å–é€»è¾‘
  }
  
  async getRemoteVersion(): Promise<number> {
    // å®ç°ç‰ˆæœ¬è·å–é€»è¾‘
  }
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡å†™å…¥

å˜æ›´è·Ÿè¸ªå™¨é»˜è®¤ä½¿ç”¨ 100ms çš„æ‰¹é‡å»¶è¿Ÿï¼Œå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ï¼š

```typescript
// åœ¨ change-tracker.ts ä¸­
private scheduleBatchWrite() {
  this.batchTimeout = window.setTimeout(async () => {
    await this.flushBatch()
  }, 50) // å‡å°‘åˆ° 50ms ä»¥æé«˜å“åº”é€Ÿåº¦
}
```

### 2. ç´¢å¼•ä¼˜åŒ–

ç¡®ä¿ IndexedDB çš„ç´¢å¼•è®¾ç½®åˆç†ï¼š

```typescript
// åœ¨ sync-db.ts ä¸­
this.version(1).stores({
  deltaRecords: 'id, timestamp, version, [entityType+entityId]',
  // æ·»åŠ å¤åˆç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
})
```

### 3. æ•°æ®å‹ç¼©

å¯¹äºå¤§é‡å˜æ›´ï¼Œå¯ä»¥è€ƒè™‘å‹ç¼©ï¼š

```typescript
import pako from 'pako'

function compressDeltas(deltas: DeltaRecord[]): Uint8Array {
  const json = JSON.stringify(deltas)
  return pako.deflate(json)
}

function decompressDeltas(compressed: Uint8Array): DeltaRecord[] {
  const json = pako.inflate(compressed, { to: 'string' })
  return JSON.parse(json)
}
```

## å®‰å…¨è€ƒè™‘

### 1. æ•°æ®åŠ å¯†

```typescript
// å¯¹æ•æ„Ÿæ•°æ®åŠ å¯†
import CryptoJS from 'crypto-js'

function encryptData(data: any, key: string): string {
  return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString()
}

function decryptData(encrypted: string, key: string): any {
  const bytes = CryptoJS.AES.decrypt(encrypted, key)
  return JSON.parse(bytes.toString(CryptoJS.enc.Utf8))
}
```

### 2. æƒé™éªŒè¯

```typescript
// éªŒè¯ç”¨æˆ·æƒé™
async function syncWithAuth(options: SyncOptions) {
  const token = await getAuthToken()
  
  if (!token) {
    throw new Error('æœªæˆæƒ')
  }
  
  return await incrementalSyncService.sync(options)
}
```

## è®¸å¯è¯

MIT License
