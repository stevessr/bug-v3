# 自定义文件选择器实现说明

## ✨ 功能概述

我们实现了一个**自定义文件选择器UI包装器**，在用户点击上传区域时，先显示一个美观的自定义对话框，提供更好的用户体验和说明。

## 🎯 实现方式

### 用户体验流程

#### 旧方式（原生）
```
点击上传区域 → 直接打开系统文件选择器
```

#### 新方式（自定义UI）
```
点击上传区域 → 自定义对话框（说明 + 选项）→ 点击"浏览文件" → 系统文件选择器
```

### 优势

1. **更好的说明**
   - 清楚地告知用户将要选择什么
   - 显示支持的文件类型
   - 提供拖拽上传的提示

2. **统一的视觉风格**
   - 与应用其他对话框保持一致
   - 支持主题色适配
   - 平滑的动画效果

3. **安全提示**
   - 解释为什么使用系统原生选择器
   - 消除用户疑虑

4. **可取消操作**
   - 用户可以在选择文件前取消
   - 更灵活的交互流程

## 📋 实现的功能

### 1. showCustomFilePicker - 通用文件选择器

```typescript
const result = await showCustomFilePicker({
  multiple: true,      // 是否允许多选
  accept: 'image/*',   // 接受的文件类型
  directory: false,    // 是否选择文件夹
  title: '选择文件'    // 对话框标题
})

if (!result.cancelled) {
  console.log('选择的文件:', result.files)
}
```

**特性：**
- ✅ 自定义标题
- ✅ 文件类型过滤
- ✅ 单选/多选模式
- ✅ 文件夹模式支持
- ✅ 取消操作支持

### 2. showCustomImagePicker - 图片选择器

```typescript
const files = await showCustomImagePicker(true)  // true = 多选
if (files.length > 0) {
  // 处理选择的图片
}
```

**特性：**
- ✅ 专门为图片优化
- ✅ 自动设置 accept='image/*'
- ✅ 适合的图标和文案

### 3. showCustomFolderPicker - 文件夹选择器

```typescript
const files = await showCustomFolderPicker()
if (files.length > 0) {
  // 处理文件夹中的图片
}
```

**特性：**
- ✅ 文件夹模式
- ✅ 自动递归获取所有图片
- ✅ 清晰的文件夹图标

## 🎨 界面设计

### 对话框包含的元素

1. **标题栏**
   - 显示操作说明
   - 关闭按钮（✕）

2. **文件类型指示器**
   - 大图标（📁/📄）
   - 操作描述
   - 支持格式说明
   - 拖拽提示

3. **安全提示框**
   - 🔒 图标
   - 解释系统原生选择器的使用
   - 增强用户信任

4. **操作按钮**
   - "取消" - 关闭对话框
   - "浏览文件/选择文件夹" - 打开系统选择器

### 视觉特性

- **主题适配**：使用 CSS 变量适配网站主题
- **动画效果**：淡入/缩放动画
- **响应式**：适配不同屏幕尺寸
- **无障碍**：键盘导航支持（ESC 关闭）

## 📁 文件结构

```
src/content/utils/
├── customFilePicker.ts    # 自定义文件选择器实现
├── uploader.ts            # 使用自定义选择器的上传逻辑
├── dialog.ts              # alert/confirm/prompt 对话框
└── index.ts               # 统一导出
```

## 🔧 集成位置

在 `uploader.ts` 中的三个上传模式都使用了自定义选择器：

### 1. 常规上传
```typescript
dropZone.addEventListener('click', async () => {
  const files = await showCustomImagePicker(true)
  if (files.length > 0) {
    await handleFiles(files)
  }
})
```

### 2. 差分上传
```typescript
diffDropZone.addEventListener('click', async () => {
  const files = await showCustomImagePicker(true)
  if (files.length > 0) {
    await handleDiffFiles(files)
  }
})
```

### 3. 文件夹上传
```typescript
folderDropZone.addEventListener('click', async () => {
  const files = await showCustomFolderPicker()
  if (files.length > 0) {
    await handleFiles(files)
  }
})
```

## 🎯 技术细节

### 为什么仍需要原生input元素？

虽然我们创建了自定义UI，但出于浏览器安全限制：

1. **文件访问权限**
   - 只能通过用户主动触发的 `<input type="file">` 访问文件
   - JavaScript 无法直接读取文件系统

2. **安全沙箱**
   - 浏览器必须确保用户知道自己在选择文件
   - 防止恶意网站偷偷读取文件

3. **我们的方案**
   - 先显示友好的自定义对话框
   - 用户点击"浏览文件"后，才触发原生选择器
   - 原生选择器由浏览器完全控制，确保安全

### 工作流程

```
1. 用户点击上传区域
   ↓
2. 显示自定义对话框（我们的UI）
   - 说明操作
   - 显示选项
   - 可以取消
   ↓
3. 用户点击"浏览文件"
   ↓
4. 触发隐藏的 <input type="file">
   ↓
5. 浏览器显示系统原生选择器（安全保障）
   ↓
6. 用户选择文件
   ↓
7. 返回到我们的代码，开始上传
```

## 📊 对比

| 特性 | 原实现 | 新实现 |
|------|--------|--------|
| 点击即选择 | ✅ | ❌ 先显示对话框 |
| 操作说明 | ❌ | ✅ 详细说明 |
| 可取消 | ⚠️ 只能在选择器中取消 | ✅ 两次取消机会 |
| 视觉统一 | ❌ | ✅ 与其他对话框一致 |
| 安全提示 | ❌ | ✅ 解释原生选择器 |
| 拖拽提示 | ⚠️ 不明显 | ✅ 明确提示 |

## 🎨 界面预览

### 常规上传对话框
```
┌────────────────────────────────────┐
│ 选择图片文件                    ✕ │
├────────────────────────────────────┤
│                                    │
│           📄                       │
│                                    │
│      选择多个文件                  │
│    支持的格式：图片文件            │
│  提示：您也可以直接拖拽文件...    │
│                                    │
│ ┌────────────────────────────────┐│
│ │ 🔒 安全提示                    ││
│ │ 出于安全考虑，浏览器会使用...  ││
│ └────────────────────────────────┘│
│                                    │
│               [取消] [浏览文件]   │
└────────────────────────────────────┘
```

### 文件夹上传对话框
```
┌────────────────────────────────────┐
│ 选择文件夹                      ✕ │
├────────────────────────────────────┤
│                                    │
│           📁                       │
│                                    │
│       选择文件夹                   │
│  将上传文件夹内的所有图片文件      │
│                                    │
│ ┌────────────────────────────────┐│
│ │ 🔒 安全提示                    ││
│ │ 出于安全考虑，浏览器会使用...  ││
│ └────────────────────────────────┘│
│                                    │
│               [取消] [选择文件夹] │
└────────────────────────────────────┘
```

## 🚀 使用示例

### 在其他地方使用

```typescript
import { showCustomImagePicker } from '@/content/utils'

// 选择图片
async function uploadImages() {
  const files = await showCustomImagePicker(true)
  
  if (files.length === 0) {
    console.log('用户取消了选择')
    return
  }
  
  console.log(`用户选择了 ${files.length} 个文件`)
  // 处理文件...
}
```

## 💡 未来改进

可能的增强功能：

1. **预览缩略图**
   - 在自定义对话框中显示最近选择的文件预览

2. **快捷选项**
   - "上次使用的位置"
   - "最近的文件"

3. **拖拽区域**
   - 在对话框中也支持拖拽

4. **多步骤向导**
   - 文件选择 → 文件预览 → 确认上传

5. **批量操作**
   - 文件重命名
   - 文件排序
   - 批量删除

## ✅ 总结

现在所有的文件选择都会经过我们的自定义UI：

- ✅ 更友好的用户界面
- ✅ 清晰的操作说明
- ✅ 统一的视觉风格
- ✅ 更好的用户体验
- ✅ 保持浏览器安全机制

虽然最终还是会打开系统原生选择器（浏览器安全要求），但现在用户会先看到一个友好的说明界面，明白自己在做什么，为什么会看到系统选择器。
