<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>常用表情测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .emoji-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .emoji-item {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .emoji-item:hover {
            background-color: #f0f0f0;
        }
        .favorites-group {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>常用表情功能测试</h1>
    
    <div class="test-section">
        <h2>测试说明</h2>
        <p>这个页面测试常用表情的智能使用计数功能：</p>
        <ul>
            <li>点击任何表情模拟使用</li>
            <li>首次使用会添加到常用，初始计数为1</li>
            <li>12小时内再次使用只增加计数</li>
            <li>超过12小时使用会应用0.8衰减系数</li>
            <li>常用按最近使用时间排序</li>
        </ul>
    </div>

    <div class="test-section favorites-group">
        <h2>常用表情 ⭐</h2>
        <div id="favorites-list" class="emoji-list">
            <em>暂无常用表情</em>
        </div>
    </div>

    <div class="test-section">
        <h2>Nachoneko表情包</h2>
        <div id="nachoneko-list" class="emoji-list"></div>
    </div>

    <div class="test-section">
        <h2>操作日志</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">清空日志</button>
        <button onclick="testDecay()">测试衰减（模拟12小时后使用）</button>
    </div>

    <script>
        // 模拟表情数据
        const testEmojis = [
            { id: 'neko-1', name: '瞌睡', url: 'https://linux.do/uploads/default/optimized/4X/5/9/f/59ffbc2c53dd2a07dc30d4368bd5c9e01ca57d80_2_490x500.jpeg' },
            { id: 'neko-2', name: '哭泣', url: 'https://linux.do/uploads/default/optimized/4X/5/d/9/5d932c05a642396335f632a370bd8d45463cf2e2_2_503x500.jpeg' },
            { id: 'neko-3', name: '疑问', url: 'https://linux.do/uploads/default/optimized/4X/f/a/a/faa5afe1749312bc4a326feff0eca6fb39355300_2_518x499.jpeg' },
            { id: 'neko-4', name: '干嘛', url: 'https://linux.do/uploads/default/optimized/4X/5/5/2/552f13479e7bff2ce047d11ad821da4963c467f2_2_500x500.jpeg' },
            { id: 'neko-5', name: '吃东西', url: 'https://linux.do/uploads/default/optimized/4X/0/d/1/0d125de02c201128bf6a3f78ff9450e48a3e27de_2_532x500.jpeg' },
            { id: 'neko-6', name: '是我', url: 'https://linux.do/uploads/default/optimized/4X/2/3/f/23fac94d8858a23cbd49879f2b037a2be020c87e_2_500x500.jpeg' }
        ];

        // 常用表情存储
        let favoritesGroup = {
            id: 'favorites',
            name: '常用',
            icon: '⭐',
            emojis: []
        };

        // 日志功能
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 常用表情智能管理逻辑（复制自实际代码）
        function addToFavorites(emoji) {
            const now = Date.now();
            const existingEmojiIndex = favoritesGroup.emojis.findIndex(e => e.url === emoji.url);
            
            if (existingEmojiIndex !== -1) {
                // 表情已在常用中，更新使用跟踪
                const existingEmoji = favoritesGroup.emojis[existingEmojiIndex];
                const lastUsed = existingEmoji.lastUsed || 0;
                const timeDiff = now - lastUsed;
                const twelveHours = 12 * 60 * 60 * 1000; // 12小时毫秒数
                
                if (timeDiff < twelveHours) {
                    // 少于12小时，只增加计数
                    existingEmoji.usageCount = (existingEmoji.usageCount || 0) + 1;
                    log(`更新计数: ${emoji.name}, 新计数: ${existingEmoji.usageCount}`);
                } else {
                    // 超过12小时，应用衰减并更新时间戳
                    const currentCount = existingEmoji.usageCount || 1;
                    existingEmoji.usageCount = Math.floor(currentCount * 0.8) + 1;
                    existingEmoji.lastUsed = now;
                    log(`应用衰减: ${emoji.name}, 旧计数: ${currentCount}, 新计数: ${existingEmoji.usageCount}`);
                }
            } else {
                // 添加新表情到常用
                const favoriteEmoji = {
                    ...emoji,
                    id: `fav-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                    groupId: 'favorites',
                    usageCount: 1,
                    lastUsed: now,
                    addedAt: now
                };
                
                favoritesGroup.emojis.push(favoriteEmoji);
                log(`添加新常用: ${emoji.name}, 计数: 1`);
            }
            
            // 按lastUsed排序（最近使用的在前）
            favoritesGroup.emojis.sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0));
            
            updateFavoritesDisplay();
        }

        // 更新常用表情显示
        function updateFavoritesDisplay() {
            const favoritesDiv = document.getElementById('favorites-list');
            
            if (favoritesGroup.emojis.length === 0) {
                favoritesDiv.innerHTML = '<em>暂无常用表情</em>';
                return;
            }
            
            favoritesDiv.innerHTML = favoritesGroup.emojis.map((emoji, index) => {
                const lastUsedTime = emoji.lastUsed ? new Date(emoji.lastUsed).toLocaleTimeString() : '未知';
                return `
                    <div class="emoji-item" onclick="useEmoji('${emoji.id}', true)">
                        <img src="${emoji.url}" alt="${emoji.name}" width="32" height="32" style="display: block;">
                        <div>${emoji.name}</div>
                        <div>计数: ${emoji.usageCount || 0}</div>
                        <div>最后使用: ${lastUsedTime}</div>
                    </div>
                `;
            }).join('');
        }

        // 更新Nachoneko表情显示
        function updateNachoNekoDisplay() {
            const nachoNekoDiv = document.getElementById('nachoneko-list');
            
            nachoNekoDiv.innerHTML = testEmojis.map(emoji => `
                <div class="emoji-item" onclick="useEmoji('${emoji.id}', false)">
                    <img src="${emoji.url}" alt="${emoji.name}" width="32" height="32" style="display: block;">
                    <div>${emoji.name}</div>
                </div>
            `).join('');
        }

        // 模拟使用表情
        function useEmoji(emojiId, isFavorite) {
            let emoji;
            
            if (isFavorite) {
                emoji = favoritesGroup.emojis.find(e => e.id === emojiId);
            } else {
                emoji = testEmojis.find(e => e.id === emojiId);
            }
            
            if (emoji) {
                log(`使用表情: ${emoji.name}`);
                addToFavorites(emoji);
            }
        }

        // 测试衰减功能（模拟12小时后使用）
        function testDecay() {
            if (favoritesGroup.emojis.length === 0) {
                log('没有常用表情可以测试衰减');
                return;
            }
            
            const emoji = favoritesGroup.emojis[0];
            const twelveHoursAgo = Date.now() - (12 * 60 * 60 * 1000 + 1000); // 12小时+1秒前
            emoji.lastUsed = twelveHoursAgo;
            
            log(`设置 ${emoji.name} 的最后使用时间为12小时前`);
            useEmoji(emoji.id, true);
        }

        // 初始化页面
        function init() {
            updateFavoritesDisplay();
            updateNachoNekoDisplay();
            log('页面初始化完成');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>