<!DOCTYPE html>
<html>
<head>
  <title>æ‰¹é‡è¡¨æƒ…æ·»åŠ  - æ‰‹åŠ¨æµ‹è¯•</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      padding: 20px; 
      background: #f8fafc;
    }
    .container { 
      max-width: 1000px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 12px; 
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      color: white;
      padding: 24px;
      text-align: center;
    }
    .test-section { 
      margin: 20px; 
      padding: 20px; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px;
      background: #f9fafb;
    }
    .emoji-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
      gap: 12px; 
      margin: 20px 0;
    }
    .emoji-item { 
      width: 100px; 
      height: 100px; 
      border: 2px solid #d1d5db; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      cursor: pointer; 
      background: white;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-size: 24px;
      position: relative;
    }
    .emoji-item:hover { 
      border-color: #8b5cf6; 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    }
    .emoji-item.selected { 
      border-color: #8b5cf6; 
      background: #f3e8ff;
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
    }
    .emoji-item.success {
      border-color: #10b981;
      background: #dcfce7;
    }
    .emoji-item.error {
      border-color: #ef4444;
      background: #fecaca;
    }
    .controls { 
      margin: 20px 0; 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap;
    }
    button { 
      padding: 10px 20px; 
      background: #4f46e5; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-weight: 500;
      transition: background 0.2s ease;
    }
    button:hover { background: #3730a3; }
    button:disabled { 
      background: #9ca3af; 
      cursor: not-allowed; 
    }
    button.danger { background: #dc2626; }
    button.danger:hover { background: #b91c1c; }
    button.success { background: #059669; }
    button.success:hover { background: #047857; }
    .status { 
      padding: 16px; 
      margin: 16px 0; 
      background: #f0f9ff; 
      border-left: 4px solid #0ea5e9; 
      border-radius: 0 6px 6px 0;
      font-weight: 500;
    }
    .status.selecting {
      background: #f3e8ff;
      border-left-color: #8b5cf6;
    }
    .status.processing {
      background: #fef3c7;
      border-left-color: #f59e0b;
    }
    .progress-container {
      margin: 20px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .progress-bar {
      width: 100%; 
      height: 24px; 
      background: #e5e7eb; 
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%; 
      background: linear-gradient(135deg, #10b981, #059669); 
      border-radius: 12px; 
      transition: width 0.3s ease;
      position: relative;
    }
    .progress-text {
      margin-top: 12px;
      text-align: center;
      font-weight: 500;
      color: #374151;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    .stat-item {
      text-align: center;
      padding: 16px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .stat-number {
      font-size: 28px;
      font-weight: bold;
      color: #1f2937;
    }
    .stat-label {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }
    .mfp-simulation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .mfp-content-sim {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      position: relative;
    }
    .mfp-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ æ‰¹é‡è¡¨æƒ…æ·»åŠ åŠŸèƒ½æµ‹è¯•</h1>
      <p>æ¨¡æ‹Ÿ Magnific Popup ç¯å¢ƒä¸­çš„æ‰¹é‡è¡¨æƒ…æ·»åŠ åŠŸèƒ½</p>
    </div>
    
    <div class="test-section">
      <h3>ğŸ–¼ï¸ æ¨¡æ‹Ÿè¡¨æƒ…å›¾ç‰‡é€‰æ‹©</h3>
      <p>ç‚¹å‡»ä¸‹æ–¹è¡¨æƒ…è¿›è¡Œé€‰æ‹©ï¼Œæ¨¡æ‹Ÿåœ¨å›¾ç‰‡æŸ¥çœ‹å™¨ä¸­æ‰¹é‡é€‰æ‹©è¡¨æƒ…çš„åœºæ™¯</p>
      
      <div class="controls">
        <button onclick="toggleSelectionMode()" id="toggleBtn">è¿›å…¥é€‰æ‹©æ¨¡å¼</button>
        <button onclick="selectAll()" id="selectAllBtn" disabled>å…¨é€‰</button>
        <button onclick="clearSelection()" id="clearBtn" disabled>æ¸…ç©ºé€‰æ‹©</button>
        <button onclick="startBatchProcess()" id="processBtn" disabled class="success">å¼€å§‹æ‰¹é‡æ·»åŠ </button>
        <button onclick="simulateMagnificPopup()">æ¨¡æ‹Ÿå¼¹çª—</button>
      </div>
      
      <div class="emoji-grid" id="emojiGrid">
        <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <div class="status" id="status">
        çŠ¶æ€ï¼šç­‰å¾…æ“ä½œ... ç‚¹å‡»"è¿›å…¥é€‰æ‹©æ¨¡å¼"å¼€å§‹
      </div>
    </div>

    <div class="test-section">
      <h3>ğŸ“Š å¤„ç†è¿›åº¦ä¸ç»Ÿè®¡</h3>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="selectedCount">0</div>
          <div class="stat-label">å·²é€‰æ‹©</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="successCount">0</div>
          <div class="stat-label">æˆåŠŸ</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="errorCount">0</div>
          <div class="stat-label">å¤±è´¥</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="totalProcessed">0</div>
          <div class="stat-label">æ€»å¤„ç†</div>
        </div>
      </div>
      
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
        <div class="progress-text" id="progressText">è¿›åº¦ï¼š0/0 (0%)</div>
      </div>
    </div>

    <div class="test-section">
      <h3>ğŸ”§ åŠŸèƒ½è¯´æ˜</h3>
      <ul>
        <li><strong>é€‰æ‹©æ¨¡å¼ï¼š</strong>ç‚¹å‡»"è¿›å…¥é€‰æ‹©æ¨¡å¼"åï¼Œå¯ä»¥ç‚¹å‡»è¡¨æƒ…è¿›è¡Œé€‰æ‹©</li>
        <li><strong>æ‰¹é‡æ“ä½œï¼š</strong>é€‰æ‹©è¡¨æƒ…åï¼Œç‚¹å‡»"å¼€å§‹æ‰¹é‡æ·»åŠ "æ¨¡æ‹Ÿå‘é€åˆ°æ‰©å±•åå°</li>
        <li><strong>å®æ—¶åé¦ˆï¼š</strong>å¤„ç†è¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºè¿›åº¦æ¡å’ŒçŠ¶æ€å˜åŒ–</li>
        <li><strong>é”™è¯¯å¤„ç†ï¼š</strong>æ¨¡æ‹Ÿ20%çš„å¤±è´¥ç‡ï¼Œæµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶</li>
        <li><strong>å¼¹çª—æ¨¡æ‹Ÿï¼š</strong>ç‚¹å‡»"æ¨¡æ‹Ÿå¼¹çª—"ä½“éªŒçœŸå®çš„æ¨¡æ€æ¡†ç¯å¢ƒ</li>
      </ul>
    </div>
  </div>

  <!-- æ¨¡æ‹Ÿ Magnific Popup -->
  <div class="mfp-simulation" id="mfpModal">
    <div class="mfp-content-sim">
      <button class="mfp-close" onclick="closeMagnificPopup()">Ã—</button>
      <h2>æ¨¡æ‹Ÿ Magnific Popup å›¾ç‰‡æŸ¥çœ‹å™¨</h2>
      <p>è¿™é‡Œæ¨¡æ‹Ÿäº†çœŸå®çš„å›¾ç‰‡æŸ¥çœ‹å™¨ç¯å¢ƒï¼Œæ‰¹é‡æ·»åŠ æŒ‰é’®åº”è¯¥å‡ºç°åœ¨æ­¤ç±»æ¨¡æ€æ¡†ä¸­</p>
      <div class="emoji-grid" id="modalEmojiGrid">
        <!-- æ¨¡æ€æ¡†ä¸­çš„è¡¨æƒ… -->
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <button onclick="closeMagnificPopup()">å…³é—­æ¨¡æ€æ¡†</button>
      </div>
    </div>
  </div>

  <script>
    // æ¨¡æ‹ŸChromeæ‰©å±•ç¯å¢ƒ
    window.chrome = {
      runtime: {
        sendMessage: async (message) => {
          console.log('ğŸ“¤ å‘é€æ¶ˆæ¯åˆ° background script:', message);
          
          // æ¨¡æ‹ŸéšæœºæˆåŠŸ/å¤±è´¥ï¼ˆ80%æˆåŠŸç‡ï¼‰
          const success = Math.random() > 0.2;
          const delay = 100 + Math.random() * 300; // éšæœºå»¶è¿Ÿ100-400ms
          
          return new Promise((resolve) => {
            setTimeout(() => {
              if (success) {
                resolve({ 
                  success: true, 
                  emoji: { 
                    UUID: 'test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    displayName: message.emojiData.displayName,
                    realUrl: message.emojiData.realUrl.href,
                    addTime: Date.now()
                  }
                });
              } else {
                resolve({ 
                  success: false, 
                  error: 'æ¨¡æ‹Ÿçš„ç½‘ç»œé”™è¯¯æˆ–å­˜å‚¨å¤±è´¥' 
                });
              }
            }, delay);
          });
        }
      }
    };

    // æµ‹è¯•çŠ¶æ€
    let isSelecting = false;
    let selectedEmojis = new Set();
    let isProcessing = false;
    let stats = {
      selected: 0,
      success: 0,
      error: 0,
      total: 0
    };

    // ç”Ÿæˆæµ‹è¯•è¡¨æƒ…æ•°æ®
    const testEmojis = [
      { emoji: 'ğŸ˜€', name: 'ç¬‘è„¸è¡¨æƒ…' },
      { emoji: 'â¤ï¸', name: 'çˆ±å¿ƒè¡¨æƒ…' },
      { emoji: 'ğŸ˜®', name: 'æƒŠè®¶è¡¨æƒ…' },
      { emoji: 'ğŸ˜¢', name: 'å“­æ³£è¡¨æƒ…' },
      { emoji: 'ğŸ˜ ', name: 'ç”Ÿæ°”è¡¨æƒ…' },
      { emoji: 'ğŸ¤”', name: 'æ€è€ƒè¡¨æƒ…' },
      { emoji: 'ğŸ˜', name: 'é…·ç‚«è¡¨æƒ…' },
      { emoji: 'ğŸ¥³', name: 'åº†ç¥è¡¨æƒ…' },
      { emoji: 'ğŸ˜´', name: 'ç¡è§‰è¡¨æƒ…' },
      { emoji: 'ğŸ¤—', name: 'æ‹¥æŠ±è¡¨æƒ…' },
      { emoji: 'ğŸ™„', name: 'ç¿»ç™½çœ¼è¡¨æƒ…' },
      { emoji: 'ğŸ˜‹', name: 'ç¾å‘³è¡¨æƒ…' },
      { emoji: 'ğŸ¥°', name: 'çˆ±å¿ƒçœ¼è¡¨æƒ…' },
      { emoji: 'ğŸ˜', name: 'å¾—æ„è¡¨æƒ…' },
      { emoji: 'ğŸ¤¯', name: 'çˆ†ç‚¸è¡¨æƒ…' },
      { emoji: 'ğŸ¥º', name: 'è¯·æ±‚è¡¨æƒ…' }
    ];

    // ç”Ÿæˆè¡¨æƒ…ç½‘æ ¼
    function generateEmojiGrid(containerId = 'emojiGrid') {
      const grid = document.getElementById(containerId);
      grid.innerHTML = '';

      testEmojis.forEach((emoji, index) => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.dataset.index = index;
        item.dataset.name = emoji.name;
        item.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 32px; margin-bottom: 4px;">${emoji.emoji}</div>
            <div style="font-size: 10px; color: #6b7280;">${emoji.name}</div>
          </div>
        `;
        
        if (containerId === 'emojiGrid') {
          item.onclick = () => toggleEmojiSelection(index);
        }
        
        grid.appendChild(item);
      });
    }

    // åˆ‡æ¢è¡¨æƒ…é€‰æ‹©çŠ¶æ€
    function toggleEmojiSelection(index) {
      if (!isSelecting || isProcessing) return;

      const item = document.querySelector(`[data-index="${index}"]`);
      if (selectedEmojis.has(index)) {
        selectedEmojis.delete(index);
        item.classList.remove('selected');
      } else {
        selectedEmojis.add(index);
        item.classList.add('selected');
      }

      updateStats();
      updateUI();
    }

    // åˆ‡æ¢é€‰æ‹©æ¨¡å¼
    function toggleSelectionMode() {
      if (isProcessing) return;
      
      isSelecting = !isSelecting;
      
      if (!isSelecting) {
        clearSelection();
      }
      
      updateUI();
    }

    // å…¨é€‰
    function selectAll() {
      if (!isSelecting || isProcessing) return;
      
      testEmojis.forEach((_, index) => {
        selectedEmojis.add(index);
        const item = document.querySelector(`[data-index="${index}"]`);
        item.classList.add('selected');
      });
      
      updateStats();
      updateUI();
    }

    // æ¸…ç©ºé€‰æ‹©
    function clearSelection() {
      selectedEmojis.clear();
      document.querySelectorAll('.emoji-item').forEach(item => {
        item.classList.remove('selected', 'success', 'error');
      });
      updateStats();
      updateUI();
    }

    // å¼€å§‹æ‰¹é‡å¤„ç†
    async function startBatchProcess() {
      if (selectedEmojis.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¡¨æƒ…ï¼');
        return;
      }

      if (isProcessing) {
        alert('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
        return;
      }

      isProcessing = true;
      stats.success = 0;
      stats.error = 0;
      stats.total = selectedEmojis.size;
      
      // æ˜¾ç¤ºè¿›åº¦æ¡
      document.getElementById('progressContainer').style.display = 'block';
      
      let completed = 0;
      updateProgress(0, stats.total);

      console.log(`ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç† ${stats.total} ä¸ªè¡¨æƒ…`);

      for (const index of selectedEmojis) {
        const item = document.querySelector(`[data-index="${index}"]`);
        const emojiData = testEmojis[index];
        
        // é‡ç½®çŠ¶æ€
        item.classList.remove('success', 'error');
        
        try {
          console.log(`ğŸ“¤ å¤„ç†è¡¨æƒ…: ${emojiData.name}`);
          
          const result = await chrome.runtime.sendMessage({
            action: 'addEmojiFromWeb',
            emojiData: {
              displayName: emojiData.name,
              realUrl: new URL(`https://example.com/emojis/${emojiData.name.replace(/è¡¨æƒ…$/, '')}.png`)
            }
          });

          if (result.success) {
            stats.success++;
            item.classList.add('success');
            console.log(`âœ… æˆåŠŸæ·»åŠ : ${emojiData.name}`, result.emoji);
          } else {
            stats.error++;
            item.classList.add('error');
            console.log(`âŒ æ·»åŠ å¤±è´¥: ${emojiData.name}`, result.error);
          }
        } catch (error) {
          stats.error++;
          item.classList.add('error');
          console.log(`âŒ ç½‘ç»œé”™è¯¯: ${emojiData.name}`, error);
        }

        completed++;
        updateProgress(completed, stats.total);
        updateStats();
        
        // æ·»åŠ å°å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°å¤„ç†è¿‡ç¨‹
        await new Promise(resolve => setTimeout(resolve, 150));
      }

      // å¤„ç†å®Œæˆ
      isProcessing = false;
      console.log(`ğŸ‰ æ‰¹é‡å¤„ç†å®Œæˆï¼æˆåŠŸ: ${stats.success}, å¤±è´¥: ${stats.error}`);
      
      alert(`æ‰¹é‡å¤„ç†å®Œæˆï¼\nâœ… æˆåŠŸï¼š${stats.success}/${stats.total}\nâŒ å¤±è´¥ï¼š${stats.error}/${stats.total}`);
      
      // 3ç§’åè‡ªåŠ¨éšè—è¿›åº¦æ¡
      setTimeout(() => {
        document.getElementById('progressContainer').style.display = 'none';
      }, 3000);
      
      updateUI();
    }

    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress(completed, total) {
      const percentage = total > 0 ? (completed / total) * 100 : 0;
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = 
        `è¿›åº¦ï¼š${completed}/${total} (${Math.round(percentage)}%)`;
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats() {
      stats.selected = selectedEmojis.size;
      
      document.getElementById('selectedCount').textContent = stats.selected;
      document.getElementById('successCount').textContent = stats.success;
      document.getElementById('errorCount').textContent = stats.error;
      document.getElementById('totalProcessed').textContent = stats.success + stats.error;
    }

    // æ›´æ–°UIçŠ¶æ€
    function updateUI() {
      const toggleBtn = document.getElementById('toggleBtn');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const clearBtn = document.getElementById('clearBtn');
      const processBtn = document.getElementById('processBtn');
      const status = document.getElementById('status');

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      if (isProcessing) {
        toggleBtn.textContent = 'å¤„ç†ä¸­...';
        toggleBtn.disabled = true;
        selectAllBtn.disabled = true;
        clearBtn.disabled = true;
        processBtn.disabled = true;
        processBtn.textContent = 'å¤„ç†ä¸­...';
        
        status.textContent = `çŠ¶æ€ï¼šæ­£åœ¨æ‰¹é‡å¤„ç† ${stats.total} ä¸ªè¡¨æƒ…...`;
        status.className = 'status processing';
      } else if (isSelecting) {
        toggleBtn.textContent = 'é€€å‡ºé€‰æ‹©æ¨¡å¼';
        toggleBtn.className = 'danger';
        selectAllBtn.disabled = false;
        clearBtn.disabled = false;
        processBtn.disabled = selectedEmojis.size === 0;
        processBtn.textContent = `å¼€å§‹æ‰¹é‡æ·»åŠ  (${selectedEmojis.size})`;
        
        status.textContent = `çŠ¶æ€ï¼šé€‰æ‹©æ¨¡å¼ - å·²é€‰æ‹© ${selectedEmojis.size} ä¸ªè¡¨æƒ…`;
        status.className = 'status selecting';
      } else {
        toggleBtn.textContent = 'è¿›å…¥é€‰æ‹©æ¨¡å¼';
        toggleBtn.className = '';
        selectAllBtn.disabled = true;
        clearBtn.disabled = true;
        processBtn.disabled = true;
        processBtn.textContent = 'å¼€å§‹æ‰¹é‡æ·»åŠ ';
        
        status.textContent = 'çŠ¶æ€ï¼šç­‰å¾…æ“ä½œ... ç‚¹å‡»"è¿›å…¥é€‰æ‹©æ¨¡å¼"å¼€å§‹';
        status.className = 'status';
      }
    }

    // æ¨¡æ‹Ÿ Magnific Popup
    function simulateMagnificPopup() {
      const modal = document.getElementById('mfpModal');
      modal.style.display = 'flex';
      generateEmojiGrid('modalEmojiGrid');
      
      // æ·»åŠ æ¨¡æ€æ¡†ç‰¹æœ‰çš„ç±»åï¼Œæ¨¡æ‹ŸçœŸå®ç¯å¢ƒ
      modal.classList.add('mfp-wrap');
      modal.querySelector('.mfp-content-sim').classList.add('mfp-content');
    }

    function closeMagnificPopup() {
      document.getElementById('mfpModal').style.display = 'none';
    }

    // åˆå§‹åŒ–
    function init() {
      generateEmojiGrid();
      updateStats();
      updateUI();
      
      console.log('ğŸ¯ æ‰¹é‡è¡¨æƒ…æ·»åŠ æµ‹è¯•é¡µé¢å·²åŠ è½½');
      console.log('ğŸ“– ä½¿ç”¨è¯´æ˜ï¼š');
      console.log('1. ç‚¹å‡»"è¿›å…¥é€‰æ‹©æ¨¡å¼"æ¿€æ´»é€‰æ‹©åŠŸèƒ½');
      console.log('2. ç‚¹å‡»è¡¨æƒ…è¿›è¡Œé€‰æ‹©/å–æ¶ˆé€‰æ‹©');
      console.log('3. ç‚¹å‡»"å¼€å§‹æ‰¹é‡æ·»åŠ "æ¨¡æ‹Ÿå‘é€åˆ°æ‰©å±•åå°');
      console.log('4. è§‚å¯Ÿè¿›åº¦æ¡å’ŒçŠ¶æ€å˜åŒ–');
      console.log('5. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—äº†è§£è¯¦ç»†å¤„ç†è¿‡ç¨‹');
    }

    // å¯åŠ¨åº”ç”¨
    init();

    // æ¨¡æ‹Ÿæ‰©å±•ç¯å¢ƒæ£€æµ‹
    setTimeout(() => {
      if (window.chrome && window.chrome.runtime) {
        console.log('âœ… Chrome æ‰©å±•ç¯å¢ƒæ¨¡æ‹ŸæˆåŠŸ');
      } else {
        console.warn('âš ï¸ æœªæ£€æµ‹åˆ° Chrome æ‰©å±•ç¯å¢ƒ');
      }
    }, 1000);
  </script>
</body>
</html>