# Popup到Options页面表情同步修复实现计划

本文档将修复popup到options页面表情数据同步问题的设计转换为一系列可执行的编码任务。每个任务都专注于编写、修改或测试代码，确保修复当前的数据不一致问题。

## 1. 修复缓存机制问题

- [x] **1.1 修复emojiGroupsStore中的缓存失效机制**


  - 修改 `src/data/update/emojiGroupsStore.ts` 中的 `recordUsageByUUID` 函数
  - 确保在记录表情使用后立即清除热门表情缓存
  - 验证 `cachedHotEmojis.data = null` 和 `cachedHotEmojis.timestamp = 0` 的执行
  - 添加调试日志确认缓存清除操作
  - 编写单元测试验证缓存清除机制
  - _需求: 1.1, 1.4, 6.1_






- [ ] **1.2 增强getHotEmojis的强制刷新功能**
  - 修改 `src/data/update/emojiGroupsStore.ts` 中的 `getHotEmojis` 函数
  - 确保当 `forceRefresh=true` 时完全忽略缓存
  - 添加更详细的调试日志显示缓存状态和数据重新计算过程
  - 验证热门表情的排序和数量计算逻辑
  - 编写单元测试验证强制刷新功能

  - _需求: 1.1, 2.1, 2.2_








## 2. 修复Options页面数据刷新问题



- [ ] **2.1 增强HotTab的消息处理机制**
  - 修改 `src/options/tabs/HotTab.vue` 中的 `usageRecordedHandler` 函数
  - 确保接收到使用记录消息时立即清除所有相关缓存


  - 强制调用 `store.getHot(true)` 重新加载数据，不依赖缓存
  - 添加详细的调试日志跟踪数据刷新过程
  - 编写单元测试验证消息处理逻辑
  - _需求: 5.1, 5.3_


- [ ] **2.2 实现强制数据重新加载机制**
  - 在 `src/options/tabs/HotTab.vue` 中增强 `refreshHotData` 函数
  - 添加数据一致性验证，比较刷新前后的数据差异


  - 实现错误处理和重试机制，确保数据加载成功
  - 添加加载状态指示器，提供用户反馈

  - 编写单元测试验证强制重新加载功能
  - _需求: 5.1, 5.2, 6.4_










## 3. 修复存储同步问题







- [ ] **3.1 验证saveCommonEmojiGroup的执行**
  - 检查 `src/data/update/storage.ts` 中的 `saveCommonEmojiGroup` 函数
  - 确保在 `recordUsageByUUID` 成功后立即调用此函数
  - 验证localStorage和Chrome Storage的同步写入

  - 添加详细的调试日志跟踪存储操作
  - 编写单元测试验证存储同步功能



  - _需求: 6.1, 6.2_

- [ ] **3.2 增强存储错误处理和重试机制**




  - 修改 `src/data/update/storage.ts` 中的存储操作


  - 实现存储失败时的自动重试机制
  - 添加存储操作的错误日志和用户提示
  - 实现存储一致性检查，确保数据同步成功
  - 编写单元测试验证错误处理机制



  - _需求: 6.3, 6.4_

## 4. 验证Popup页面的数据更新逻辑



- [ ] **4.1 验证Popup页面的表情使用记录流程**
  - 检查 `src/popup/PopupApp.vue` 中的 `onEmojiClick` 函数
  - 确保 `recordUsage(e.UUID)` 调用成功

  - 验证 `commService.sendUsageRecorded(e.UUID)` 消息发送
  - 确保popup页面自身的UI立即更新（`hot.value = store.getHot(true)`）
  - 编写单元测试验证popup页面的更新流程
  - _需求: 1.1, 1.2_

- [ ] **4.2 增强Popup页面的错误处理**
  - 在 `src/popup/PopupApp.vue` 中增强错误处理逻辑



  - 添加使用记录失败时的回退机制
  - 实现UI更新失败时的重试逻辑
  - 添加用户友好的错误提示
  - 编写单元测试验证错误处理机制
  - _需求: 1.1, 6.4_

## 5. 数据一致性验证和测试

- [ ] **5.1 实现数据一致性验证工具**
  - 创建数据一致性检查函数，比较popup和options页面的热门表情数据
  - 实现localStorage和Chrome Storage数据对比工具
  - 添加数据差异报告和调试信息
  - 创建手动触发的数据同步修复功能
  - 编写单元测试验证数据一致性检查
  - _需求: 2.1, 2.2, 6.2_

- [ ] **5.2 实现端到端测试验证修复效果**
  - 创建端到端测试模拟popup页面使用表情的完整流程
  - 验证options页面能立即显示相同数量的热门表情
  - 测试浏览器刷新后数据的持久化效果
  - 验证错误场景下的数据恢复机制
  - 编写自动化测试确保修复的稳定性
  - _需求: 1.1, 2.1, 6.3_

## 6. 问题修复验证

- [ ] **6.1 创建问题复现和验证测试**
  - 创建测试用例复现当前的问题（popup显示6个，options显示5个）
  - 实现自动化测试验证修复后的数据一致性
  - 创建性能测试确保修复不影响系统性能
  - 添加回归测试防止问题再次出现
  - 编写用户验收测试确保修复效果
  - _需求: 1.1, 2.1, 2.2_

- [ ] **6.2 实现监控和调试工具**
  - 创建实时数据监控面板，显示popup和options页面的数据状态
  - 实现数据同步状态的可视化工具
  - 添加详细的调试日志和错误追踪
  - 创建手动触发数据同步的调试功能
  - 编写文档说明如何使用调试工具
  - _需求: 6.1, 6.2, 6.4_