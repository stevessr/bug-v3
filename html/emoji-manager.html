<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>表情管理器 - Emoji Extension Manager</title>
    <script type="module" src="/src/emoji-manager.ts"></script>
    <style>
      .emoji-grid {
        display: grid;
        gap: 8px;
        padding: 16px;
      }
      .emoji-item {
        width: 48px;
        height: 48px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
      }
      .emoji-item:hover {
        border-color: #1890ff;
        transform: scale(1.1);
      }
      .group-header {
        background: #f5f5f5;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        border-left: 4px solid #1890ff;
      }
      .management-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <a-layout style="min-height: 100vh">
        <!-- Header -->
        <a-layout-header style="background: #001529; padding: 0">
          <div
            style="
              color: white;
              padding: 0 24px;
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <h1 style="color: white; margin: 0; font-size: 18px">🐈‍⬛ 表情管理器</h1>
            <div>
              <a-button @click="exportData" style="margin-right: 8px">导出数据</a-button>
              <a-button @click="showImportModal = true" type="primary">导入数据</a-button>
            </div>
          </div>
        </a-layout-header>

        <a-layout>
          <!-- Sidebar -->
          <a-layout-sider width="200" style="background: #fff">
            <a-menu
              v-model:selectedKeys="selectedKeys"
              mode="inline"
              style="height: 100%; border-right: 0"
            >
              <a-menu-item key="groups" @click="activeTab = 'groups'">
                <span>📁 分组管理</span>
              </a-menu-item>
              <a-menu-item key="settings" @click="activeTab = 'settings'">
                <span>⚙️ 设置</span>
              </a-menu-item>
              <a-menu-item key="favorites" @click="activeTab = 'favorites'">
                <span>⭐ 收藏夹</span>
              </a-menu-item>
              <a-menu-item key="import" @click="activeTab = 'import'">
                <span>📥 外部导入</span>
              </a-menu-item>
              <a-menu-item key="ai-rename" @click="activeTab = 'ai-rename'">
                <span>🤖 AI 重命名</span>
              </a-menu-item>
              <a-menu-item key="export" @click="activeTab = 'export'">
                <span>📤 导出/同步</span>
              </a-menu-item>
            </a-menu>
          </a-layout-sider>

          <!-- Content -->
          <a-layout-content style="margin: 24px 16px; padding: 24px; background: #f0f2f5">
            <!-- Groups Management -->
            <div v-if="activeTab === 'groups'">
              <div class="management-section">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 16px;
                  "
                >
                  <h2>表情分组管理</h2>
                  <a-button type="primary" @click="showCreateGroupModal = true">创建分组</a-button>
                </div>

                <!-- Groups List -->
                <a-list :data-source="emojiGroups" item-layout="vertical">
                  <template #renderItem="{ item: group }">
                    <a-list-item>
                      <template #actions>
                        <a @click="editGroup(group)">编辑</a>
                        <a @click="deleteGroup(group.id)">删除</a>
                        <a @click="showAddEmojiModal(group.id)">添加表情</a>
                      </template>

                      <div class="group-header">
                        <h3 style="margin: 0; display: flex; align-items: center">
                          <span style="margin-right: 8px; font-size: 18px">{{ group.icon }}</span>
                          {{ group.name }}
                          <a-tag style="margin-left: 8px">
                            {{ group.emojis?.length || 0 }} 个表情
                          </a-tag>
                        </h3>
                      </div>

                      <!-- Emojis Grid -->
                      <div
                        class="emoji-grid"
                        :style="{gridTemplateColumns: `repeat(${settings.gridColumns}, 1fr)`}"
                      >
                        <img
                          v-for="emoji in group.emojis"
                          :key="emoji.packet || emoji.name"
                          :src="emoji.url"
                          :alt="emoji.name"
                          :title="emoji.name"
                          class="emoji-item"
                          @click="editEmoji(emoji, group.id)"
                          @error="handleImageError"
                        />
                      </div>
                    </a-list-item>
                  </template>
                </a-list>
              </div>
            </div>

            <!-- Settings -->
            <div v-if="activeTab === 'settings'" class="management-section">
              <h2>全局设置</h2>

              <a-form layout="vertical">
                <a-row :gutter="16">
                  <a-col :span="12">
                    <a-form-item label="图片缩放比例">
                      <a-slider
                        v-model:value="settings.imageScale"
                        :min="5"
                        :max="150"
                        :step="5"
                        :marks="{30: '30%', 50: '50%', 100: '100%'}"
                      />
                      <div>当前: {{ settings.imageScale }}%</div>
                    </a-form-item>
                  </a-col>
                  <a-col :span="12">
                    <a-form-item label="网格列数">
                      <a-slider
                        v-model:value="settings.gridColumns"
                        :min="2"
                        :max="8"
                        :step="1"
                        :marks="{2: '2', 4: '4', 6: '6', 8: '8'}"
                      />
                    </a-form-item>
                  </a-col>
                </a-row>

                <a-form-item label="输出格式">
                  <a-radio-group v-model:value="settings.outputFormat">
                    <a-radio value="markdown">Markdown</a-radio>
                    <a-radio value="html">HTML</a-radio>
                  </a-radio-group>
                </a-form-item>

                <a-form-item>
                  <a-checkbox v-model:checked="settings.showSearchBar">显示搜索栏</a-checkbox>
                </a-form-item>

                <a-form-item>
                  <a-checkbox v-model:checked="settings.forceMobileMode">强制移动端模式</a-checkbox>
                </a-form-item>

                <a-form-item>
                  <a-button type="primary" @click="saveSettings">保存设置</a-button>
                </a-form-item>
              </a-form>
            </div>

            <!-- Favorites -->
            <div v-if="activeTab === 'favorites'" class="management-section">
              <h2>收藏夹</h2>
              <div
                v-if="favorites.length === 0"
                style="text-align: center; color: #999; padding: 40px"
              >
                还没有收藏的表情
              </div>
              <div
                v-else
                class="emoji-grid"
                :style="{gridTemplateColumns: `repeat(${settings.gridColumns}, 1fr)`}"
              >
                <img
                  v-for="emoji in favorites"
                  :key="emoji.id"
                  :src="emoji.url"
                  :alt="emoji.name"
                  :title="emoji.name"
                  class="emoji-item"
                  @click="removeFromFavorites(emoji.id)"
                />
              </div>
            </div>

            <!-- Export/Sync -->
            <div v-if="activeTab === 'export'" class="management-section">
              <h2>数据导出与同步</h2>

              <a-space direction="vertical" style="width: 100%">
                <div>
                  <h3>用户脚本同步</h3>
                  <p>将当前数据同步到用户脚本的localStorage中</p>
                  <a-button type="primary" @click="syncToUserscript">同步到用户脚本</a-button>
                </div>

                <a-divider />

                <div>
                  <h3>数据导出</h3>
                  <p>导出完整的表情数据以便备份或分享</p>
                  <a-space>
                    <a-button @click="exportData">导出 JSON</a-button>
                    <a-button @click="exportForUserscript">导出用户脚本数据</a-button>
                  </a-space>
                </div>

                <a-divider />

                <div>
                  <h3>数据导入</h3>
                  <p>从备份文件或其他来源导入表情数据</p>
                  <a-button @click="showImportModal = true">导入数据</a-button>
                </div>
              </a-space>
            </div>

            <!-- External Import -->
            <div v-if="activeTab === 'import'" class="management-section">
              <h2>外部表情导入</h2>
              
              <a-space direction="vertical" style="width: 100%" size="large">
                <div>
                  <h3>🎭 Tenor GIF 导入</h3>
                  <p>从 Tenor 搜索并导入 GIF 表情</p>
                  <a-space>
                    <a-input 
                      v-model:value="tenorSearchQuery" 
                      placeholder="搜索 GIF..." 
                      @keyup.enter="searchTenorGifs"
                      style="width: 300px"
                    />
                    <a-button type="primary" @click="searchTenorGifs" :loading="tenorLoading">
                      搜索
                    </a-button>
                  </a-space>
                  
                  <div v-if="tenorResults.length > 0" style="margin-top: 16px">
                    <div class="emoji-grid" :style="{gridTemplateColumns: 'repeat(4, 1fr)'}">
                      <div v-for="gif in tenorResults" :key="gif.id" class="tenor-gif-item">
                        <img 
                          :src="gif.media_formats.tinygif.url" 
                          :alt="gif.content_description"
                          style="width: 100%; height: 100px; object-fit: cover; border-radius: 4px; cursor: pointer"
                          @click="importTenorGif(gif)"
                        />
                        <div style="text-align: center; font-size: 12px; margin-top: 4px">
                          {{ gif.content_description?.slice(0, 20) || 'GIF' }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <a-divider />

                <div>
                  <h3>💬 Waline 表情导入</h3>
                  <p>从 Waline 表情包导入表情</p>
                  <a-form layout="vertical">
                    <a-form-item label="Waline 表情包 URL">
                      <a-input 
                        v-model:value="walineUrl" 
                        placeholder="https://example.com/waline-emojis.json"
                      />
                    </a-form-item>
                    <a-form-item>
                      <a-button type="primary" @click="importWalineEmojis" :loading="walineLoading">
                        导入 Waline 表情
                      </a-button>
                    </a-form-item>
                  </a-form>
                </div>

                <a-divider />

                <div>
                  <h3>📁 本地文件导入</h3>
                  <p>从本地文件批量导入表情</p>
                  <a-upload
                    multiple
                    :file-list="[]"
                    :before-upload="handleLocalImport"
                    accept="image/*"
                  >
                    <a-button>
                      <span>选择图片文件</span>
                    </a-button>
                  </a-upload>
                </div>
              </a-space>
            </div>

            <!-- AI Rename -->
            <div v-if="activeTab === 'ai-rename'" class="management-section">
              <h2>🤖 AI 智能重命名</h2>
              <p>使用 AI 识别表情内容，自动生成合适的表情名称</p>
              
              <a-space direction="vertical" style="width: 100%" size="large">
                <!-- AI Provider Selection -->
                <div>
                  <h3>选择 AI 提供商</h3>
                  <a-form layout="vertical">
                    <a-form-item label="AI 服务商">
                      <a-select v-model:value="aiProvider" style="width: 300px" @change="onAiProviderChange">
                        <a-select-option value="gemini">Google Gemini</a-select-option>
                        <a-select-option value="openai">OpenAI</a-select-option>
                        <a-select-option value="claude">Anthropic Claude</a-select-option>
                        <a-select-option value="openai-compatible">OpenAI 兼容 API</a-select-option>
                        <a-select-option v-if="chromeAiAvailable" value="chrome-ai">Chrome AI</a-select-option>
                        <a-select-option v-if="edgeAiAvailable" value="edge-ai">Edge AI</a-select-option>
                      </a-select>
                    </a-form-item>
                    
                    <a-form-item v-if="!isLocalAi(aiProvider)" label="API Key">
                      <a-input-password 
                        v-model:value="aiApiKey" 
                        placeholder="输入 API Key"
                        style="width: 400px"
                      />
                    </a-form-item>
                    
                    <a-form-item v-if="aiProvider === 'openai-compatible'" label="API Base URL">
                      <a-input 
                        v-model:value="aiBaseUrl" 
                        placeholder="https://api.example.com/v1"
                        style="width: 400px"
                      />
                    </a-form-item>
                    
                    <a-form-item v-if="aiProvider === 'openai-compatible'" label="模型名称">
                      <a-input 
                        v-model:value="aiModel" 
                        placeholder="gpt-4-vision-preview"
                        style="width: 400px"
                      />
                    </a-form-item>
                  </a-form>
                </div>

                <a-divider />

                <!-- Emoji Selection -->
                <div>
                  <h3>选择要重命名的表情</h3>
                  <div v-if="emojiGroups.length === 0" style="text-align: center; color: #999; padding: 40px">
                    暂无表情分组
                  </div>
                  <div v-else>
                    <a-space wrap>
                      <a-tag 
                        v-for="group in emojiGroups" 
                        :key="group.id"
                        :color="selectedGroupForRename === group.id ? 'blue' : 'default'"
                        style="cursor: pointer; margin-bottom: 8px"
                        @click="selectGroupForRename(group.id)"
                      >
                        {{ group.icon }} {{ group.name }} ({{ group.emojis?.length || 0 }})
                      </a-tag>
                    </a-space>
                    
                    <div v-if="selectedGroupForRename" style="margin-top: 16px">
                      <h4>选择表情:</h4>
                      <div class="emoji-grid" :style="{gridTemplateColumns: 'repeat(6, 1fr)'}">
                        <div 
                          v-for="emoji in getSelectedGroupEmojis()" 
                          :key="emoji.id || emoji.name"
                          class="emoji-item"
                          :style="{
                            border: selectedEmojisForRename.includes(emoji) ? '2px solid #1890ff' : '2px solid transparent',
                            cursor: 'pointer'
                          }"
                          @click="toggleEmojiSelection(emoji)"
                        >
                          <img 
                            :src="emoji.url" 
                            :alt="emoji.name"
                            style="width: 48px; height: 48px; object-fit: cover; border-radius: 4px"
                          />
                          <div style="text-align: center; font-size: 10px; margin-top: 2px">
                            {{ emoji.name?.slice(0, 8) || 'Unknown' }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <a-divider />

                <!-- Rename Action -->
                <div>
                  <h3>执行重命名</h3>
                  <a-space>
                    <a-button 
                      type="primary" 
                      :disabled="!canStartRename()" 
                      @click="startAiRename"
                      :loading="aiRenameLoading"
                    >
                      🤖 开始 AI 重命名
                    </a-button>
                    <a-text type="secondary">
                      已选择 {{ selectedEmojisForRename.length }} 个表情
                    </a-text>
                  </a-space>
                  
                  <!-- Progress -->
                  <div v-if="aiRenameProgress.total > 0" style="margin-top: 16px">
                    <a-progress 
                      :percent="Math.round((aiRenameProgress.completed / aiRenameProgress.total) * 100)"
                      :status="aiRenameLoading ? 'active' : 'success'"
                    />
                    <div style="text-align: center; margin-top: 8px">
                      {{ aiRenameProgress.completed }} / {{ aiRenameProgress.total }} 已完成
                    </div>
                  </div>
                </div>

                <!-- Rename Results -->
                <div v-if="renameResults.length > 0">
                  <h3>重命名结果</h3>
                  <a-list :data-source="renameResults" item-layout="horizontal">
                    <template #renderItem="{ item: result }">
                      <a-list-item>
                        <template #actions>
                          <a @click="applyRename(result)">应用</a>
                          <a @click="rejectRename(result)">拒绝</a>
                        </template>
                        <a-list-item-meta>
                          <template #avatar>
                            <img :src="result.emoji.url" style="width: 32px; height: 32px; border-radius: 4px" />
                          </template>
                          <template #title>
                            <div>
                              原名称: <strong>{{ result.emoji.name }}</strong>
                            </div>
                          </template>
                          <template #description>
                            <div>
                              <div>AI 建议:</div>
                              <a-space wrap>
                                <a-tag 
                                  v-for="(suggestion, index) in result.suggestions" 
                                  :key="index"
                                  :color="result.selectedSuggestion === index ? 'blue' : 'default'"
                                  style="cursor: pointer"
                                  @click="selectSuggestion(result, index)"
                                >
                                  {{ suggestion }}
                                </a-tag>
                              </a-space>
                            </div>
                          </template>
                        </a-list-item-meta>
                      </a-list-item>
                    </template>
                  </a-list>
                </div>
              </a-space>
            </div>
            
          </a-layout-content>
        </a-layout>
      </a-layout>

      <!-- Create Group Modal -->
      <a-modal v-model:open="showCreateGroupModal" title="创建分组" @ok="createGroup">
        <a-form layout="vertical">
          <a-form-item label="分组名称" required>
            <a-input v-model:value="newGroup.name" placeholder="输入分组名称" />
          </a-form-item>
          <a-form-item label="分组图标">
            <a-input v-model:value="newGroup.icon" placeholder="输入图标或emoji" />
          </a-form-item>
        </a-form>
      </a-modal>

      <!-- Edit Group Modal -->
      <a-modal v-model:open="showEditGroupModal" title="编辑分组" @ok="updateGroup">
        <a-form layout="vertical">
          <a-form-item label="分组名称" required>
            <a-input v-model:value="editingGroup.name" placeholder="输入分组名称" />
          </a-form-item>
          <a-form-item label="分组图标">
            <a-input v-model:value="editingGroup.icon" placeholder="输入图标或emoji" />
          </a-form-item>
        </a-form>
      </a-modal>

      <!-- Add Emoji Modal -->
      <a-modal v-model:open="showAddEmojiModal" title="添加表情" @ok="addEmoji">
        <a-form layout="vertical">
          <a-form-item label="表情名称" required>
            <a-input v-model:value="newEmoji.name" placeholder="输入表情名称" />
          </a-form-item>
          <a-form-item label="图片URL" required>
            <a-input v-model:value="newEmoji.url" placeholder="输入图片链接" />
          </a-form-item>
          <a-form-item v-if="newEmoji.url">
            <img :src="newEmoji.url" style="max-width: 100px; max-height: 100px" />
          </a-form-item>
        </a-form>
      </a-modal>

      <!-- Import Modal -->
      <a-modal v-model:open="showImportModal" title="导入数据" @ok="importData">
        <a-form layout="vertical">
          <a-form-item label="数据格式">
            <a-radio-group v-model:value="importFormat">
              <a-radio value="json">JSON 格式</a-radio>
              <a-radio value="userscript">用户脚本格式</a-radio>
            </a-radio-group>
          </a-form-item>
          <a-form-item label="数据内容">
            <a-textarea v-model:value="importData" :rows="10" placeholder="粘贴要导入的数据" />
          </a-form-item>
        </a-form>
      </a-modal>
    </div>
    <script type="module" src="/src/emoji-manager.ts"></script>
  </body>
</html>
