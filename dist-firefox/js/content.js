const e={emojiGroups:[],settings:{imageScale:30,gridColumns:4,outputFormat:"markdown",forceMobileMode:!1,defaultGroup:"nachoneko",showSearchBar:!0}};async function t(){try{console.log("[Emoji Extension] Requesting emoji data from background");const n=await(t={type:"GET_EMOJI_DATA"},new Promise(e=>{try{window.chrome&&window.chrome.runtime&&window.chrome.runtime.sendMessage?window.chrome.runtime.sendMessage(t,t=>{e(t)}):e({success:!1,error:"chrome.runtime.sendMessage not available"})}catch(n){e({success:!1,error:n instanceof Error?n.message:String(n)})}}));if(n&&n.success&&n.data){const t=n.data.groups||[],o=n.data.settings||{};if(console.log("[Emoji Extension] Received groups from background:",t?.length||0),Array.isArray(t)&&t.length>0){let n=0,o=0;t.forEach(e=>{e&&e.emojis&&Array.isArray(e.emojis)&&(n++,o+=e.emojis.length)}),n>0&&o>0?(e.emojiGroups=t,console.log(`[Emoji Extension] Successfully loaded ${n} valid groups with ${o} total emojis (from background)`)):(console.warn("[Emoji Extension] Groups exist but contain no valid emojis, using defaults (from background)"),e.emojiGroups=[])}else console.warn("[Emoji Extension] No valid emoji groups found in background response, using defaults"),e.emojiGroups=[];o&&"object"==typeof o&&(e.settings={...e.settings,...o},console.log("[Emoji Extension] Loaded settings (from background):",e.settings))}else console.warn("[Emoji Extension] Background did not return emoji data, falling back to defaults"),e.emojiGroups=[],e.settings={imageScale:30,gridColumns:4,outputFormat:"markdown",forceMobileMode:!1,defaultGroup:"nachoneko",showSearchBar:!0};let o=0;e.emojiGroups.forEach(e=>{e?.emojis?.length&&(o+=e.emojis.length)}),console.log("[Emoji Extension] Final cache state (from background):",{groupsCount:e.emojiGroups.length,emojisCount:o,settings:e.settings})}catch(n){console.error("[Emoji Extension] Failed to load from background (module):",n),e.emojiGroups=[],e.settings={imageScale:30,gridColumns:4,outputFormat:"markdown",forceMobileMode:!1,defaultGroup:"nachoneko",showSearchBar:!0}}var t}function n(e){if(!e)return!1;let t=e.trim();if(/^url\(/i.test(t)){const e=t.replace(/^url\(/i,"").replace(/\)$/,"").trim();t=e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1).trim():e}if(t.startsWith("data:image/"))return!0;if(t.startsWith("blob:"))return!0;if(t.startsWith("//")&&(t="https:"+t),/\.(png|jpe?g|gif|webp|svg|avif|bmp|ico)(\?.*)?$/i.test(t))return!0;try{const e=new URL(t),n=e.protocol;if("http:"===n||"https:"===n||n.endsWith(":")){if(/\.(png|jpe?g|gif|webp|svg|avif|bmp|ico)(\?.*)?$/i.test(e.pathname))return!0;if(/format=|ext=|type=image|image_type=/i.test(e.search))return!0}}catch{}return!1}function o(e,t){const n=document.createElement(e);if(t){if(t.wi&&(n.style.width=t.wi),t.he&&(n.style.height=t.he),t.class&&(n.className=t.class),t.text&&(n.textContent=t.text),t.ph&&"placeholder"in n&&(n.placeholder=t.ph),t.type&&"type"in n&&(n.type=t.type),void 0!==t.val&&"value"in n&&(n.value=t.val),t.style&&(n.style.cssText=t.style),t.src&&"src"in n&&(n.src=t.src),t.attrs)for(const e in t.attrs)n.setAttribute(e,t.attrs[e]);if(t.dataset)for(const e in t.dataset)n.dataset[e]=t.dataset[e];if(t.in&&(n.innerHTML=t.in),t.ti&&(n.title=t.ti),t.alt&&"alt"in n&&(n.alt=t.alt),t.id&&(n.id=t.id),t.accept&&"accept"in n&&(n.accept=t.accept),void 0!==t.multiple&&"multiple"in n&&(n.multiple=t.multiple),t.role&&n.setAttribute("role",t.role),void 0!==t.tabIndex&&(n.tabIndex=Number(t.tabIndex)),t.ld&&"loading"in n&&(n.loading=t.ld),t.on)for(const[e,o]of Object.entries(t.on))n.addEventListener(e,o)}return n}var i=[{id:"nachoneko",name:"é»˜è®¤",icon:"ğŸ˜º",order:0,emojis:[]}];async function r(){return i}function s(){Array.isArray(e.emojiGroups)&&0!==e.emojiGroups.length||(e.emojiGroups=[{id:"default",name:"é»˜è®¤è¡¨æƒ…",icon:"ğŸ˜€",order:0,emojis:r()}])}function a(t){const n=t;try{chrome.runtime.sendMessage({action:"addToFavorites",emoji:t})}catch(d){try{chrome.runtime.sendMessage({action:"addToFavorites",emoji:t})}catch(u){}}const o=document.querySelector("textarea.d-editor-input"),i=document.querySelector(".ProseMirror.d-editor-input");if(!o&&!i)return void console.warn("æ‰¾ä¸åˆ°è¾“å…¥æ¡†");const r=n.url?.match(/_(\d{3,})x(\d{3,})\./);let s="500",a="500";r?(s=r[1],a=r[2]):n.width&&n.height&&(s=n.width.toString(),a=n.height.toString());const c=e&&e.settings&&e.settings.imageScale||30,l=e&&e.settings&&e.settings.outputFormat||"markdown";if(o){let e="";if("html"===l){const t=Math.max(1,Math.round(Number(s)*(c/100))),o=Math.max(1,Math.round(Number(a)*(c/100)));e=`<img src="${n.url}" title=":${n.name}:" class="emoji only-emoji" alt=":${n.name}:" loading="lazy" width="${t}" height="${o}" style="aspect-ratio: ${t} / ${o};"> `}else e=`![${n.name}|${s}x${a},${c}%](${n.url}) `;const t=o.selectionStart,i=o.selectionEnd;o.value=o.value.substring(0,t)+e+o.value.substring(i,o.value.length),o.selectionStart=o.selectionEnd=t+e.length,o.focus();const r=new Event("input",{bubbles:!0,cancelable:!0});o.dispatchEvent(r)}else if(i){const e=Number(s)||500,t=Math.max(1,Math.round(e*(c/100))),o=`<img src="${n.url}" alt="${n.name}" width="${s}" height="${a}" data-scale="${c}" style="width: ${t}px">`;try{const e=new DataTransfer;e.setData("text/html",o);const t=new ClipboardEvent("paste",{clipboardData:e,bubbles:!0});i.dispatchEvent(t)}catch(d){try{document.execCommand("insertHTML",!1,o)}catch(p){console.warn("æ— æ³•å‘å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ä¸­æ’å…¥è¡¨æƒ…",p)}}}}async function c(){s();const t=e.emojiGroups,i=o("div",{class:"fk-d-menu -animated -expanded",attrs:{"data-identifier":"emoji-picker",role:"dialog"},style:"max-width: 400px; visibility: visible; z-index: 999999;"}),r=o("div",{class:"fk-d-menu__inner-content"}),c=o("div",{class:"emoji-picker"}),l=o("div",{class:"emoji-picker__filter-container"}),d=o("div",{class:"emoji-picker__filter filter-input-container"}),u=o("input",{class:"filter-input",ph:"æŒ‰è¡¨æƒ…ç¬¦å·åç§°æœç´¢â€¦",type:"text"});d.appendChild(u),l.appendChild(d);const p=o("div",{class:"emoji-picker__content"}),m=o("div",{class:"emoji-picker__sections-nav"}),g=o("div",{class:"emoji-picker__scrollable-content"}),f=o("div",{class:"emoji-picker__sections"});f.setAttribute("role","button"),t.forEach((t,r)=>{if(!t?.emojis?.length)return;const s=document.createElement("button");s.className="btn no-text btn-flat emoji-picker__section-btn "+(0===r?"active":""),s.setAttribute("tabindex","-1"),s.setAttribute("data-section",t.id),s.type="button";const c=t.icon||"ğŸ“";if(n(c)){const e=o("img",{src:c,alt:t.name||"",class:"emoji-group-icon",style:"\n          width: 18px;\n          height: 18px;\n          object-fit: contain;\n        "});s.appendChild(e)}else s.textContent=String(c);s.title=t.name,s.addEventListener("click",()=>{m.querySelectorAll(".emoji-picker__section-btn").forEach(e=>e.classList.remove("active")),s.classList.add("active");const e=f.querySelector(`[data-section="${t.id}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"start"})}),m.appendChild(s);const l=o("div",{class:"emoji-picker__section",attrs:{"data-section":t.id,role:"region","aria-label":t.name}}),d=o("div",{class:"emoji-picker__section-title-container"}),u=o("h2",{class:"emoji-picker__section-title"});u.textContent=t.name,d.appendChild(u);const p=o("div",{class:"emoji-picker__section-emojis"});let g=0;if(t.emojis.forEach(t=>{if(!t||"object"!=typeof t||!t.url||!t.name)return;const n=o("img",{style:"\n        cursor: pointer;\n         width: 32px; \n         height: 32px;\n          object-fit: contain;",class:"emoji",src:t.url,alt:t.name,ti:`:${t.name}:`,attrs:{tabindex:"0","data-emoji":t.name,loading:"lazy"},on:{click:()=>{a(t),i.remove()}}});n.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),a(t),i.remove())});try{e&&e.settings&&e.settings.enableHoverPreview&&(n.addEventListener("mouseenter",e=>{try{w(),function(e,t){const n=w(),o=n.querySelector("img"),i=n.querySelector(".emoji-desktop-hover-preview-label");o&&(o.src=t.displayUrl||t.url||"");i&&(i.textContent=t.name||"");v(e),n.style.display="",n.style.opacity="1";try{b&&(window.clearTimeout(b),b=null),y&&(window.clearTimeout(y),y=null)}catch(r){}b=window.setTimeout(()=>{try{h&&(h.style.opacity="0")}catch(r){}},5e3),y=window.setTimeout(()=>{try{x()}catch(r){}},7e3)}(e,t)}catch(n){}}),n.addEventListener("mousemove",e=>{try{v(e)}catch(t){}}),n.addEventListener("mouseleave",()=>{try{x()}catch(e){}}))}catch(r){}p.appendChild(n),g++}),0===g){const e=o("div",{class:"emoji-picker__no-emojis-message",attrs:{role:"note","aria-live":"polite"},text:`${t.name} ç»„æš‚æ— æœ‰æ•ˆè¡¨æƒ…`,style:"padding: 20px; text-align: center; color: #999;"});p.appendChild(e)}l.appendChild(d),l.appendChild(p),f.appendChild(l)}),u.addEventListener("input",e=>{const t=(e.target.value||"").toLowerCase();f.querySelectorAll("img").forEach(e=>{const n=e.getAttribute("data-emoji")?.toLowerCase()||"";e.style.display=""===t||n.includes(t)?"":"none"}),f.querySelectorAll(".emoji-picker__section").forEach(e=>{const t=e.querySelectorAll('img:not([style*="none"])'),n=e.querySelector(".emoji-picker__section-title-container");n&&(n.style.display=t.length>0?"":"none")})}),g.appendChild(f),p.appendChild(m),p.appendChild(g),c.appendChild(l),c.appendChild(p),r.appendChild(c),i.appendChild(r);let h=null,b=null,y=null;function w(){if(h)return h;const e=o("div",{class:"emoji-desktop-hover-preview",style:"\n        position: fixed;\n        pointer-events: none;\n        z-index: 999999;\n        padding: 6px;\n        border-radius: 6px;\n        background: transparent;\n        color: inherit;\n        border: 1px solid rgba(0,0,0,0.08);\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 6px;\n        max-width: 360px;\n        max-height: 360px;\n        overflow: hidden;\n      "}),t=o("img",{class:"emoji-desktop-hover-preview-img",style:"\n        max-width: 320px;\n        max-height: 320px;\n        display: block;\n        border-radius: 4px;\n        object-fit: contain;\n      "});e.appendChild(t);const n=o("div",{class:"emoji-desktop-hover-preview-label",style:"\n        font-size: 12px;\n        line-height: 1;\n        max-width: 320px;\n        white-space: nowrap;\n        text-overflow: ellipsis;\n        overflow: hidden;\n      "});return e.appendChild(n),document.body.appendChild(e),h=e,h.style.opacity="1",h.style.transition="opacity 2s linear",e}function v(e){if(!h)return;const t=12,n=h.offsetWidth,o=h.offsetHeight;let i=e.clientX+t,r=e.clientY+t;const s=window.innerWidth,a=window.innerHeight;i+n+t>s&&(i=Math.max(t,e.clientX-n-t)),r+o+t>a&&(r=Math.max(t,e.clientY-o-t)),h.style.left=`${i}px`,h.style.top=`${r}px`}function x(){if(h)try{try{b&&(window.clearTimeout(b),b=null),y&&(window.clearTimeout(y),y=null)}catch(e){}h.parentElement&&h.parentElement.removeChild(h)}finally{h=null}}return i}async function l(t){return console.log("[Emoji Extension] Creating picker for isMobileView:",t),t?async function(){s();const t=e.emojiGroups,i=o("div",{class:"modal d-modal fk-d-menu-modal emoji-picker-content",role:"dialog",attrs:{"data-keyboard":"false","aria-modal":"true","data-controller":"emoji-picker"}}),r=o("div",{class:"d-modal__container"}),c=o("div",{class:"d-modal__body",attrs:{tabIndex:"-1"}}),l=o("div",{class:"emoji-picker"}),d=o("div",{class:"emoji-picker__filter-container"}),u=o("div",{class:"emoji-picker__filter filter-input-container"}),p=o("input",{class:"filter-input",ph:"æŒ‰è¡¨æƒ…ç¬¦å·åç§°å’Œåˆ«åæœç´¢â€¦",type:"text"});u.appendChild(p);const m=o("button",{class:"btn no-text btn-icon btn-transparent emoji-picker__close-btn",type:"button",in:'<svg class="fa d-icon d-icon-xmark svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#xmark"></use></svg>',on:{click:()=>{i.remove()}}});d.appendChild(u),d.appendChild(m);const g=o("div",{class:"emoji-picker__content"}),f=o("div",{class:"emoji-picker__sections-nav"}),h=o("div",{class:"emoji-picker__scrollable-content"}),b=o("div",{class:"emoji-picker__sections",attrs:{role:"button"}});return t.forEach((e,t)=>{if(!e?.emojis?.length)return;const r=o("button",{class:"btn no-text btn-flat emoji-picker__section-btn "+(0===t?"active":""),attrs:{tabindex:"-1","data-section":e.id},type:"button",ti:e.name,on:{click:()=>{f.querySelectorAll(".emoji-picker__section-btn").forEach(e=>e.classList.remove("active")),r.classList.add("active");const t=b.querySelector(`[data-section="${e.id}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}}}),s=e.icon||"ğŸ“";if(n(s)){const t=o("img",{src:s,alt:e.name||"",class:"emoji",style:"\n          width: 18px,\n          height: 18px,\n          objectFit: contain\n        "});r.appendChild(t)}else r.textContent=String(s);f.appendChild(r);const c=o("div",{class:"emoji-picker__section",role:"region",attrs:{"data-section":e.id,"aria-label":e.name}}),l=o("div",{class:"emoji-picker__section-title-container"}),d=o("h2",{class:"emoji-picker__section-title",attrs:{textContent:e.name}});l.appendChild(d);const u=o("div",{class:"emoji-picker__section-emojis"});e.emojis.forEach(e=>{if(!e||"object"!=typeof e||!e.url||!e.name)return;const t=o("img",{src:e.url,alt:e.name,class:"emoji",style:"\n          width: 32px,\n          height: 32px,\n          object-fit: contain;\n        ",tabIndex:0,dataset:{emoji:e.name},ti:`:${e.name}:`,ld:"lazy",on:{click:()=>{a(e),i.remove()},keydown:t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),a(e),i.remove())}}});u.appendChild(t)}),c.appendChild(l),c.appendChild(u),b.appendChild(c)}),p.addEventListener("input",e=>{const t=(e.target.value||"").toLowerCase();b.querySelectorAll("img").forEach(e=>{const n=(e.dataset.emoji||"").toLowerCase();e.style.display=""===t||n.includes(t)?"":"none"}),b.querySelectorAll(".emoji-picker__section").forEach(e=>{const t=e.querySelectorAll('img:not([style*="display: none"])');e.style.display=t.length>0?"":"none"})}),h.appendChild(b),g.appendChild(f),g.appendChild(h),l.appendChild(d),l.appendChild(g),c.appendChild(l),r.appendChild(c),i.appendChild(r),i}():c()}async function d(e,t){const n=function(){try{const e=document.querySelector('meta[name="csrf-token"]');if(e&&e.content)return e.content;const t=document.querySelector('input[name="authenticity_token"]');if(t&&t.value)return t.value;const n=document.cookie.match(/csrf_token=([^;]+)/);if(n)return decodeURIComponent(n[1])}catch(e){console.warn("[timingsBinder] failed to read csrf token",e)}return null}()||"",o={};if(Array.isArray(t))for(let a=0;a<t.length;a++)o[a]=t[a];else for(const a of Object.keys(t)){const e=Number(a);Number.isNaN(e)||(o[e]=t[e])}const i=new URLSearchParams;let r=0;for(const a of Object.keys(o)){const e=Number(a),t=String(o[e]);i.append(`timings[${e}]`,t);const n=Number(t);!Number.isNaN(n)&&n>r&&(r=n)}i.append("topic_time",String(r)),i.append("topic_id",String(e));const s={"content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest"};n&&(s["x-csrf-token"]=n);for(let a=0;a<=5;a++){const e=await fetch("https://linux.do/topics/timings",{method:"POST",body:i.toString(),credentials:"same-origin",headers:s});if(429!==e.status)return e;if(5===a)return e;const t=e.headers.get("Retry-After");let n=0;if(t){const e=parseInt(t,10);if(Number.isNaN(e)){const e=Date.parse(t);Number.isNaN(e)||(n=Math.max(0,e-Date.now()))}else n=1e3*e}n||(n=500*Math.pow(2,a)+Math.floor(500*Math.random())),await new Promise(e=>setTimeout(e,n))}throw new Error("postTimings: unexpected execution path")}function u(e,t="info",n=4e3){try{let i=document.getElementById("emoji-ext-toast-container");i||(i=o("div",{id:"emoji-ext-toast-container",style:"\n          position: fixed;\n          right: 12px;\n          bottom: 12px;\n          z-index: 2147483647;\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n        "}),document.body.appendChild(i));const r=o("div",{text:e,style:"\n        padding: 8px 12px;\n        border-radius: 6px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.12);\n        color: #ffffff;\n        font-size: 13px;\n        max-width: 320px;\n        word-break: break-word;\n        opacity: 0;\n        transform: translateY(20px);\n      "});r.style.background="success"===t?"#16a34a":"error"===t?"#dc2626":"#0369a1",i.appendChild(r);const s=setTimeout(()=>{r.remove(),clearTimeout(s)},n);return()=>{r.remove(),clearTimeout(s)}}catch(i){try{alert(e)}catch(r){}return()=>{}}}function p(e){return new Promise(t=>setTimeout(t,e))}async function m(e,t=1){try{let o=e||0;if(!o){const e=window.location.pathname.match(/t\/topic\/(\d+)/),t=window.location.pathname.match(/t\/(\d+)/);if(e&&e[1])o=Number(e[1]);else if(t&&t[1])o=Number(t[1]);else{const e=document.querySelector("[data-topic-id]");e&&(o=Number(e.getAttribute("data-topic-id"))||0)}}if(!o)return void u("æ— æ³•æ¨æ–­ topic_idï¼Œè‡ªåŠ¨é˜…è¯»å–æ¶ˆ","error");u(`å¼€å§‹è‡ªåŠ¨é˜…è¯»è¯é¢˜ ${o} çš„æ‰€æœ‰å¸–å­...`,"info");const{posts:i,totalCount:r}=await async function(e){const t=`/t/${e}/posts.json`,n=await fetch(t,{credentials:"same-origin"});if(!n.ok)throw new Error(`failed to fetch posts.json: ${n.status}`);const o=await n.json();let i=[],r=0;return o&&o.post_stream&&Array.isArray(o.post_stream.posts)&&(i=o.post_stream.posts,i.length>0&&"number"==typeof i[0].posts_count&&(r=i[0].posts_count)),i&&0!==i.length||!o||!Array.isArray(o.posts)||(i=o.posts),r||(o&&"number"==typeof o.highest_post_number?r=o.highest_post_number:o&&"number"==typeof o.posts_count?r=o.posts_count:i&&i.length>0&&(r=i.length)),{posts:i,totalCount:r}}(o);if(!(i&&0!==i.length||r))return void u("æœªè·å–åˆ°ä»»ä½•å¸–å­æˆ–æ€»æ•°ä¿¡æ¯","error");const s=r||i.length,a=[];if(t>s)return void u(`èµ·å§‹å¸–å­å· ${t} è¶…è¿‡æ€»å¸–å­æ•° ${s}ï¼Œå·²è·³è¿‡`,"info");for(let e=t;e<=s;e++)a.push(e);const c=10;for(let e=0;e<a.length;e+=c){const t=a.slice(e,e+c),i={};for(const e of t)i[e]=1e4*Math.random();try{await d(o,i),u(`å·²æ ‡è®° ${Object.keys(i).length} ä¸ªå¸–å­ä¸ºå·²è¯»ï¼ˆå‘é€ï¼‰`,"success")}catch(n){u("å‘é€é˜…è¯»æ ‡è®°å¤±è´¥: "+(n&&n.message?n.message:String(n)),"error")}const r=500+Math.floor(1e3*Math.random());await p(r)}u("è‡ªåŠ¨é˜…è¯»å®Œæˆ","success")}catch(n){u("è‡ªåŠ¨é˜…è¯»å¼‚å¸¸: "+(n&&n.message?n.message:String(n)),"error")}}async function g(e){let t=e||0;if(!t){const e=window.location.pathname.match(/t\/topic\/(\d+)/),n=window.location.pathname.match(/t\/(\d+)/);if(e&&e[1])t=Number(e[1]);else if(n&&n[1])t=Number(n[1]);else{const e=Array.from(document.querySelectorAll("a[href]")),t=new Set;for(const n of e){const e=(n.getAttribute("href")||"").match(/^\/t\/topic\/(\d+)(?:\/(\d+))?$/);if(!e)continue;const o=Number(e[1]),i=e[2]?Number(e[2]):void 0,r=i&&!Number.isNaN(i)?i:2;o&&!t.has(o)&&(t.add(o),await m(o,r),await p(200))}}}}function f(e){const t=document.querySelector("textarea.d-editor-input"),n=document.querySelector(".ProseMirror.d-editor-input");if(t||n){if(t){const n=t.selectionStart,o=t.selectionEnd,i=t.value;t.value=i.substring(0,n)+e+i.substring(o),t.setSelectionRange(n+e.length,n+e.length),t.focus();const r=new Event("input",{bubbles:!0});t.dispatchEvent(r)}else if(n){const t=window.getSelection();if(t&&t.rangeCount>0){const n=t.getRangeAt(0),o=document.createTextNode(e);n.insertNode(o),n.setStartAfter(o),n.setEndAfter(o),t.removeAllRanges(),t.addRange(n)}n.focus()}}else console.error("æ‰¾ä¸åˆ°è¾“å…¥æ¡†")}window.autoReadAllReplies=m,window.autoReadAllRepliesV2=g;var h=new class{waitingQueue=[];uploadingQueue=[];failedQueue=[];successQueue=[];isProcessing=!1;maxRetries=2;progressDialog=null;async uploadImage(e){return new Promise((t,n)=>{const o={id:`upload_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,file:e,resolve:t,reject:n,retryCount:0,status:"waiting",timestamp:Date.now()};this.waitingQueue.push(o),this.updateProgressDialog(),this.processQueue()})}moveToQueue(e,t){switch(this.waitingQueue=this.waitingQueue.filter(t=>t.id!==e.id),this.uploadingQueue=this.uploadingQueue.filter(t=>t.id!==e.id),this.failedQueue=this.failedQueue.filter(t=>t.id!==e.id),this.successQueue=this.successQueue.filter(t=>t.id!==e.id),e.status=t,t){case"waiting":this.waitingQueue.push(e);break;case"uploading":this.uploadingQueue.push(e);break;case"failed":this.failedQueue.push(e);break;case"success":this.successQueue.push(e)}this.updateProgressDialog()}async processQueue(){if(!this.isProcessing&&0!==this.waitingQueue.length){for(this.isProcessing=!0;this.waitingQueue.length>0;){const t=this.waitingQueue.shift();if(t){this.moveToQueue(t,"uploading");try{const e=await this.performUpload(t.file);t.result=e,this.moveToQueue(t,"success"),t.resolve(e);f(`![${e.original_filename}](${e.url})`)}catch(e){t.error=e,this.shouldRetry(e,t)?(t.retryCount++,"rate_limit"===e.error_type&&e.extras?.wait_seconds?await this.sleep(1e3*e.extras.wait_seconds):await this.sleep(1e3*Math.pow(2,t.retryCount)),this.moveToQueue(t,"waiting")):(this.moveToQueue(t,"failed"),t.reject(e))}}}this.isProcessing=!1}}shouldRetry(e,t){return!(t.retryCount>=this.maxRetries)&&"rate_limit"===e.error_type}retryFailedItem(e){const t=this.failedQueue.find(t=>t.id===e);t&&t.retryCount<this.maxRetries&&(t.retryCount++,this.moveToQueue(t,"waiting"),this.processQueue())}showProgressDialog(){this.progressDialog||(this.progressDialog=this.createProgressDialog(),document.body.appendChild(this.progressDialog))}hideProgressDialog(){this.progressDialog&&(this.progressDialog.remove(),this.progressDialog=null)}updateProgressDialog(){if(!this.progressDialog)return;const e=[...this.waitingQueue,...this.uploadingQueue,...this.failedQueue,...this.successQueue];this.renderQueueItems(this.progressDialog,e)}async sleep(e){return new Promise(t=>setTimeout(t,e))}createProgressDialog(){const e=o("div",{style:"\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      width: 350px;\n      max-height: 400px;\n      background: white;\n      border-radius: 8px;\n      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);\n      z-index: 10000;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      border: 1px solid #e5e7eb;\n      overflow: hidden;\n    "}),t=o("div",{style:"\n      padding: 16px 20px;\n      background: #f9fafb;\n      border-bottom: 1px solid #e5e7eb;\n      font-weight: 600;\n      font-size: 14px;\n      color: #374151;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    ",text:"å›¾ç‰‡ä¸Šä¼ é˜Ÿåˆ—"}),n=o("button",{text:"âœ•",style:"\n      background: none;\n      border: none;\n      font-size: 16px;\n      cursor: pointer;\n      color: #6b7280;\n      padding: 4px;\n      border-radius: 4px;\n      transition: background-color 0.2s;\n    "});n.addEventListener("click",()=>{this.hideProgressDialog()}),n.addEventListener("mouseenter",()=>{n.style.backgroundColor="#e5e7eb"}),n.addEventListener("mouseleave",()=>{n.style.backgroundColor="transparent"}),t.appendChild(n);const i=o("div",{class:"upload-queue-content",style:"\n        max-height: 320px;\n        overflow-y: auto;\n        padding: 12px;\n      "});return e.appendChild(t),e.appendChild(i),e}renderQueueItems(e,t){const n=e.querySelector(".upload-queue-content");if(n){if(n.innerHTML="",0===t.length){const e=o("div",{style:"\n        text-align: center;\n        color: #6b7280;\n        font-size: 14px;\n        padding: 20px;\n      ",text:"æš‚æ— ä¸Šä¼ ä»»åŠ¡"});return void n.appendChild(e)}t.forEach(e=>{const t=o("div",{style:`\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 8px 12px;\n        margin-bottom: 8px;\n        background: #f9fafb;\n        border-radius: 6px;\n        border-left: 4px solid ${this.getStatusColor(e.status)};\n      `}),i=o("div",{style:"\n        flex: 1;\n        min-width: 0;\n      "}),r=o("div",{style:"\n        font-size: 13px;\n        font-weight: 500;\n        color: #374151;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      ",text:e.file.name}),s=o("div",{style:"\n        font-size: 12px;\n        color: #6b7280;\n        margin-top: 2px;\n      "});s.textContent=this.getStatusText(e),i.appendChild(r),i.appendChild(s);const a=o("div",{style:"\n          display: flex;\n          align-items: center;\n          gap: 8px;\n        "});if("failed"===e.status&&e.retryCount<this.maxRetries){const t=o("button",{text:"ğŸ”„",style:"\n            background: none;\n            border: none;\n            cursor: pointer;\n            font-size: 14px;\n            padding: 4px;\n            border-radius: 4px;\n            transition: background-color 0.2s;\n          ",ti:"é‡è¯•ä¸Šä¼ "});t.addEventListener("click",()=>{this.retryFailedItem(e.id)}),t.addEventListener("mouseenter",()=>{t.style.backgroundColor="#e5e7eb"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="transparent"}),a.appendChild(t)}const c=o("div",{style:"font-size: 16px;",text:this.getStatusIcon(e.status)});a.appendChild(c),t.appendChild(i),t.appendChild(a),n.appendChild(t)})}}getStatusColor(e){switch(e){case"waiting":return"#f59e0b";case"uploading":return"#3b82f6";case"success":return"#10b981";case"failed":return"#ef4444";default:return"#6b7280"}}getStatusText(e){switch(e.status){case"waiting":return"ç­‰å¾…ä¸Šä¼ ";case"uploading":return"æ­£åœ¨ä¸Šä¼ ...";case"success":return"ä¸Šä¼ æˆåŠŸ";case"failed":return"rate_limit"===e.error?.error_type?`ä¸Šä¼ å¤±è´¥ - è¯·æ±‚è¿‡äºé¢‘ç¹ (é‡è¯• ${e.retryCount}/${this.maxRetries})`:`ä¸Šä¼ å¤±è´¥ (é‡è¯• ${e.retryCount}/${this.maxRetries})`;default:return"æœªçŸ¥çŠ¶æ€"}}getStatusIcon(e){switch(e){case"waiting":return"â³";case"uploading":return"ğŸ“¤";case"success":return"âœ…";case"failed":return"âŒ";default:return"â“"}}async performUpload(e){const t=await this.calculateSHA1(e),n=new FormData;n.append("upload_type","composer"),n.append("relativePath","null"),n.append("name",e.name),n.append("type",e.type),n.append("sha1_checksum",t),n.append("file",e,e.name);const o={"X-Csrf-Token":this.getCSRFToken()};document.cookie&&(o.Cookie=document.cookie);const i=await fetch("https://linux.do/uploads.json?client_id=f06cb5577ba9410d94b9faf94e48c2d8",{method:"POST",headers:o,body:n});if(!i.ok)throw await i.json();return await i.json()}getCSRFToken(){const e=document.querySelector('meta[name="csrf-token"]');if(e)return e.content;const t=document.cookie.match(/csrf_token=([^;]+)/);if(t)return decodeURIComponent(t[1]);const n=document.querySelector('input[name="authenticity_token"]');return n?n.value:(console.warn("[Image Uploader] No CSRF token found"),"")}async calculateSHA1(e){const t=`${e.name}-${e.size}-${e.lastModified}`,n=(new TextEncoder).encode(t);if(crypto.subtle)try{const e=await crypto.subtle.digest("SHA-1",n);return Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")}catch(i){console.warn("[Image Uploader] Could not calculate SHA1, using fallback")}let o=0;for(let r=0;r<t.length;r++){o=(o<<5)-o+t.charCodeAt(r),o&=o}return Math.abs(o).toString(16).padStart(40,"0")}};async function b(){return new Promise(e=>{const{panel:t,overlay:n,dropZone:i,fileInput:r,closeButton:s,diffDropZone:a,diffFileInput:c,markdownTextarea:l}=function(){const e=o("div",{class:"drag-drop-upload-panel",style:"\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    width: 500px;\n    max-width: 90vw;\n    background: white;\n    border-radius: 12px;\n    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);\n    z-index: 10000;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  "}),t=o("div",{style:"\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.5);\n    z-index: 9999;\n  "}),n=o("div",{style:"\n      padding: 20px 24px 0;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    "}),i=o("h2",{text:"ä¸Šä¼ å›¾ç‰‡",style:"\n      margin: 0;\n      font-size: 18px;\n      font-weight: 600;\n      color: #111827;\n    "}),r=o("button",{in:"âœ•",style:"\n    background: none;\n    border: none;\n    font-size: 20px;\n    cursor: pointer;\n    color: #6b7280;\n    padding: 4px;\n    border-radius: 4px;\n    transition: background-color 0.2s;\n  "});r.addEventListener("mouseenter",()=>{r.style.backgroundColor="#f3f4f6"}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor="transparent"}),n.appendChild(i),n.appendChild(r);const s=o("div",{class:"upload-panel-content",style:"\n      padding: 24px;\n    "}),a=o("div",{style:"\n      display: flex;\n      border-bottom: 1px solid #e5e7eb;\n      margin-bottom: 20px;\n    "}),c=o("button",{text:"å¸¸è§„ä¸Šä¼ ",style:"\n      flex: 1;\n    padding: 10px 20px;\n    background: none;\n    border: none;\n    border-bottom: 2px solid #3b82f6;\n    color: #3b82f6;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s;\n  "}),l=o("button",{text:"å·®åˆ†ä¸Šä¼ ",style:"\n      flex: 1;\n    padding: 10px 20px;\n    background: none;\n    border: none;\n    border-bottom: 2px solid transparent;\n    color: #6b7280;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s;\n  "});a.appendChild(c),a.appendChild(l);const d=o("div",{class:"regular-upload-panel",style:"\n    display: block;\n  "}),u=o("div",{class:"drop-zone",style:"\n      border: 2px dashed #d1d5db;\n    border-radius: 8px;\n    padding: 40px 20px;\n    text-align: center;\n    background: #f9fafb;\n    transition: all 0.2s;\n    cursor: pointer;\n  "}),p=o("div",{in:"ğŸ“",style:"\n      font-size: 48px;\n      margin-bottom: 16px;\n    "}),m=o("div",{in:'\n    <div style="font-size: 16px; font-weight: 500; color: #374151; margin-bottom: 8px;">\n      æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶\n    </div>\n    <div style="font-size: 14px; color: #6b7280;">\n      æ”¯æŒ JPGã€PNGã€GIF ç­‰æ ¼å¼ï¼Œæœ€å¤§ 10MB\n    </div>\n  '});u.appendChild(p),u.appendChild(m);const g=o("input",{type:"file",accept:"image/*",multiple:!0,style:"\n      display: none;\n    "});d.appendChild(u),d.appendChild(g);const f=o("div",{class:"diff-upload-panel",style:"\n    display: none;\n  "}),h=o("textarea",{ph:"è¯·ç²˜è´´åŒ…å«å›¾ç‰‡çš„markdownæ–‡æœ¬...",style:"\n      width: 100%;\n      height: 120px;\n      padding: 12px;\n      border: 1px solid #d1d5db;\n      border-radius: 6px;\n      font-family: monospace;\n      font-size: 14px;\n      resize: vertical;\n      margin-bottom: 12px;\n      box-sizing: border-box;\n    "}),b=o("div",{class:"diff-drop-zone",style:"\n      border: 2px dashed #d1d5db;\n    border-radius: 8px;\n    padding: 30px 20px;\n    text-align: center;\n    background: #f9fafb;\n    transition: all 0.2s;\n    cursor: pointer;\n    margin-bottom: 12px;\n  "}),y=o("div",{in:"ğŸ“‹",style:"\n      font-size: 36px;\n      margin-bottom: 12px;\n    "}),w=o("div",{in:'\n    <div style="font-size: 16px; font-weight: 500; color: #374151; margin-bottom: 8px;">\n      é€‰æ‹©å›¾ç‰‡è¿›è¡Œå·®åˆ†ä¸Šä¼ \n    </div>\n    <div style="font-size: 14px; color: #6b7280;">\n      åªä¼šä¸Šä¼ ä¸åœ¨ä¸Šæ–¹markdownæ–‡æœ¬ä¸­çš„å›¾ç‰‡\n    </div>\n  '});b.appendChild(y),b.appendChild(w);const v=o("input",{type:"file",accept:"image/*",multiple:!0,style:"\n      display: none;\n    "});f.appendChild(h),f.appendChild(b),f.appendChild(v),s.appendChild(a),s.appendChild(d),s.appendChild(f),e.appendChild(n),e.appendChild(s);const x=(e,t,n,o)=>{e.style.borderBottomColor="#3b82f6",e.style.color="#3b82f6",t.style.borderBottomColor="transparent",t.style.color="#6b7280",n.style.display="block",o.style.display="none"};return c.addEventListener("click",()=>{x(c,l,d,f)}),l.addEventListener("click",()=>{x(l,c,f,d)}),{panel:e,overlay:t,dropZone:u,fileInput:g,closeButton:r,diffDropZone:b,diffFileInput:v,markdownTextarea:h}}();let d=!1,u=!1;const p=()=>{document.body.removeChild(n),document.body.removeChild(t),e()},m=async e=>{if(e&&0!==e.length){p(),h.showProgressDialog();try{const t=Array.from(e).map(async e=>{try{return await h.uploadImage(e)}catch(t){throw console.error("[Image Uploader] Upload failed:",t),t}});await Promise.allSettled(t)}finally{setTimeout(()=>{h.hideProgressDialog()},3e3)}}},g=async e=>{if(!e||0===e.length)return;const t=function(e){const t=/!\[([^\]]*)\]\([^)]+\)/g,n=[];let o;for(;null!==(o=t.exec(e));){const e=o[1];e&&e.trim()&&n.push(e.trim())}return n}(l.value),n=Array.from(e).filter(e=>{const n=e.name;return!t.includes(n)});if(0!==n.length){if(n.length<e.length){const t=e.length-n.length;if(!confirm(`å‘ç° ${t} ä¸ªå›¾ç‰‡å·²å­˜åœ¨äºmarkdownæ–‡æœ¬ä¸­ï¼Œå°†è¢«è·³è¿‡ã€‚æ˜¯å¦ç»§ç»­ä¸Šä¼ å‰©ä½™ ${n.length} ä¸ªå›¾ç‰‡ï¼Ÿ`))return}p(),h.showProgressDialog();try{const e=n.map(async e=>{try{return await h.uploadImage(e)}catch(t){throw console.error("[Image Uploader] Diff upload failed:",t),t}});await Promise.allSettled(e)}finally{setTimeout(()=>{h.hideProgressDialog()},3e3)}}else alert("æ‰€æœ‰é€‰æ‹©çš„å›¾ç‰‡éƒ½å·²åœ¨markdownæ–‡æœ¬ä¸­å­˜åœ¨ï¼Œæ— éœ€ä¸Šä¼ ã€‚")};r.addEventListener("change",async e=>{const t=e.target.files;t&&await m(t)}),i.addEventListener("click",()=>{r.click()}),i.addEventListener("dragover",e=>{e.preventDefault(),d||(d=!0,i.style.borderColor="#3b82f6",i.style.backgroundColor="#eff6ff")}),i.addEventListener("dragleave",e=>{e.preventDefault(),i.contains(e.relatedTarget)||(d=!1,i.style.borderColor="#d1d5db",i.style.backgroundColor="#f9fafb")}),i.addEventListener("drop",async e=>{e.preventDefault(),d=!1,i.style.borderColor="#d1d5db",i.style.backgroundColor="#f9fafb";const t=e.dataTransfer?.files;t&&await m(t)}),c.addEventListener("change",async e=>{const t=e.target.files;t&&await g(t)}),a.addEventListener("click",()=>{c.click()}),a.addEventListener("dragover",e=>{e.preventDefault(),u||(u=!0,a.style.borderColor="#3b82f6",a.style.backgroundColor="#eff6ff")}),a.addEventListener("dragleave",e=>{e.preventDefault(),a.contains(e.relatedTarget)||(u=!1,a.style.borderColor="#d1d5db",a.style.backgroundColor="#f9fafb")}),a.addEventListener("drop",async e=>{e.preventDefault(),u=!1,a.style.borderColor="#d1d5db",a.style.backgroundColor="#f9fafb";const t=e.dataTransfer?.files;t&&await g(t)}),s.addEventListener("click",p),n.addEventListener("click",p);const f=e=>{e.preventDefault(),e.stopPropagation()};["dragenter","dragover","dragleave","drop"].forEach(e=>{document.addEventListener(e,f,!1)});const b=p,y=()=>{["dragenter","dragover","dragleave","drop"].forEach(e=>{document.removeEventListener(e,f,!1)}),b()};s.removeEventListener("click",p),n.removeEventListener("click",p),s.addEventListener("click",y),n.addEventListener("click",y),document.body.appendChild(n),document.body.appendChild(t)})}var y=['.d-editor-button-bar[role="toolbar"]',".chat-composer__inner-container"];function w(){const e=[];for(const t of y){const n=document.querySelectorAll(t);e.push(...Array.from(n))}return e}var v=null;function x(e,t){v&&!v.contains(e.target)&&e.target!==t&&(v.remove(),v=null,document.removeEventListener("click",e=>x(e,t)))}var k=["info","tip","faq","question","note","abstract","todo","success","warning","failure","danger","bug","example","quote"];function E(){const t=e.settings?.forceMobileMode||!1,n=o("div",{class:"fk-d-menu toolbar-menu__options-content toolbar-popup-menu-options -animated -expanded",style:"z-index:1300;"}),i=o("div",{class:"fk-d-menu__inner-content"}),r=o("ul",{class:"dropdown-menu"}),s={info:{icon:"â„¹ï¸",color:"rgba(2, 122, 255, 0.1)",svg:'<svg class="fa d-icon d-icon-far-lightbulb svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-lightbulb"></use></svg>'},tip:{icon:"ğŸ’¡",color:"rgba(0, 191, 188, 0.1);",svg:'<svg class="fa d-icon d-icon-fire-flame-curved svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#fire-flame-curved"></use></svg>'},faq:{icon:"â“",color:"rgba(236, 117, 0, 0.1);",svg:'<svg class="fa d-icon d-icon-far-circle-question svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-circle-question"></use></svg>'},question:{icon:"ğŸ¤”",color:"rgba(236, 117, 0, 0.1);",svg:'<svg class="fa d-icon d-icon-far-circle-question svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-circle-question"></use></svg>'},note:{icon:"ğŸ“",color:"rgba(8, 109, 221, 0.1);",svg:'<svg class="fa d-icon d-icon-far-pen-to-square svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-pen-to-square"></use></svg>'},abstract:{icon:"ğŸ“‹",color:"rgba(0, 191, 188, 0.1);",svg:'<svg class="fa d-icon d-icon-far-clipboard svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-clipboard"></use></svg>'},todo:{icon:"â˜‘ï¸",color:"rgba(2, 122, 255, 0.1);",svg:'<svg class="fa d-icon d-icon-far-circle-check svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-circle-check"></use></svg>'},success:{icon:"ğŸ‰",color:"rgba(68, 207, 110, 0.1);",svg:'<svg class="fa d-icon d-icon-check svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#check"></use></svg>'},warning:{icon:"âš ï¸",color:"rgba(236, 117, 0, 0.1);",svg:'<svg class="fa d-icon d-icon-triangle-exclamation svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#triangle-exclamation"></use></svg>'},failure:{icon:"âŒ",color:"rgba(233, 49, 71, 0.1);",svg:'<svg class="fa d-icon d-icon-xmark svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#xmark"></use></svg>'},danger:{icon:"â˜ ï¸",color:"rgba(233, 49, 71, 0.1);",svg:'<svg class="fa d-icon d-icon-bolt svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#bolt"></use></svg>'},bug:{icon:"ğŸ›",color:"rgba(233, 49, 71, 0.1);",svg:'<svg class="fa d-icon d-icon-bug svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#bug"></use></svg>'},example:{icon:"ğŸ”",color:"rgba(120, 82, 238, 0.1);",svg:'<svg class="fa d-icon d-icon-list svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#list"></use></svg>'},quote:{icon:"ğŸ’¬",color:"rgba(158, 158, 158, 0.1);",svg:'<svg class="fa d-icon d-icon-quote-left svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#quote-left"></use></svg>'}};if(k.forEach(e=>{const t=e.length>0?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():e,i=o("li",{class:"dropdown-menu__item"}),a=o("button",{class:"btn btn-icon-text",type:"button",ti:t});a.addEventListener("click",()=>{n.parentElement&&n.parentElement.removeChild(n),function(e){const t=document.activeElement;if((n=t)&&"TEXTAREA"===n.tagName){const n=t,i=n.selectionStart??0,r=n.selectionEnd??i,s=n.value;n.value=s.slice(0,i)+e+s.slice(r);const a=i+e.length;if("setSelectionRange"in n)try{n.setSelectionRange(a,a)}catch(o){}return void n.dispatchEvent(new Event("input",{bubbles:!0}))}var n;if(t&&t.isContentEditable){const n=window.getSelection();if(!n)return;const o=n.getRangeAt(0);o.deleteContents();const i=document.createTextNode(e);return o.insertNode(i),o.setStartAfter(i),o.setEndAfter(i),n.removeAllRanges(),n.addRange(o),void t.dispatchEvent(new Event("input",{bubbles:!0}))}for(const i of[".d-editor-textarea-wrapper textarea",".d-editor-textarea textarea",".d-editor-textarea textarea","textarea"]){const t=document.querySelector(i);if(!t)continue;if(t.isContentEditable){const n=t,o=document.createRange();o.selectNodeContents(n),o.collapse(!1);const i=document.createTextNode(e);o.insertNode(i);const r=window.getSelection();if(r){r.removeAllRanges();const e=document.createRange();e.setStartAfter(i),e.setEndAfter(i),r.addRange(e)}return void n.dispatchEvent(new Event("input",{bubbles:!0}))}const n=t;n.focus();const r=n.selectionStart??n.value.length,s=n.selectionEnd??r,a=n.value;n.value=a.slice(0,r)+e+a.slice(s);const c=r+e.length;if("setSelectionRange"in n)try{n.setSelectionRange(c,c)}catch(o){}return void n.dispatchEvent(new Event("input",{bubbles:!0}))}}(`>[!${e}]+\n`)});const c=o("span",{text:s[e]?.icon||"âœ³ï¸"});c.style.marginRight="6px";const l=o("span",{class:"d-button-label"}),d=o("span",{class:"d-button-label__text",text:t});s[e]?.color&&(a.style.cssText+="background:"+s[e]?.color),l.appendChild(d);const u=s[e]?.svg||"";if(u){const e=o("span",{class:"d-button-label__svg",in:u,style:"margin-left:6px;display:inline-flex;align-items:center"});l.appendChild(e)}a.appendChild(c),a.appendChild(l),i.appendChild(a),r.appendChild(i)}),i.appendChild(r),n.appendChild(i),t){const e=o("div",{class:"modal d-modal fk-d-menu-modal toolbar-menu__options-content toolbar-popup-menu-options",attrs:{"data-keyboard":"false","aria-modal":"true",role:"dialog"}}),t=o("div",{class:"d-modal__container"}),n=o("div",{class:"d-modal__body"});n.tabIndex=-1;const r=o("div",{class:"fk-d-menu-modal__grip"});return r.setAttribute("aria-hidden","true"),n.appendChild(r),n.appendChild(i.querySelector(".dropdown-menu")),t.appendChild(n),e.appendChild(t),e}return n}function C(t){if(t.querySelector(".emoji-extension-button")||t.querySelector(".image-upload-button"))return;const n=t.classList.contains("chat-composer__inner-container"),i=o("button",{class:"btn no-text btn-icon toolbar__button nacho-emoji-picker-button emoji-extension-button",ti:"è¡¨æƒ…åŒ…",type:"button",in:"ğŸˆâ€â¬›"});n&&(i.classList.add("fk-d-menu__trigger","emoji-picker-trigger","chat-composer-button","btn-transparent","-emoji"),i.setAttribute("aria-expanded","false"),i.setAttribute("data-identifier","emoji-picker"),i.setAttribute("data-trigger","")),i.addEventListener("click",async t=>{if(t.stopPropagation(),v)return v.remove(),v=null,void document.removeEventListener("click",e=>x(e,i));e.settings?.forceMobileMode?async function(){const e=await l(!0);let t=document.querySelector(".modal-container");t||(t=o("div",{class:"modal-container"}),document.body.appendChild(t)),t.innerHTML="";const n=o("div",{class:"d-modal__backdrop"});n.addEventListener("click",()=>{e.parentElement&&e.parentElement.removeChild(e),n.parentElement&&n.parentElement.removeChild(n),v=null}),t.appendChild(e),t.appendChild(n),v=e}():async function(e){v=await l(!1);const t=e.getBoundingClientRect(),n=v;n&&document.body.appendChild(n);const o=document.querySelector(".d-editor-textarea-wrapper");if(o){const e=o.getBoundingClientRect(),i=document.querySelector("#reply-control")?.className.includes("hide-preview")&&window.innerWidth<1600;if(n.style.position="fixed",i)n.style.bottom=window.innerHeight-e.top+10+"px",n.style.left=e.left+e.width/2-200+"px";else{const e=n.getBoundingClientRect();n.style.top=t.top-e.height-5+"px",n.style.left=t.left+t.width/2-e.width/2+"px",n.getBoundingClientRect().top<0&&(n.style.top=t.bottom+5+"px")}}else n.style.position="fixed",n.style.top=t.bottom+5+"px",n.style.left=t.left+"px";setTimeout(()=>{document.addEventListener("click",t=>x(t,e))},100)}(i)});const r=o("button",{class:"btn no-text btn-icon toolbar__button image-upload-button",ti:"ä¸Šä¼ å›¾ç‰‡",type:"button",in:"ğŸ“·"});n&&(r.classList.add("fk-d-menu__trigger","chat-composer-button","btn-transparent"),r.setAttribute("aria-expanded","false"),r.setAttribute("data-trigger","")),r.addEventListener("click",async n=>{n.stopPropagation();const i=e.settings?.forceMobileMode||t.classList.contains("chat-composer__inner-container"),s=function(e=!1){const t=o("div",{class:"fk-d-menu toolbar-menu__options-content toolbar-popup-menu-options -animated -expanded",attrs:{"data-identifier":"toolbar-menu__options",role:"dialog"}}),n=o("div",{class:"fk-d-menu__inner-content"}),i=o("ul",{class:"dropdown-menu"});function r(e,t,n){const i=o("li",{class:"dropdown-menu__item"}),r=o("button",{class:"btn btn-icon-text",type:"button",ti:e});r.addEventListener("click",n);const s=o("span",{text:t}),a=o("span",{class:"d-button-label"}),c=o("span",{class:"d-button-label__text",text:e});return a.appendChild(c),r.appendChild(s),r.appendChild(a),i.appendChild(r),i}const s=r("ä¸Šä¼ æœ¬åœ°å›¾ç‰‡","ğŸ“",async()=>{t.remove(),await b()});i.appendChild(s);const a=r("è‡ªåŠ¨é˜…è¯»æ‰€æœ‰å›å¤","ğŸ“–",async()=>{t.remove();try{await m()}catch(e){u("è‡ªåŠ¨é˜…è¯»å¤±è´¥: "+(e&&e.message?e.message:String(e)),"error")}});i.appendChild(a);const c=r("å…¨è‡ªåŠ¨è‡ªåŠ¨é˜…è¯»æ‰€æœ‰å¸–å­","ğŸ“–",async()=>{t.remove();try{await g()}catch(e){u("è‡ªåŠ¨é˜…è¯»å¤±è´¥: "+(e&&e.message?e.message:String(e)),"error")}});i.appendChild(c);const l=r("AI ç”Ÿæˆå›¾ç‰‡","ğŸ¨",()=>{t.remove();try{window.open("https://gemini-image.smnet.studio/","_blank")}catch(e){window.location.href="https://gemini-image.smnet.studio/"}});i.appendChild(l);const d=r("å­¦ä¹ xv6","ğŸ–¥ï¸",()=>{t.remove();try{window.open("https://pwsh.edu.deal/","_blank")}catch(e){window.location.href="https://pwsh.edu.deal/"}});i.appendChild(d);const p=r("è¿‡ç›¾","ğŸ›¡",()=>{if(document.querySelector(".emoji-extension-passwall-iframe"))return;const e=o("div",{class:"emoji-extension-passwall-iframe modal-container",style:"position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:100000"}),t=o("div",{style:"position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5)"}),n=o("div",{style:"position:relative;width:80%;max-width:900px;height:80%;max-height:700px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.3)"}),i=o("button",{class:"btn btn-sm",type:"button",text:"å…³é—­",style:"position:absolute;top:8px;right:8px;z-index:1001"}),r=o("iframe",{src:"https://linux.do/challenge",style:"width:100%;height:100%;border:0",attrs:{sandbox:"allow-scripts allow-forms allow-same-origin allow-popups"}}),s=()=>{e.parentElement&&e.parentElement.removeChild(e)};i.addEventListener("click",()=>{s()}),r.addEventListener("load",()=>{let e=null;try{e=r.contentWindow&&r.contentWindow.location&&r.contentWindow.location.href||null}catch(t){e=r.src||null}if(e)try{new URL(e).hostname.endsWith("linux.do")&&s()}catch(t){}}),n.appendChild(i),n.appendChild(r),e.appendChild(t),e.appendChild(n),document.body.appendChild(e)});if(i.appendChild(p),n.appendChild(i),t.appendChild(n),e){const e=o("div",{class:"modal-container"}),t=o("div",{class:"modal d-modal fk-d-menu-modal toolbar-menu__options-content toolbar-popup-menu-options",attrs:{"data-keyboard":"false","aria-modal":"true",role:"dialog","data-identifier":"toolbar-menu__options","data-content":""}}),i=o("div",{class:"d-modal__container"}),r=o("div",{class:"d-modal__body"});r.tabIndex=-1;const s=o("div",{class:"fk-d-menu-modal__grip"});s.setAttribute("aria-hidden","true"),r.appendChild(s),r.appendChild(n.querySelector(".dropdown-menu")),i.appendChild(r),t.appendChild(i);const a=o("div",{class:"d-modal__backdrop"});return a.addEventListener("click",()=>{e.innerHTML=""}),e.appendChild(t),e.appendChild(a),e}return t}(i);if(i){const e=document.querySelector(".modal-container");e?e.appendChild(s):document.body.appendChild(s)}else{let e=document.querySelector("#d-menu-portals");e||(e=o("div",{id:"d-menu-portals"}),document.body.appendChild(e)),e.appendChild(s);const t=r.getBoundingClientRect();s.style.position="fixed",s.style.visibility="hidden",s.style.zIndex="10000",s.style.maxWidth="400px";const n=s.getBoundingClientRect();let i=t.top-n.height-5,a=t.left+t.width/2-n.width/2,c="top";i<0&&(i=t.bottom+5,c="bottom"),a=Math.max(8,Math.min(a,window.innerWidth-n.width-8)),s.style.top=`${i}px`,s.style.left=`${a}px`,s.style.visibility="visible",s.setAttribute("data-strategy","absolute"),s.setAttribute("data-placement",c)}const a=e=>{if(i){const o=s.classList&&s.classList.contains("modal-container")?s:document.querySelector(".modal-container");if(o&&!o.contains(e.target)){try{o.innerHTML=""}catch(t){try{o.parentElement&&o.parentElement.removeChild(o)}catch(n){}}document.removeEventListener("click",a)}}else s.contains(e.target)||(s.parentElement&&s.parentElement.removeChild(s),document.removeEventListener("click",a))};setTimeout(()=>{document.addEventListener("click",a)},100)});const s=o("button",{class:"btn no-text btn-icon toolbar__button quick-insert-button",ti:"å¿«æ·è¾“å…¥",type:"button",in:"â˜"});n&&(s.classList.add("fk-d-menu__trigger","chat-composer-button","btn-transparent"),s.setAttribute("aria-expanded","false"),s.setAttribute("data-trigger","")),s.addEventListener("click",n=>{n.stopPropagation();const i=e.settings?.forceMobileMode||t.classList.contains("chat-composer__inner-container"),r=E();if(i){let e=document.querySelector(".modal-container");e||(e=o("div",{class:"modal-container"}),document.body.appendChild(e)),e.innerHTML="";const t=o("div",{class:"d-modal__backdrop"});t.addEventListener("click",()=>{e&&(e.innerHTML=""),v=null}),e.appendChild(r),e.appendChild(t),v=r}else{let e=document.querySelector("#d-menu-portals");e||(e=o("div",{id:"d-menu-portals"}),document.body.appendChild(e)),e.appendChild(r);const t=s.getBoundingClientRect();r.style.position="fixed",r.style.zIndex="10000",r.style.top=`${t.bottom+5}px`,r.style.left=`${Math.max(8,Math.min(t.left+t.width/2-150,window.innerWidth-300))}px`}const a=e=>{if(i){const o=r.classList&&r.classList.contains("modal-container")?r:document.querySelector(".modal-container");if(o&&!o.contains(e.target)){try{o.innerHTML=""}catch(t){try{o.parentElement&&o.parentElement.removeChild(o)}catch(n){}}document.removeEventListener("click",a)}}else r.contains(e.target)||(r.parentElement&&r.parentElement.removeChild(r),document.removeEventListener("click",a))};setTimeout(()=>{document.addEventListener("click",a)},100)});try{if(n){const e=t.querySelector(".emoji-picker-trigger:not(.emoji-extension-button)");e?(t.insertBefore(r,e),t.insertBefore(s,e),t.insertBefore(i,e)):(t.appendChild(r),t.appendChild(s),t.appendChild(i))}else t.appendChild(r),t.appendChild(s),t.appendChild(i)}catch(a){console.error("[Emoji Extension] Failed to inject buttons (module):",a)}}function _(e){try{const t=(new URL(e).pathname.split("/").pop()||"").replace(/\.[^/.]+$/,""),n=decodeURIComponent(t);return/^[0-9a-f]{8,}$/i.test(n)||n.length<2?"è¡¨æƒ…":n||"è¡¨æƒ…"}catch{return"è¡¨æƒ…"}}function j(e){const t=o("a",{class:"emoji-add-link",style:"color:#fff;background:linear-gradient(135deg,#4f46e5,#7c3aed);border-radius:6px;padding:4px 8px;margin:0 2px;display:inline-flex;align-items:center;font-weight:600;",ti:"æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",in:"æ·»åŠ è¡¨æƒ…"});return function(e,t){e.addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation();const o=e.innerHTML,i=e.style.cssText;try{await chrome.runtime.sendMessage({action:"addEmojiFromWeb",emojiData:t}),e.innerHTML="å·²æ·»åŠ ",e.style.background="linear-gradient(135deg, #10b981, #059669)",setTimeout(()=>{e.innerHTML=o,e.style.cssText=i},2e3)}catch(r){console.error("[DiscourseOneClick] æ·»åŠ è¡¨æƒ…å¤±è´¥:",r),e.innerHTML="å¤±è´¥",e.style.background="linear-gradient(135deg, #ef4444, #dc2626)",setTimeout(()=>{e.innerHTML=o,e.style.cssText=i},2e3)}})}(t,e),t}function L(e){if(e.querySelector(".emoji-add-link"))return;const t=e.querySelector(".mfp-img"),n=e.querySelector(".mfp-title");if(!t||!n)return;const o=function(e,t){const n=e.src;if(!n||!n.startsWith("http"))return null;let o="";const i=(t.textContent||"").split("Â·");return i.length>0&&(o=i[0].trim()),(!o||o.length<2)&&(o=e.alt||e.title||_(n)),o=o.trim()||"è¡¨æƒ…",{name:o,url:n}}(t,n);if(!o)return;const i=j(o),r=n.querySelector("a.image-source-link");r?(n.insertBefore(document.createTextNode(" Â· "),r),n.insertBefore(i,r)):(n.appendChild(document.createTextNode(" Â· ")),n.appendChild(i))}function S(){document.querySelectorAll(".mfp-wrap.mfp-gallery").forEach(e=>{var t;(t=e).classList&&t.classList.contains("mfp-wrap")&&t.classList.contains("mfp-gallery")&&null!==t.querySelector(".mfp-img")&&L(e)})}function T(e){const t=o("button",{class:"emoji-batch-parse-button",style:"\n    display: inline-flex;\n    align-items: center;\n    gap: 6px;\n    background: linear-gradient(135deg,#f59e0b,#d97706);\n    color: #fff;\n    border-radius: 8px;\n    padding: 8px 12px;\n    margin: 10px 0;\n    font-weight: 600;\n    ",in:"ä¸€é”®è§£æå¹¶æ·»åŠ æ‰€æœ‰å›¾ç‰‡",ti:"è§£æå½“å‰å†…å®¹ä¸­çš„æ‰€æœ‰å›¾ç‰‡å¹¶æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",on:{click:async n=>{n.preventDefault(),n.stopPropagation();const o=t.innerHTML,i=t.style.cssText;try{t.innerHTML="æ­£åœ¨è§£æ...",t.style.background="linear-gradient(135deg,#6b7280,#4b5563)",t.disabled=!0;const n=e.querySelectorAll(".lightbox-wrapper"),s=[];if(n.forEach(e=>{const t=function(e){const t=[],n=e.querySelector("a.lightbox"),o=e.querySelector("img");if(!n||!o)return t;const i=n.getAttribute("title")||"",r=n.getAttribute("href")||"",s=n.getAttribute("data-download-href")||"",a=o.getAttribute("src")||"";let c=i||o.getAttribute("alt")||"";(!c||c.length<2)&&(c=_(r||s||a)),c=c.replace(/\.(webp|jpg|jpeg|png|gif)$/i,"").trim()||"è¡¨æƒ…";const l=r||s||a;return l&&l.startsWith("http")&&t.push({name:c,url:l}),t}(e);s.push(...t)}),0===s.length)throw new Error("æœªæ‰¾åˆ°å¯è§£æçš„å›¾ç‰‡");let a=0;for(const e of s)try{await chrome.runtime.sendMessage({action:"addEmojiFromWeb",emojiData:e}),a++}catch(r){console.error("[DiscourseOneClick] æ·»åŠ å›¾ç‰‡å¤±è´¥",e.name,r)}t.innerHTML=`å·²å¤„ç† ${a}/${s.length} å¼ å›¾ç‰‡`,t.style.background="linear-gradient(135deg,#10b981,#059669)",setTimeout(()=>{t.innerHTML=o,t.style.cssText=i,t.disabled=!1},3e3)}catch(s){console.error("[DiscourseOneClick] æ‰¹é‡è§£æå¤±è´¥:",s),t.innerHTML="è§£æå¤±è´¥",t.style.background="linear-gradient(135deg,#ef4444,#dc2626)",setTimeout(()=>{t.innerHTML=o,t.style.cssText=i,t.disabled=!1},3e3)}}}});return t}function A(){document.querySelectorAll(".cooked").forEach(e=>{var t;(t=e).classList.contains("cooked")&&null!==t.querySelector(".lightbox-wrapper")&&function(e){if(e.querySelector(".emoji-batch-parse-button"))return;if(0===e.querySelectorAll(".lightbox-wrapper").length)return;const t=T(e),n=e.firstChild;n?e.insertBefore(t,n):e.appendChild(t)}(e)})}var q=["note","abstract","summary","tldr","info","todo","tip","hint","success","check","done","question","help","faq","warning","caution","attention","failure","fail","missing","danger","error","bug","example","quote","cite"].sort(),M={info:{icon:"â„¹ï¸",color:"rgba(2, 122, 255, 0.06)",svg:'<svg class="fa d-icon d-icon-far-lightbulb svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-lightbulb"></use></svg>'},tip:{icon:"ğŸ’¡",color:"rgba(0, 191, 188, 0.06)",svg:'<svg class="fa d-icon d-icon-fire-flame-curved svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#fire-flame-curved"></use></svg>'},faq:{icon:"â“",color:"rgba(236, 117, 0, 0.06)",svg:'<svg class="fa d-icon d-icon-far-circle-question svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-circle-question"></use></svg>'},question:{icon:"ğŸ¤”",color:"rgba(236, 117, 0, 0.06)",svg:'<svg class="fa d-icon d-icon-far-circle-question svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-circle-question"></use></svg>'},note:{icon:"ğŸ“",color:"rgba(8, 109, 221, 0.06)",svg:'<svg class="fa d-icon d-icon-far-pen-to-square svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-pen-to-square"></use></svg>'},abstract:{icon:"ğŸ“‹",color:"rgba(0, 191, 188, 0.06)",svg:'<svg class="fa d-icon d-icon-far-clipboard svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-clipboard"></use></svg>'},todo:{icon:"â˜‘ï¸",color:"rgba(2, 122, 255, 0.06)",svg:'<svg class="fa d-icon d-icon-far-circle-check svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#far-circle-check"></use></svg>'},success:{icon:"ğŸ‰",color:"rgba(68, 207, 110, 0.06)",svg:'<svg class="fa d-icon d-icon-check svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#check"></use></svg>'},warning:{icon:"âš ï¸",color:"rgba(236, 117, 0, 0.06)",svg:'<svg class="fa d-icon d-icon-triangle-exclamation svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#triangle-exclamation"></use></svg>'},failure:{icon:"âŒ",color:"rgba(233, 49, 71, 0.06)",svg:'<svg class="fa d-icon d-icon-xmark svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#xmark"></use></svg>'},danger:{icon:"â˜ ï¸",color:"rgba(233, 49, 71, 0.06)",svg:'<svg class="fa d-icon d-icon-bolt svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#bolt"></use></svg>'},bug:{icon:"ğŸ›",color:"rgba(233, 49, 71, 0.06)",svg:'<svg class="fa d-icon d-icon-bug svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#bug"></use></svg>'},example:{icon:"ğŸ”",color:"rgba(120, 82, 238, 0.06)",svg:'<svg class="fa d-icon d-icon-list svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#list"></use></svg>'},quote:{icon:"ğŸ’¬",color:"rgba(158, 158, 158, 0.06)",svg:'<svg class="fa d-icon d-icon-quote-left svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><use href="#quote-left"></use></svg>'}},N={icon:"ğŸ“",color:"var(--secondary-low)",svg:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor"><path d="M490.3 40.4C512.2 62.27 512.2 97.73 490.3 119.6L460.3 149.7 362.3 51.72 392.4 21.66C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7L339.7 74.34 437.7 172.3 270.3 339.6C264.2 345.8 256.7 350.4 248.4 352.1L159.6 372.9C152.1 374.7 144.3 373.1 138.6 367.4C132.9 361.7 131.3 353.9 133.1 346.4L153.9 257.6C155.6 249.3 160.2 241.8 166.4 235.7L172.4 241.7zM96 64C42.98 64 0 106.1 0 160V416C0 469 42.98 512 96 512H352C405 512 448 469 448 416V320H400V416C400 442.5 378.5 464 352 464H96C69.54 464 48 442.5 48 416V160C48 133.5 69.54 112 96 112H192V64H96z"/></svg>'};M.summary=M.tldr=M.abstract,M.hint=M.tip,M.check=M.done=M.success,M.help=M.faq,M.caution=M.attention=M.warning,M.fail=M.missing=M.failure,M.error=M.danger,M.cite=M.quote;var H=null,I=0;function D(){H||((H=document.createElement("div")).id="callout-suggestion-box-en",document.body.appendChild(H),function(){const e="callout-suggestion-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent="\n    #callout-suggestion-box-en {\n      position: absolute;\n      background-color: var(--secondary);\n      border: 1px solid #444;\n      border-radius: 6px;\n      box-shadow: 0 4px 8px rgba(0,0,0,0.2);\n      z-index: 9999;\n      padding: 5px;\n      display: none; /* é»˜è®¤éšè— */\n      font-size: 14px;\n      max-height: 200px;\n      overflow-y: auto;\n    }\n    .suggestion-item-en {\n      padding: 8px 12px;\n      cursor: pointer;\n      color: var(--primary-high);\n      border-radius: 4px;\n      font-family: monospace;\n      display: flex;\n      align-items: center;\n    }\n    .suggestion-item-en:hover, .suggestion-item-en.active {\n      background-color: var(--primary-low) !important; /* ä½¿ç”¨ !important ç¡®ä¿è¦†ç›–è¡Œå†…æ ·å¼ */\n    }\n    .suggestion-item-en svg {\n      width: 1em;\n      height: 1em;\n      margin-right: 8px;\n      /* é»˜è®¤é¢œè‰²è¢«å†…è”æ ·å¼è¦†ç›– */\n      color: var(--primary-medium);\n    }\n  ",document.head.appendChild(t)}())}function R(){H&&(H.style.display="none")}function z(){H&&H.querySelectorAll(".suggestion-item-en").forEach((e,t)=>{e.classList.toggle("active",t===I),t===I&&e.scrollIntoView({block:"nearest"})})}function $(e,t){const n=e.value,o=e.selectionStart||0,i=n.substring(0,o);let r=i.lastIndexOf("[");if(-1===r&&(r=i.lastIndexOf("ï¼»")),-1===r&&(r=i.lastIndexOf("ã€")),-1===r)return;const s=`[!${t}]`,a=n.substring(o);e.value=i.substring(0,r)+s+a,e.selectionStart=e.selectionEnd=r+s.length,e.dispatchEvent(new Event("input",{bubbles:!0}))}function O(e,t){if(!H||0===t.length)return void R();H.innerHTML=t.map((e,t)=>{const n=M[e]||N,o=n.color||"transparent",i=n.color?n.color.replace("rgba","rgb").replace(/, [0-9.]+\)/,")"):"var(--primary-medium)";return`\n      <div class="suggestion-item-en" data-index="${t}" data-key="${e}" style="background-color:${o}">\n        ${(n.svg||N.svg).replace("<svg",`<svg style="color: ${i};"`)}\n        <span>${e}</span>\n      </div>`}).join(""),H.querySelectorAll(".suggestion-item-en").forEach(t=>{t.addEventListener("mousedown",n=>{n.preventDefault();const o=t.dataset.key;o&&($(e,o),R())})});const n=e.getBoundingClientRect(),o=function(e){const t="textarea-mirror-div-en";let n=document.getElementById(t);n||(n=document.createElement("div"),n.id=t,document.body.appendChild(n));const o=window.getComputedStyle(e);["border","boxSizing","fontFamily","fontSize","fontWeight","height","letterSpacing","lineHeight","outline","paddingBottom","paddingLeft","paddingRight","paddingTop","textAlign","textIndent","whiteSpace"].forEach(e=>{n.style[e]=o.getPropertyValue(e)}),n.style.position="absolute",n.style.left="-9999px",n.style.top="-9999px",n.style.width=o.width,n.textContent=e.value.substring(0,e.selectionEnd);const i=document.createElement("span");return i.textContent=".",n.appendChild(i),{x:i.offsetLeft-e.scrollLeft,y:i.offsetTop-e.scrollTop}}(e);H.style.left=`${n.left+window.scrollX+o.x}px`,H.style.top=`${n.top+window.scrollY+o.y+20}px`,H.style.display="block",I=0,z()}function P(e){const t=e.target;if(!(t&&t instanceof HTMLTextAreaElement))return;const n=t,o=n.value,i=n.selectionStart||0,r=o.substring(0,i).match(/(?:\[|ï¼»|ã€])(?:!|ï¼)?([a-z]*)$/i);if(r){const e=r[1].toLowerCase(),t=q.filter(t=>t.startsWith(e));t.length>0?O(n,t):R()}else R()}function B(e){if(!H||"none"===H.style.display)return;const t=H.querySelectorAll(".suggestion-item-en");if(0!==t.length)switch(["ArrowDown","ArrowUp","Tab","Enter","Escape"].includes(e.key)&&(e.preventDefault(),e.stopPropagation()),e.key){case"ArrowDown":I=(I+1)%t.length,z();break;case"ArrowUp":I=(I-1+t.length)%t.length,z();break;case"Tab":case"Enter":{const e=t[I]?.dataset.key;if(e){const t=document.activeElement;t&&t instanceof HTMLTextAreaElement&&$(t,e)}R();break}case"Escape":R()}}function W(){try{D(),document.addEventListener("input",P,!0),document.addEventListener("keydown",B,!0),document.addEventListener("click",e=>{"TEXTAREA"===e.target?.tagName||H?.contains(e.target)||R()})}catch(e){console.error("initCalloutSuggestions failed",e)}}function U(e){return new Promise(t=>{try{const n=window.chrome;n&&n.runtime&&n.runtime.sendMessage?n.runtime.sendMessage({type:"GET_EMOJI_SETTING",key:e},e=>{e&&e.success&&e.data&&Object.prototype.hasOwnProperty.call(e.data,"value")?t(e.data.value):t(null)}):t(null)}catch(n){t(null)}})}async function F(){try{if(!function(){try{return!!((document.querySelector('meta[name="generator"]')?.getAttribute("content")||"").toLowerCase().includes("discourse")||document.querySelector('meta[name^="discourse_"]')||document.getElementById("data-discourse-setup")||document.querySelector('meta[name="discourse/config/environment"]'))}catch(e){return console.error("[DiscourseOneClick] isDiscoursePage check failed",e),!1}}())return void console.log("[DiscourseOneClick] skipping init: not a Discourse page");setTimeout(S,200),setTimeout(A,300),new MutationObserver(e=>{let t=!1;e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const n=e;n.classList&&n.classList.contains("mfp-wrap")&&(t=!0)}})}),t&&setTimeout(S,100)}).observe(document.body,{childList:!0,subtree:!0}),new MutationObserver(e=>{let t=!1;e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const n=e;(n.classList&&n.classList.contains("cooked")||n.querySelector&&n.querySelector(".cooked"))&&(t=!0)}})}),t&&setTimeout(A,100)}).observe(document.body,{childList:!0,subtree:!0}),window.chrome?.runtime?.onMessage&&window.chrome.runtime.onMessage.addListener(async(e,t)=>{if(e&&"uploadBlobToDiscourse"===e.action)try{const t=e.filename||"image.jpg",n=e.mimeType||"image/jpeg",o=e.arrayBuffer;if(!o)throw new Error("no arrayBuffer");const i=new Blob([new Uint8Array(o)],{type:n}),r=new File([i],t,{type:n}),s=e.discourseBase||window.location.origin,a=new FormData;a.append("upload_type","composer"),a.append("relativePath","null"),a.append("name",r.name),a.append("type",r.type),a.append("file",r,r.name);const c=document.querySelector('meta[name="csrf-token"]'),l=c?c.content:(document.cookie.match(/csrf_token=([^;]+)/)||[])[1]||"",d={};l&&(d["X-Csrf-Token"]=l),document.cookie&&(d.Cookie=document.cookie);const u=`${s.replace(/\/$/,"")}/uploads.json?client_id=f06cb5577ba9410d94b9faf94e48c2d8`,p=await fetch(u,{method:"POST",headers:d,body:a,credentials:"include"});if(p.ok){const e=await p.json();window.chrome.runtime.sendMessage({type:"UPLOAD_RESULT",success:!0,data:e})}else{const e=await p.json().catch(()=>null);window.chrome.runtime.sendMessage({type:"UPLOAD_RESULT",success:!1,details:e})}}catch(n){window.chrome.runtime.sendMessage({type:"UPLOAD_RESULT",success:!1,error:String(n)})}});try{!1!==await U("enableCalloutSuggestions")?W():console.log("[DiscourseOneClick] callout suggestions disabled by user setting")}catch(e){console.warn("[DiscourseOneClick] failed to get enableCalloutSuggestions setting, defaulting to enabled",e),W()}}catch(e){console.error("[DiscourseOneClick] init failed",e)}}function X(){console.log("[OneClickAdd] åˆå§‹åŒ–ä¸€é”®æ·»åŠ è¡¨æƒ…æ ¸å¿ƒ"),function(){if(!document.getElementById("oneclick-add-styles")){const e=document.createElement("style");e.id="oneclick-add-styles",e.textContent="\n  @keyframes spin {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n  }\n  .fk-d-menu-modal.emoji-picker-content .emoji-picker {\n  {\n    height: auto;\n    width: auto;\n  }\n  .emoji-picker .emoji {\n    width: 20%;\n    height: 20%;\n}\n",document.head.appendChild(e)}}();try{F().catch(e=>{console.error("[OneClickAdd] initDiscourse failed",e)})}catch(e){console.error("[OneClickAdd] initDiscourse failed",e)}}var G=null,V=!1;function Q(){G||(!function(){if(document.getElementById("emoji-extension-floating-button-styles"))return;const e=document.createElement("style");e.id="emoji-extension-floating-button-styles",e.textContent="\n.emoji-extension-floating-button {\n  position: fixed !important;\n  bottom: 20px !important;\n  right: 20px !important;\n  width: 56px !important;\n  height: 56px !important;\n  border-radius: 50% !important;\n  background: transparent;\n  border: none !important;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;\n  cursor: pointer !important;\n  z-index: 999999 !important;\n  font-size: 24px !important;\n  color: white !important;\n  display: flex !important;\n  align-items: center !important;\n  justify-content: center !important;\n  transition: all 0.3s ease !important;\n  opacity: 0.9 !important;\n  line-height: 1 !important;\n}\n\n.emoji-extension-floating-button:hover {\n  transform: scale(1.1) !important;\n  opacity: 1 !important;\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2) !important;\n}\n\n.emoji-extension-floating-button:active {\n  transform: scale(0.95) !important;\n}\n\n.emoji-extension-floating-button.hidden {\n  opacity: 0 !important;\n  pointer-events: none !important;\n  transform: translateY(20px) !important;\n}\n\n@media (max-width: 768px) {\n  .emoji-extension-floating-button {\n    bottom: 15px !important;\n    right: 15px !important;\n    width: 48px !important;\n    height: 48px !important;\n    font-size: 20px !important;\n  }\n}\n",document.head.appendChild(e)}(),G=function(){const e=document.createElement("button");return e.className="emoji-extension-floating-button",e.title="æ‰‹åŠ¨æ³¨å…¥è¡¨æƒ…æŒ‰é’® (Manual Emoji Injection)",e.innerHTML="ğŸˆâ€â¬›",e.addEventListener("click",async t=>{t.stopPropagation(),t.preventDefault(),e.style.transform="scale(0.9)",e.innerHTML="â³";try{const t=w();let n=0;t.forEach(e=>{e.querySelector(".emoji-extension-button")||e.querySelector(".image-upload-button")||(console.log("[Emoji Extension] Manual injection: Toolbar found, injecting buttons."),C(e),n++)}),n>0||t.length>0?(e.innerHTML="âœ…",e.style.background="linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)",setTimeout(()=>{e.innerHTML="ğŸˆâ€â¬›",e.style.background="transparent",e.style.transform="scale(1)"},1500),console.log(`[Emoji Extension] Manual injection successful: ${n} buttons injected into ${t.length} toolbars`)):(e.innerHTML="âŒ",e.style.background="linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%)",setTimeout(()=>{e.innerHTML="ğŸˆâ€â¬›",e.style.background="transparent",e.style.transform="scale(1)"},1500),console.log("[Emoji Extension] Manual injection failed: No compatible toolbars found"))}catch(n){e.innerHTML="âš ï¸",e.style.background="linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%)",setTimeout(()=>{e.innerHTML="ğŸˆâ€â¬›",e.style.background="linear-gradient(135deg, #667eea 0%, #764ba2 100%)",e.style.transform="scale(1)"},1500),console.error("[Emoji Extension] Manual injection error:",n)}}),e}(),document.body.appendChild(G),V=!0,console.log("[Emoji Extension] Floating manual injection button shown"))}function Y(){const e=document.querySelectorAll(".emoji-extension-button, .image-upload-button");0!==e.length||V?e.length>0&&V&&G&&(G.classList.add("hidden"),setTimeout(()=>{G&&(G.remove(),G=null,V=!1)},300),console.log("[Emoji Extension] Floating manual injection button hidden")):setTimeout(()=>{V||(console.log("[Emoji Extension] Auto-showing floating button due to injection difficulties"),Q())},2e3)}var Z=59e3,J=Date.now(),K=Date.now(),ee={},te=0,ne=0;function oe(){const e=window.location.pathname.match(/t\/topic\/(\d+)/),t=window.location.pathname.match(/t\/(\d+)/);if(e&&e[1])return Number(e[1]);if(t&&t[1])return Number(t[1]);const n=document.querySelector("[data-topic-id]");return n&&Number(n.getAttribute("data-topic-id"))||0}function ie(e){const t=e.getBoundingClientRect();return t.bottom>0&&t.top<window.innerHeight}function re(){ne=oe(),J=Date.now(),K=Date.now(),window.addEventListener("scroll",()=>{J=Date.now()}),setInterval(()=>{const e=Date.now(),t=e-K;if(K=e,e-J>18e4)return;const n=Array.from(document.querySelectorAll("[data-post-number]")).filter(ie);if(0===n.length)return;const o=Math.min(t,Z-te);if(o<=0)return;const i=Math.floor(o/n.length);for(const r of n){const e=r.getAttribute("data-post-number")||r.dataset.postNumber,t=e?Number(e):NaN;if(t&&!Number.isNaN(t)&&(ee[t]=(ee[t]||0)+i,(te+=i)>=59e3))break}},1e3),setInterval(()=>{!async function(){if(ne||(ne=oe()),!ne)return;if(0===Object.keys(ee).length)return;let e=Object.values(ee).reduce((e,t)=>e+t,0);if(e>59e3){const t=Z/e;Object.keys(ee).forEach(e=>{ee[Number(e)]=Math.floor(ee[Number(e)]*t)}),e=Z}try{await d(ne,ee),ee={},te=0}catch(t){console.warn("[readTracker] flush failed",t)}}()},15e3),console.log("[readTracker] started")}function se(){w().forEach(e=>{e.querySelector(".emoji-extension-button")||e.querySelector(".image-upload-button")||(console.log("[Emoji Extension] Buttons missing after reply button click, re-injecting..."),C(e))})}function ae(e){try{console.debug("[pixiv][helpers] extractNameFromUrl input",e);const t=(new URL(e).pathname.split("/").pop()||"").replace(/\.[^/.]+$/,""),n=decodeURIComponent(t);return/^[0-9a-f]{8,}$/i.test(n)||n.length<2?"è¡¨æƒ…":n||"è¡¨æƒ…"}catch{return console.warn('[pixiv][helpers] extractNameFromUrl failed, returning fallback "è¡¨æƒ…"',e),"è¡¨æƒ…"}}async function ce(e,t,n,o){try{console.debug("[pixiv][helpers] sendEmojiToBackground start",{emojiName:t,filename:n,size:e.size,type:e.type});const i=window.chrome;if(!i||!i.runtime||!i.runtime.sendMessage)throw console.error("[pixiv][helpers] Chrome extension API not available"),new Error("Chrome extension API not available");const r=await e.arrayBuffer(),s=new Uint8Array(r),a=Array.from(s),c=await new Promise(r=>{try{i.runtime.sendMessage({action:"uploadAndAddEmoji",payload:{arrayData:a,filename:n,mimeType:e.type,name:t,originUrl:o}},e=>r(e))}catch(s){console.error("[pixiv][helpers] sendEmojiToBackground sendMessage failed",s),r({success:!1,error:"Failed to send message to background"})}});return console.debug("[pixiv][helpers] sendEmojiToBackground background response",c),c&&c.success?{success:!0,source:"uploaded",url:c.url,added:!!c.added,message:"è¡¨æƒ…å·²æˆåŠŸæ·»åŠ åˆ°æœªåˆ†ç»„"}:(console.warn("[pixiv][helpers] sendEmojiToBackground background indicated failure",c),{success:!1,error:"åå°å¤„ç†å¤±è´¥",details:c?.error||c?.details})}catch(i){return console.error("[pixiv][helpers] sendEmojiToBackground exception",i),{success:!1,error:"å‘é€æ•°æ®åˆ°åå°å¤±è´¥",details:i instanceof Error?i.message:String(i)}}}async function le(e){console.debug("[pixiv][helpers] performPixivAddEmojiFlow start",e);try{const n=e.name&&e.name.length>0?e.name:ae(e.url),o=n.replace(/\.(webp|jpg|jpeg|png|gif)$/i,"").trim()||"image";try{console.debug("[pixiv][helpers] attempting tryGetImageViaCanvas",e.url);const t=await async function(e){return new Promise(t=>{console.debug("[pixiv][helpers] tryGetImageViaCanvas start",e);const n=new Image;n.crossOrigin="anonymous",n.onload=async()=>{try{const i=document.createElement("canvas"),r=i.getContext("2d");if(i.width=n.naturalWidth||n.width,i.height=n.naturalHeight||n.height,!r)throw new Error("no-2d-context");r.drawImage(n,0,0);try{i.toBlob(e=>{e?(console.debug("[pixiv][helpers] tryGetImageViaCanvas produced blob",e),t({success:!0,blob:e})):(console.warn("[pixiv][helpers] tryGetImageViaCanvas no blob produced"),t({success:!1,error:"no-blob"}))})}catch(e){try{const e=i.toDataURL();fetch(e).then(e=>e.blob()).then(e=>t({success:!0,blob:e})).catch(e=>t({success:!1,error:e}))}catch(o){console.warn("[pixiv][helpers] tryGetImageViaCanvas toDataURL fallback failed",o),t({success:!1,error:o})}}}catch(i){console.warn("[pixiv][helpers] tryGetImageViaCanvas drawing/processing failed",i),t({success:!1,error:i})}},n.onerror=()=>t({success:!1,error:new Error("image load failed")}),n.src=e})}(e.url);if(console.debug("[pixiv][helpers] tryGetImageViaCanvas result",t),t.success)return await ce(t.blob,n,o,e.url)}catch(t){console.warn("[pixiv][helpers] tryGetImageViaCanvas threw",t)}try{console.debug("[pixiv][helpers] attempting fetch of image URL",e.url);const t=await fetch(e.url,{method:"GET",headers:{Referer:"https://www.pixiv.net/","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"},credentials:"omit"});if(console.debug("[pixiv][helpers] fetch response",{ok:t.ok,status:t.status}),t.ok){const i=await t.blob();return console.debug("[pixiv][helpers] fetched blob size/type",{size:i.size,type:i.type}),await ce(i,n,o,e.url)}}catch(t){console.warn("[pixiv][helpers] fetch failed",t)}try{return console.debug("[pixiv][helpers] opening image URL in new tab as fallback",e.url),window.open(e.url,"_blank"),{success:!0,source:"opened",message:"å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å›¾ç‰‡ï¼Œè¯·åœ¨å›¾ç‰‡é¡µé¢é‡è¯•æ·»åŠ è¡¨æƒ…"}}catch(t){return console.error("[pixiv][helpers] failed to open image URL",t),{success:!1,error:"æ— æ³•ä¸‹è½½å›¾ç‰‡æˆ–æ‰“å¼€å›¾ç‰‡é¡µé¢",details:t}}}catch(n){return console.error("[pixiv][helpers] performPixivAddEmojiFlow fatal error",n),{success:!1,error:"æ·»åŠ è¡¨æƒ…å¤±è´¥",details:n}}}function de(e){const t=document.createElement("button");t.type="button",t.className="emoji-add-link-pixiv",t.style.cssText="\n    position: absolute;\n    left: 12px;\n    top: 12px;\n    z-index: 100000;\n    color: #ffffff;\n    background: linear-gradient(135deg, #8b5cf6, #7c3aed);\n    border: 2px solid rgba(255,255,255,0.95);\n    border-radius: 6px;\n    padding: 6px 10px;\n    font-size: 13px;\n    font-weight: 600;\n    cursor: pointer;\n    display: inline-flex;\n    align-items: center;\n    gap: 6px;\n    pointer-events: auto;\n  ",t.innerHTML='\n    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>\n    </svg>\n    æ·»åŠ è¡¨æƒ…\n  ',t.title="æ·»åŠ è¡¨æƒ…åˆ°æ”¶è—";try{t.dataset.emojiName=e.name,t.dataset.emojiUrl=e.url}catch(n){}return function(e,t){let o=!1;try{console.debug("[pixiv][button] setupButtonClickHandler initialized",{name:t.name,url:t.url})}catch(n){}const i=async i=>{try{i.preventDefault(),i.stopPropagation()}catch(n){}if(console.debug("[pixiv][button] click event",{running:o}),o)return void console.debug("[pixiv][button] click ignored because already running");o=!0;try{const o=e.closest('article, div, figure, [role="presentation"]')?.querySelector('img[src*="i.pximg.net"], img[src*="pximg.net"]');if(o){const e=(o.getAttribute("data-src")||o.getAttribute("data-original")||"").trim(),i=o.getAttribute("srcset")||"",r=e||o.src||(i.split(",")[0]||"").split(" ")[0];if(r&&r.startsWith("http"))try{t={...t,url:r};const e=(o.alt||o.getAttribute("title")||"").trim()||t.name;e&&e.length>0&&(t.name=e)}catch(n){}}}catch(n){}const r=e.style.pointerEvents;e.style.pointerEvents="none";const s=e.innerHTML,a=e.style.cssText;e.innerHTML='\n      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="animation: spin 1s linear infinite;">\n        <style>\n          @keyframes spin {\n            from { transform: rotate(0deg); }\n            to { transform: rotate(360deg); }\n          }\n        </style>\n        <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>\n      </svg>\n      æ·»åŠ ä¸­...\n    ',e.style.background="linear-gradient(135deg, #f59e0b, #d97706)",console.debug("[pixiv][button] starting performPixivAddEmojiFlow",{data:t});try{const n=await le(t);if(console.debug("[pixiv][button] performPixivAddEmojiFlow response",n),!n||!n.success){const e="object"==typeof n&&null!==n&&(n.error||n.message)||"æ·»åŠ è¡¨æƒ…å¤±è´¥";throw console.warn("[pixiv][button] add emoji response indicated failure",{resp:n,errorMessage:e}),new Error(String(e))}e.innerHTML='\n          <svg class="fa d-icon d-icon-check svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 1em; height: 1em; fill: currentColor; margin-right: 4px;">\n            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>\n          </svg>å·²æ·»åŠ \n        ',e.style.background="linear-gradient(135deg, #10b981, #059669)",e.style.color="#ffffff",e.style.border="2px solid #ffffff",e.style.boxShadow="0 2px 4px rgba(16, 185, 129, 0.3)","opened"===n.source&&(e.innerHTML='\n            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n              <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>\n            </svg>å·²æ‰“å¼€\n          ',e.style.background="linear-gradient(135deg, #3b82f6, #2563eb)"),console.log("[pixiv][button] add emoji success",{name:t.name,url:t.url,resp:n}),setTimeout(()=>{console.debug("[pixiv][button] restoring original button state (success path)"),e.innerHTML=s,e.style.cssText=a,e.style.pointerEvents=r,o=!1},3e3)}catch(c){console.error("[pixiv][button] add emoji failed",c),e.innerHTML='\n        <svg class="fa d-icon d-icon-times svg-icon svg-string" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 1em; height: 1em; fill: currentColor; margin-right: 4px;">\n          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n        </svg>å¤±è´¥\n      ',e.style.background="linear-gradient(135deg, #ef4444, #dc2626)",e.style.color="#ffffff",e.style.border="2px solid #ffffff",e.style.boxShadow="0 2px 4px rgba(239, 68, 68, 0.3)",setTimeout(()=>{console.debug("[pixiv][button] restoring original button state (failure path)"),e.innerHTML=s,e.style.cssText=a,e.style.pointerEvents=r,o=!1},3e3)}};e.addEventListener("pointerdown",i),e.addEventListener("click",i)}(t,e),t}function ue(e){const t=document.createElement("button");t.type="button",t.className="pixiv-open-in-newtab",t.style.cssText="\n    position: absolute;\n    left: 12px;\n    top: 12px;\n    z-index: 100000;\n    color: #ffffff;\n    background: linear-gradient(135deg, #374151, #1f2937);\n    border: 2px solid rgba(255,255,255,0.9);\n    border-radius: 6px;\n    padding: 6px 10px;\n    font-size: 13px;\n    font-weight: 600;\n    cursor: pointer;\n    display: inline-flex;\n    align-items: center;\n    gap: 6px;\n    pointer-events: auto;\n  ",t.innerHTML='\n    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n      <path d="M14 3v2h3.59L7.76 15.83l1.41 1.41L19 6.41V10h2V3h-7z"/>\n    </svg>\n    åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€\n  ',t.title="åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å›¾ç‰‡";try{t.dataset.emojiName=e.name,t.dataset.emojiUrl=e.url}catch(n){}return function(e,t){let o=!1;const i=async i=>{try{i.preventDefault(),i.stopPropagation()}catch(n){}if(!o){o=!0;try{const o=e.closest('article, div, figure, [role="presentation"]')?.querySelector('img[src*="i.pximg.net"], img[src*="pximg.net"]');if(o){const e=(o.getAttribute("data-src")||o.getAttribute("data-original")||"").trim(),i=o.getAttribute("srcset")||"",r=e||o.src||(i.split(",")[0]||"").split(" ")[0];if(r&&r.startsWith("http"))try{t={...t,url:r};const e=(o.alt||o.getAttribute("title")||"").trim()||t.name;e&&e.length>0&&(t.name=e)}catch(n){}}}catch(n){}try{if(t&&t.url&&t.url.startsWith("http")){const e=window.open(t.url,"_blank");try{e?.focus()}catch(n){}}else console.warn("[pixiv][open] no valid url to open",{data:t})}catch(r){console.error("[pixiv][open] failed to open url",r)}setTimeout(()=>{o=!1},300)}};e.addEventListener("pointerdown",i),e.addEventListener("click",i)}(t,e),t}function pe(e){try{const t="undefined"!=typeof window&&window.location&&window.location.hostname;if(t&&t.includes("pixiv.net"))return ue(e)}catch(t){}return de(e)}function me(e){if(!e)return;if(e.querySelector(".emoji-add-link-pixiv"))return;const t=function(e){const t=e.querySelector('img[src*="i.pximg.net"]');if(!t)return null;let n="";const o=t.closest("a");if(o&&o.href?n=o.href:t.src&&(n=t.src),!n||!n.startsWith("http"))return null;let i=(t?.alt||t?.getAttribute("title")||"")?.trim()||"";return(!i||i.length<2)&&(i=ae(n)),i=i.replace(/\.(webp|jpg|jpeg|png|gif)$/i,"").trim(),0===i.length&&(i="è¡¨æƒ…"),{name:i,url:n}}(e);if(!t)return;const n=pe(t);try{const t=e,n=window.getComputedStyle(t);"static"!==n.position&&n.position||(t.style.position="relative")}catch(o){}e.appendChild(n)}function ge(){document.querySelectorAll('[role="presentation"]').forEach(e=>{(function(e){try{return!(!e||!e.getAttribute||"presentation"!==e.getAttribute("role")||!e.querySelector('img[src*="i.pximg.net"]'))}catch(t){return!1}})(e)&&me(e)})}function fe(){const e=window.location.hostname.toLowerCase();if(!e.includes("i.pximg.net")&&!e.includes("pximg.net"))return;const t=document.querySelectorAll("img");for(const n of t)if(!n.parentElement?.querySelector(".emoji-add-link-pixiv")&&n.src&&(n.src.includes("i.pximg.net")||n.src.includes("pximg.net"))){const e=n.src,t=pe({name:ae(e),url:e}),o=n.parentElement||document.body;"static"===window.getComputedStyle(o).position&&(o.style.position="relative"),o.appendChild(t);break}}function he(){try{if(!function(){try{const e=window.location.hostname.toLowerCase();if(e.includes("i.pximg.net")||e.includes("pximg.net"))return!0;if(e.includes("pixiv.net"))return!0;if((document.querySelector('meta[property="og:site_name"]')?.getAttribute("content")||"").toLowerCase().includes("pixiv"))return!0;const t=document.querySelector('meta[property="twitter:site"]')||document.querySelector('meta[name="twitter:site"]');if((t&&t.getAttribute("content")||"").toLowerCase().includes("pixiv"))return!0;if((document.querySelector('meta[name="description"]')?.getAttribute("content")||"").toLowerCase().includes("pixiv"))return!0;const n=document.querySelector('meta[property="og:image"]')?.getAttribute("content")||"";return!!(n.includes("pixiv.net")||n.includes("pximg.net")||n.includes("embed.pixiv.net"))}catch(e){return console.error("[PixivAddEmoji] isPixivPage check failed",e),!1}}())return;const e=window.location.hostname.toLowerCase();e.includes("i.pximg.net")||e.includes("pximg.net")?setTimeout(fe,100):setTimeout(ge,100),function(){const e=window.location.hostname.toLowerCase(),t=e.includes("i.pximg.net")||e.includes("pximg.net");new MutationObserver(e=>{let n=!1;e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const o=e;t?("IMG"===o.tagName||o.querySelector&&o.querySelector("img"))&&(n=!0):(o.getAttribute&&"presentation"===o.getAttribute("role")||o.querySelector&&o.querySelector('img[src*="i.pximg.net"]'))&&(n=!0)}})}),n&&setTimeout(()=>{t?fe():ge()},120)}).observe(document.body,{childList:!0,subtree:!0})}()}catch(e){console.error("[PixivAddEmoji] init failed",e)}}function be(e){if(!e)return null;(e=e.trim()).includes(",")&&(e=e.split(",")[0]),(e=e.split(" ")[0]).startsWith("//")?e="https:"+e:e.startsWith("/")&&(e=window.location.origin+e);const t=e.indexOf("@");return-1!==t&&(e=e.slice(0,t)),/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|avif)$/i.test(e)||/^https?:\/\/.+/.test(e)?e:null}function ye(e){const t=[()=>e instanceof HTMLImageElement&&(e.getAttribute("src")||e.getAttribute("data-src")||e.getAttribute("data-original")||e.src)||null,()=>{if(e instanceof HTMLPictureElement){const t=e.querySelector("img");if(t)return t.getAttribute("src")||t.getAttribute("data-src")||t.getAttribute("data-original")||t.src||null;const n=e.querySelector("source[srcset], source[src]");if(n)return n.getAttribute("srcset")||n.getAttribute("src")||null}return null},()=>{const t=e.querySelector("img");return t&&(t.getAttribute("src")||t.getAttribute("data-src")||t.getAttribute("data-original")||t.src)||null},()=>{const t=e.querySelector("source[srcset], source[src]");return t&&(t.getAttribute("srcset")||t.getAttribute("src"))||null},()=>{const t=e;return t.getAttribute("data-src")||t.getAttribute("data-original")||t.getAttribute("data-url")||null},()=>{const t=e,n=t.style.backgroundImage||getComputedStyle(t).backgroundImage;if(n&&"none"!==n){const e=n.match(/url\(['"]?([^'"]+)['"]?\)/);return e?e[1]:null}return null}];for(const o of t)try{const e=o();if(e){const t=be(e);if(t)return t}}catch(n){continue}return null}function we(e){try{const t=new URL(e).pathname.split("/").pop()||"";return decodeURIComponent(t.replace(/\.[^/.]+$/,""))||"è¡¨æƒ…"}catch{return"è¡¨æƒ…"}}function ve(e,t){e.addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation();const o=e.innerHTML,i=e.style.cssText;try{await chrome.runtime.sendMessage({action:"addEmojiFromWeb",emojiData:t}),e.innerHTML="å·²æ·»åŠ ",e.style.background="linear-gradient(135deg, #10b981, #059669)",setTimeout(()=>{e.innerHTML=o,e.style.cssText=i},1500)}catch(r){console.error("[BiliOneClick] æ·»åŠ è¡¨æƒ…å¤±è´¥:",r),e.innerHTML="å¤±è´¥",e.style.background="linear-gradient(135deg, #ef4444, #dc2626)",setTimeout(()=>{e.innerHTML=o,e.style.cssText=i},1500)}})}function xe(e){const t=document.createElement("button");return t.className="bili-emoji-add-btn",t.type="button",t.title="æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",t.innerHTML="â•",t.style.cssText="position:absolute;right:6px;top:6px;z-index:9999;cursor:pointer;border-radius:6px;padding:6px 8px;background:rgba(0,0,0,0.6);color:#fff;border:none;font-weight:700;",ve(t,e),t}var ke=!1,Ee=null,Ce="";function _e(){const e=document.querySelector(".pswp__scroll-wrap");return e?e.querySelector('.pswp__item[aria-hidden="false"]'):null}function je(e,t){const n=document.querySelector(".pswp__top-bar");if(!n||n.querySelector(".bili-emoji-add-btn"))return!1;const o=n.querySelector(".pswp__button--close");if(!o)return!1;const i=function(e){const t=document.createElement("button");return t.className="pswp__button bili-emoji-add-btn",t.type="button",t.title="æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",t.style.cssText="\n    position: relative;\n    display: block;\n    width: 44px;\n    height: 44px;\n    background: none;\n    border: none;\n    cursor: pointer;\n    overflow: visible;\n    appearance: none;\n    box-shadow: none;\n    opacity: 0.75;\n    transition: opacity 0.2s;\n    color: #fff;\n    font-size: 18px;\n    line-height: 44px;\n    text-align: center;\n  ",t.innerHTML="â•",t.addEventListener("mouseenter",()=>{t.style.opacity="1"}),t.addEventListener("mouseleave",()=>{t.style.opacity="0.75"}),ve(t,e),t}({name:e,url:t});return n.insertBefore(i,o),!0}function Le(){try{if(ke)return!1;if(!document.querySelector(".pswp__scroll-wrap"))return!1;const e=function(){const e=_e();return e?e.querySelector(".pswp__img"):null}();if(!e)return!1;if(function(){const e=document.querySelector(".pswp__top-bar");if(e&&e.querySelector(".bili-emoji-add-btn"))return!0;const t=_e();return!(!t||!t.querySelector(".bili-emoji-add-btn"))}())return!1;const t=ye(e);if(!t)return!1;if(t===Ce)return!1;ke=!0,Ce=t;const n=we(t);let o=!1;return o=!!je(n,t)||function(e,t){const n=_e();if(!n)return!1;const o=n.querySelector(".pswp__zoom-wrap");if(!o||o.querySelector(".bili-emoji-add-btn"))return!1;const i=xe({name:e,url:t});return i.style.cssText+="position: absolute; right: 16px; top: 16px; z-index: 10010; background: rgba(0,0,0,0.8);",o.appendChild(i),!0}(n,t),setTimeout(()=>{ke=!1},100),o}catch(e){return ke=!1,!1}}function Se(){Ee&&clearTimeout(Ee),Ee=window.setTimeout(()=>{Le(),Ee=null},150)}function Te(e){const t=document.querySelector(".pswp__scroll-wrap");if(!t)return null;const n=function(e){let t=null;return new MutationObserver(()=>{t&&clearTimeout(t),t=window.setTimeout(()=>{e(),t=null},200)})}(e);return n.observe(t,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["aria-hidden"]}),n}var Ae=[".opus-para-pic .b-img picture",".opus-para-pic .b-img img",".opus-para-pic picture",".opus-para-pic img",".b-img__inner picture",".b-img__inner img",".b-img picture",".b-img img"];var qe=function(){try{const e=window.location.hostname.toLowerCase(),t=window.location.pathname,n=/\/opus\//.test(t),o="t.bilibili.com"===e||e.endsWith(".t.bilibili.com");if(n||o)return[...Ae,".bili-album__preview__picture__img",".bili-album__preview__picture",".bili-album__watch__track__item",".bili-album__watch__content img"]}catch(e){}return[".bili-album__preview__picture__img",".bili-album__preview__picture",".bili-album__watch__track__item",".bili-album__watch__content img"]};function Me(e){try{const t=new URL(e),n=["i0.hdslb.com","i1.hdslb.com","i2.hdslb.com","hdslb.com"].some(e=>t.hostname.includes(e)),o=[".jpg",".jpeg",".png",".gif",".webp",".avif"].some(e=>t.pathname.toLowerCase().includes(e));return n&&(o||t.pathname.includes("/"))}catch{return!1}}function Ne(e){try{if(e.querySelector(".add-emoji"))return;const t=function(){for(const e of[".bili-album__watch__content img",".bili-album__watch__content picture",".bili-album__watch__content .bili-album__preview__picture__img",'.bili-album__watch__content [style*="background-image"]',".bili-album__watch__track__item.active img",".bili-album__watch__track__item.active picture",".bili-album__preview__picture img",".bili-album__preview__picture picture",".bili-album__watch__main img",".bili-album__watch__main picture",'.bili-album img[src*="i0.hdslb.com"]','.bili-album img[src*="i1.hdslb.com"]','.bili-album img[src*="i2.hdslb.com"]','img[src*="hdslb.com"]']){const t=document.querySelectorAll(e);for(const e of t){const t=ye(e);if(t&&Me(t))return e}}return null}();if(!t)return;const n=ye(t);if(!n)return;const o=function(e){const t=document.createElement("div");t.className="bili-album__watch__control__option add-emoji",t.title="æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",t.style.cssText="cursor: pointer;";const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","14"),n.setAttribute("height","14"),n.setAttribute("viewBox","0 0 14 14"),n.setAttribute("fill","currentColor"),n.innerHTML='\n    <path d="M7 0C3.134 0 0 3.134 0 7s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zM5.5 4.5c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1zm3 0c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1zM7 11c-1.657 0-3-1.343-3-3h6c0 1.657-1.343 3-3 3z"/>\n  ';const o=document.createElement("span");return o.textContent="æ·»åŠ è¡¨æƒ…",t.appendChild(n),t.appendChild(o),ve(t,e),t}({name:we(n),url:n});e.appendChild(o)}catch(t){}}function He(e){if(e.querySelector(".bili-emoji-batch-parse"))return;const t=function(e){const t=document.createElement("button");return t.className="bili-emoji-batch-parse",t.type="button",t.title="è§£æå¹¶æ·»åŠ æ‰€æœ‰å›¾ç‰‡åˆ°æœªåˆ†ç»„è¡¨æƒ…",t.innerHTML="ä¸€é”®è§£æå¹¶æ·»åŠ æ‰€æœ‰å›¾ç‰‡",t.style.cssText="display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border-radius:8px;padding:8px 12px;margin:8px 0;font-weight:600;",t.addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation();const o=t.innerHTML;t.innerHTML="æ­£åœ¨è§£æ...",t.disabled=!0;try{const n=[];e.querySelectorAll(".bili-album__preview__picture__img, .bili-album__preview__picture").forEach(e=>n.push(e));let r=0;for(const e of n){const t=ye(e);if(!t)continue;const n=we(t);try{await chrome.runtime.sendMessage({action:"addEmojiFromWeb",emojiData:{name:n,url:t}}),r++}catch(i){console.error("[BiliOneClick] æ‰¹é‡æ·»åŠ å¤±è´¥",t,i)}}t.innerHTML=`å·²å¤„ç† ${r}/${n.length} å¼ å›¾ç‰‡`,setTimeout(()=>{t.innerHTML=o,t.disabled=!1},2e3)}catch(i){console.error("[BiliOneClick] æ‰¹é‡è§£æå¤±è´¥",i),t.innerHTML="è§£æå¤±è´¥",setTimeout(()=>{t.innerHTML=o,t.disabled=!1},2e3)}}),t}(e),n=e.firstChild;n?e.insertBefore(t,n):e.appendChild(t)}function Ie(){document.querySelector(".pswp__scroll-wrap")&&Se();const e=qe(),t=new Set;e.forEach(e=>{document.querySelectorAll(e).forEach(e=>t.add(e))}),t.forEach(e=>function(e){try{if(e.querySelector&&e.querySelector(".bili-emoji-add-btn"))return;let t=null;if(e instanceof HTMLImageElement?t=e:e.querySelector&&(t=e.querySelector("img")),t&&t.classList&&t.classList.contains("pswp__img"))return void Se();const n=ye(e);if(!n)return;const o=we(n),i=e,r=window.getComputedStyle(i);"static"!==r.position&&r.position||(i.style.position="relative");const s=xe({name:o,url:n});i.appendChild(s)}catch(t){}}(e)),document.querySelectorAll(".bili-album__watch__control").forEach(e=>{Ne(e)}),document.querySelectorAll(".bili-album").forEach(e=>{He(e)})}var De=null,Re=null;function ze(){ke=!1,Ce="",Ee&&(clearTimeout(Ee),Ee=null),new MutationObserver(e=>{let t=!1,n=!1;for(const i of e)if("childList"===i.type){if(Array.from(i.addedNodes).some(e=>{if(1===e.nodeType){const t=e;return t.classList&&(t.classList.contains("bili-emoji-add-btn")||t.classList.contains("add-emoji")||t.classList.contains("bili-emoji-batch-parse"))}return!1}))continue;Array.from(i.addedNodes).some(e=>{if(1!==e.nodeType)return!1;const t=e;if("IMG"===t.tagName)return!0;try{return!!t.querySelector&&!!t.querySelector("img")}catch(n){return!1}})&&(t=!0,Array.from(i.addedNodes).some(e=>{if(1===e.nodeType){const t=e;return t.classList&&t.classList.contains("pswp__scroll-wrap")}return!1})&&(n=!0))}else if("attributes"===i.type){const e=i.target;e.classList&&e.classList.contains("pswp__item")&&"aria-hidden"===i.attributeName&&(n=!0);try{const e=i.target;("IMG"===e.tagName||e.querySelector&&e.querySelector("img"))&&(t=!0)}catch(o){}}t&&(De&&clearTimeout(De),De=window.setTimeout(()=>{Ie(),De=null},300)),n&&Se()}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-hidden","class"]});const e=()=>{Re&&(Re.disconnect(),Re=null),(Re=Te(Se))||setTimeout(e,2e3)};setTimeout(e,1e3)}function $e(){try{const e=window.location.hostname.toLowerCase();if("t.bilibili.com"!==e&&!e.endsWith(".t.bilibili.com")&&!function(){try{if(!window.location.hostname.toLowerCase().includes("bilibili.com"))return!1;const e=window.location.pathname;return/\/opus\/\d+/.test(e)}catch(e){return!1}}())return void console.log("[BiliOneClick] skipping init: not a Bilibili opus page or t.bilibili domain");!function(){if(document.getElementById("bilibili-emoji-button-fixes"))return;const e=document.createElement("style");e.id="bilibili-emoji-button-fixes",e.textContent="\n    /* Bilibili Button Styling Fixes */\n    .bili-album__watch__control__option.add-emoji {\n      background: inherit !important;\n      color: inherit !important;\n      font-size: inherit !important;\n      font-weight: inherit !important;\n      padding: inherit !important;\n      border-radius: inherit !important;\n      transition: inherit !important;\n      display: flex !important;\n      align-items: center !important;\n      gap: 4px !important;\n      cursor: pointer !important;\n      user-select: none !important;\n    }\n\n    .bili-album__watch__control__option.add-emoji:hover {\n      background: inherit !important;\n      color: inherit !important;\n    }\n\n    .bili-album__watch__control__option.add-emoji svg {\n      fill: currentColor !important;\n      width: 14px !important;\n      height: 14px !important;\n    }\n\n    .bili-album__watch__control__option.add-emoji span {\n      color: inherit !important;\n      font-size: inherit !important;\n      font-weight: inherit !important;\n    }\n\n    .pswp__button.bili-emoji-add-btn {\n      position: relative !important;\n      display: block !important;\n      width: 44px !important;\n      height: 44px !important;\n      background: none !important;\n      border: none !important;\n      cursor: pointer !important;\n      overflow: visible !important;\n      appearance: none !important;\n      box-shadow: none !important;\n      opacity: 0.75 !important;\n      transition: opacity 0.2s !important;\n      color: #fff !important;\n      font-size: 18px !important;\n      line-height: 44px !important;\n      text-align: center !important;\n    }\n\n    .pswp__button.bili-emoji-add-btn:hover {\n      opacity: 1 !important;\n    }\n  ",document.head.appendChild(e)}(),setTimeout(Ie,200),ze(),console.log("[BiliOneClick] initialized")}catch(e){console.error("[BiliOneClick] init failed",e)}}function Oe(e){if(!e)return null;const t=(e=e.trim()).match(/url\((?:\s*['"]?)(.*?)(?:['"]?\s*)\)/);if(t&&(e=t[1]),e.startsWith("//")?e="https:"+e:e.startsWith("/")&&(e=window.location.origin+e),e.includes(",")&&(e=e.split(",")[0]),e=(e=e.split(" ")[0]).replace(/:large$|:orig$/i,""),!/^https?:\/\//i.test(e))return null;try{const t=new URL(e).hostname.toLowerCase();if(!["pbs.twimg.com","twimg.com","twitter.com","x.com","pbs.twimg"].some(e=>t.endsWith(e)||t.includes(e)))return null}catch{return null}return e}function Pe(e){const t=e.style&&e.style.backgroundImage;if(t&&"none"!==t){const e=Oe(t);if(e)return e}const n=e.querySelector("img");if(n){const e=Oe(n.getAttribute("src")||n.getAttribute("data-src")||n.src||"");if(e)return e}const o=e.src;return o?Oe(o):null}function Be(e){try{const t=new URL(e).pathname.split("/").pop()||"";return decodeURIComponent(t.replace(/\.[^/.]+$/,""))||"è¡¨æƒ…"}catch{return"è¡¨æƒ…"}}function We(e,t){e.addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation();const o=e.innerHTML,i=e.style.cssText;try{await chrome.runtime.sendMessage({action:"addEmojiFromWeb",emojiData:t}),e.innerHTML="å·²æ·»åŠ ",e.style.background="linear-gradient(135deg,#10b981,#059669)",setTimeout(()=>{e.innerHTML=o,e.style.cssText=i},1500)}catch(r){console.error("[XUtils] æ·»åŠ å¤±è´¥",r),e.innerHTML="å¤±è´¥",e.style.background="linear-gradient(135deg,#ef4444,#dc2626)",setTimeout(()=>{e.innerHTML=o,e.style.cssText=i},1500)}})}var Ue=new WeakMap;function Fe(e){const t=document.createElement("button");return t.className="x-emoji-add-btn-carousel",t.type="button",t.title="æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",t.setAttribute("aria-label","æ·»åŠ è¡¨æƒ…"),t.setAttribute("role","button"),t.innerHTML='\n    <div dir="ltr" style="color: rgb(255, 255, 255);">\n      <div></div>\n        <svg viewBox="0 0 24 24" aria-hidden="true">\n          <g><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></g>\n        </svg>\n    </div>\n  ',t.style.cssText="\n    background: rgba(0, 0, 0, 0.6);\n    border: none;\n    cursor: pointer;\n    color: rgb(255, 255, 255);\n    padding: 0;\n    margin: 0;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 9999px;\n    transition: background-color 0.2s ease;\n    min-height: 32px;\n    min-width: 32px;\n    z-index: 9999;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n    backdrop-filter: blur(4px);\n  ".replace(/\s+/g," ").trim(),t.addEventListener("mouseenter",()=>{t.style.backgroundColor="rgba(255, 255, 255, 0.1)"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="transparent"}),t.style.pointerEvents="auto",We(t,e),t}function Xe(e,t){const n=Ue.get(t);if(n)return n.btn;const o=Fe(e);o.style.position="absolute",o.style.zIndex="2147483647",o.style.background="rgba(0,0,0,0.6)",o.style.pointerEvents="auto",document.body.appendChild(o);let i=0;const r=()=>{try{if(!document.body.contains(t))return cancelAnimationFrame(i),o.parentElement&&o.parentElement.removeChild(o),void Ue.delete(t);const e=t.getBoundingClientRect(),n=Math.max(0,window.scrollY+e.top+6),r=Math.max(0,window.scrollX+e.right-o.offsetWidth-6);o.style.top=n+"px",o.style.left=r+"px";const s=e.bottom>=0&&e.top<=window.innerHeight&&e.right>=0&&e.left<=window.innerWidth;o.style.display=s?"":"none"}catch(e){}i=requestAnimationFrame(r),Ue.set(t,{btn:o,raf:i})};return i=requestAnimationFrame(r),Ue.set(t,{btn:o,raf:i}),o}function Ge(e){try{const n=window.location.hostname.toLowerCase(),o="pbs.twimg.com"===n||n.endsWith(".twimg.com")||n.includes("pbs.twimg");if(!(function(e){return!!(e.closest('[role="group"][aria-roledescription="carousel"]')||e.closest('li[role="listitem"]')||e.closest('[data-testid="swipe-to-dismiss"]')||e.closest('div[style*="position: relative"]')?.querySelector('[data-testid="swipe-to-dismiss"]')||e.closest('[role="dialog"]')||e.closest('[aria-modal="true"]')||e.closest('article[data-testid="tweet"]')&&(e.closest('div[aria-label="Image"]')||e.matches('div[aria-label="Image"]')))}(e)||o&&e instanceof HTMLImageElement))return;if(e.querySelector(".x-emoji-add-btn-carousel")||e.querySelector(".x-emoji-add-btn")||e.closest(".x-emoji-add-btn-carousel")||e.closest(".x-emoji-add-btn"))return;let i=null,r=null;if(e instanceof HTMLImageElement){const t=e,n=t.getAttribute("alt")||"",o=(t.src||t.getAttribute("src")||"").toLowerCase(),s=o.includes("pbs.twimg.com")||o.includes("twimg.com");if(""!==n&&!s)return;let a=t.parentElement;for(;a&&a!==document.body;){if(a.querySelector(".x-emoji-add-btn-carousel"))return;const e=window.getComputedStyle(a),n=e.backgroundImage&&"none"!==e.backgroundImage,o="static"!==e.position;if(n||o){i=a,r=Pe(a)||Oe(t.src);break}a=a.parentElement}!i&&t.parentElement&&(i=t.parentElement,r=Oe(t.src))}else{const t=e.querySelector("img");if(t){const e=t.getAttribute("alt")||"",n=(t.src||t.getAttribute("src")||"").toLowerCase(),o=n.includes("pbs.twimg.com")||n.includes("twimg.com");if(""!==e&&!o)return}i=e,r=Pe(e)}if(!i||!r)return;if(r.includes("profile_images"))return;const s=Be(r);if(!function(e,t,n){try{const i=new URL(e);if("pbs.twimg.com"!==i.hostname.toLowerCase()||!i.pathname.startsWith("/media/")&&!i.pathname.includes("/media/"))return!1;if(t.querySelector(".x-emoji-add-btn-carousel")||t.querySelector(".x-emoji-add-btn"))return console.log("[TwitterMedia] button already exists, skipping injection"),!0;let r=null;r=t instanceof HTMLImageElement?t:t.querySelector("img");const s=r||t,a=i.pathname.split("/").pop()?.split("?")[0]||"è¡¨æƒ…";try{return n({name:a,url:e},s),console.log("[TwitterMedia] injected floating overlay for media:",e),!0}catch(o){return console.log("[TwitterMedia] overlay injection failed",o),!1}}catch(o){return console.log("[TwitterMedia] error processing URL:",e,o),!1}}(r,i,Xe)){const e=function(e){let t=e;for(;t&&t!==document.body;){const e=t.parentElement;if(e){const t=e.querySelectorAll('[role="group"]');for(const e of t)if((e.getAttribute("aria-label")||"").match(/replie?s?|repost|like|view|bookmark|ç‚¹èµ|è½¬å‘|å›å¤|æŸ¥çœ‹|æ”¶è—/i))return e}t=e}let n=e;for(;n&&n!==document.body;){const e=n.parentElement;if(e){const t=e.querySelectorAll('[role="group"]');for(const e of t){const t=e.querySelector('[data-testid="reply"], [aria-label*="reply"], [aria-label*="å›å¤"]'),n=e.querySelector('[data-testid="like"], [aria-label*="like"], [aria-label*="ç‚¹èµ"]'),o=e.querySelector('[data-testid="retweet"], [aria-label*="repost"], [aria-label*="è½¬å‘"]'),i=e.querySelectorAll("svg"),r=e.querySelectorAll('button, a[role="link"]');if((t||n||o)&&r.length>=3&&i.length>=3)return e}const n=e.querySelectorAll("div");for(const e of n){const t=e.querySelectorAll('button, a[role="link"]'),n=e.querySelectorAll("svg");if(t.length>=4&&n.length>=4){const n=window.getComputedStyle(e);if("flex"===n.display||"inline-flex"===n.display||e.children.length>=4){let n=0;for(const e of t){const t=e.getAttribute("aria-label")||"",o=e.getAttribute("data-testid")||"";(t.match(/reply|like|repost|share|view|bookmark|å›å¤|ç‚¹èµ|è½¬å‘|åˆ†äº«|æŸ¥çœ‹|æ”¶è—/i)||o.match(/reply|like|retweet|share/i))&&n++}if(n>=2)return e}}}}n=e}return null}(i);if(e&&!e.querySelector(".x-emoji-add-btn-carousel"))!function(e,t){const n=document.createElement("div");n.className="css-175oi2r r-18u37iz r-1h0z5md r-13awgt0";const o=Fe(e);o.classList.add("css-175oi2r","r-1777fci","r-bt1l66","r-bztko3","r-lrvibr","r-1loqt21","r-1ny4l3l"),n.appendChild(o),t.appendChild(n)}({name:s,url:r},e),console.log("[XCarousel] Added button to menu bar");else{const e=i,n=window.getComputedStyle(e),o=/hidden|auto|scroll/.test(n.overflow||"")||!0;if("static"!==n.position&&n.position||(e.style.position="relative"),o)Xe({name:s,url:r},e);else{const n=Fe({name:s,url:r});e.appendChild(n);try{const t=n.getBoundingClientRect(),o=Math.round(t.left+t.width/2),i=Math.round(t.top+t.height/2),a=document.elementFromPoint(o,i);a===n||n.contains(a)||(n.parentElement&&n.parentElement.removeChild(n),Xe({name:s,url:r},e))}catch(t){}}}}}catch(t){}}function Ve(){const e=new Set;['[role="group"][aria-roledescription="carousel"] div[aria-label="Image"]','[role="group"][aria-roledescription="carousel"] div[style*="background-image"]','[role="group"][aria-roledescription="carousel"] img','li[role="listitem"] div[aria-label="Image"]','li[role="listitem"] div[style*="background-image"]','li[role="listitem"] img','[data-testid="swipe-to-dismiss"] div[aria-label="Image"]','[data-testid="swipe-to-dismiss"] div[style*="background-image"]','[data-testid="swipe-to-dismiss"] img','[role="dialog"] div[aria-label="Image"]','[role="dialog"] div[style*="background-image"]','[role="dialog"] img','[aria-modal="true"] div[aria-label="Image"]','[aria-modal="true"] div[style*="background-image"]','[aria-modal="true"] img','article[data-testid="tweet"] div[aria-label="Image"]'].forEach(t=>document.querySelectorAll(t).forEach(t=>e.add(t)));try{const t=window.location.hostname.toLowerCase();("pbs.twimg.com"===t||t.endsWith(".twimg.com")||t.includes("pbs.twimg"))&&document.querySelectorAll("img").forEach(t=>{const n=t.src||t.getAttribute("src")||"";n&&n.includes("pbs.twimg.com")&&e.add(t)})}catch{}e.forEach(e=>Ge(e)),console.log(`[XCarousel] Processed ${e.size} carousel elements`)}var Qe=null,Ye=null;function Ze(){if(Qe)return Qe;Qe=new MutationObserver(e=>{let t=!1;for(const o of e){if("childList"===o.type){for(const e of Array.from(o.addedNodes)){if(1!==e.nodeType)continue;const n=e;if("IMG"===n.tagName||n.querySelector&&n.querySelector("img")){t=!0;break}}if(t)break}if("attributes"===o.type){const e=o.target;if(!e)continue;if("IMG"===e.tagName){t=!0;break}try{if(e.querySelector&&e.querySelector("img")){t=!0;break}}catch(n){}}}t&&(Ye&&clearTimeout(Ye),Ye=window.setTimeout(()=>{try{Ve()}catch(n){}Ye=null},250))});try{Qe.observe(document.body,{childList:!0,subtree:!0,attributes:!0})}catch(e){}return Qe}async function Je(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${t.status} ${t.statusText}`);const n=await t.blob(),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=`video_${Date.now()}.mp4`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}catch(t){try{console.error("[XVideoCopy] ä¸‹è½½å¤±è´¥",t)}catch(n){}try{!function(e){try{if(window.chrome&&window.chrome.runtime&&window.chrome.runtime.sendMessage)try{return void window.chrome.runtime.sendMessage({type:"SHOW_NOTIFICATION",payload:{message:e}})}catch(n){}}catch(n){}}("ä¸‹è½½å¤±è´¥: "+(t&&t.message?t.message:String(t)))}catch(n){}throw t}}function Ke(e,t){e.addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation();const o=e.innerHTML,i=e.style.background;try{t.startsWith("blob:")?(e.innerHTML="ä¸‹è½½ä¸­...",e.style.background="linear-gradient(135deg,#3b82f6,#1d4ed8)",await Je(t),e.innerHTML="å·²ä¸‹è½½",e.style.background="linear-gradient(135deg,#10b981,#059669)",setTimeout(()=>{e.innerHTML=o,e.style.background=i},1400)):(await navigator.clipboard.writeText(t),e.innerHTML="å·²å¤åˆ¶",e.style.background="linear-gradient(135deg,#10b981,#059669)",setTimeout(()=>{e.innerHTML=o,e.style.background=i},1400))}catch(r){console.error("[XVideoCopy] æ“ä½œå¤±è´¥",r),e.innerHTML="å¤±è´¥",e.style.background="linear-gradient(135deg,#ef4444,#dc2626)",setTimeout(()=>{e.innerHTML=o,e.style.background=i},1400)}})}function et(e){const t=document.createElement("button");return t.className="x-video-copy-inline-btn",t.type="button",t.title=e.startsWith("blob:")?"ä¸‹è½½è§†é¢‘":"å¤åˆ¶è§†é¢‘åœ°å€",t.innerHTML="ğŸ“‹",t.style.cssText="display:inline-block;vertical-align:middle;margin-left:8px;cursor:pointer;border-radius:6px;padding:2px 6px;background:rgba(0,0,0,0.06);color:var(--text-color,#0f1419);border:1px solid rgba(0,0,0,0.08);font-weight:600;",Ke(t,e),t}function tt(e){try{const n=e.parentElement||e;if(n.querySelector(".x-video-copy-btn"))return;const o=function(e){try{const t=e.querySelector("source");if(t&&t.src)return t.src;if(e.currentSrc)return e.currentSrc;if(e.src)return e.src}catch(t){}return null}(e);if(!o)return;const i=n,r=window.getComputedStyle(i);"static"!==r.position&&r.position||(i.style.position="relative");const s=function(e){const t=document.createElement("button");return t.className="x-video-copy-btn",t.type="button",t.title=e.startsWith("blob:")?"ä¸‹è½½è§†é¢‘":"å¤åˆ¶è§†é¢‘åœ°å€",t.innerHTML="ğŸ“‹",t.style.cssText="position:absolute;right:6px;top:6px;z-index:99999;cursor:pointer;border-radius:6px;padding:6px 8px;background:rgba(0,0,0,0.6);color:#fff;border:none;font-weight:700;",Ke(t,e),t}(o);i.appendChild(s);try{!function(e,t){let n=e.parentElement;const o=4;for(let r=0;r<o&&n;r++){try{if(n.querySelector(".x-video-copy-inline-btn")){n=n.parentElement;continue}const e=n.querySelector('[data-testid="tweetText"]');if(e){if(!e.querySelector(".x-video-copy-inline-btn")){const n=et(t);try{e.insertAdjacentElement("afterend",n)}catch{const t=e.parentElement;t&&t.appendChild(n)}}return}}catch(i){}if(!n)break;const e=n.parentElement;if(!e)break;n=e}n=e.parentElement;for(let r=0;r<o&&n;r++){try{if(n.querySelector(".x-video-copy-inline-btn")){n=n.parentElement;continue}if(Array.from(n.childNodes).some(e=>{if(e.nodeType===Node.TEXT_NODE)return!(!e.textContent||!e.textContent.trim());if(e.nodeType===Node.ELEMENT_NODE){const t=e;return!(!t.innerText||!t.innerText.trim())}return!1})){const e=et(t),o=Array.from(n.children);let i=!1;for(let t=0;t<o.length;t++){const n=o[t];if(n.innerText&&n.innerText.trim()){n.insertAdjacentElement("afterend",e),i=!0;break}}i||n.appendChild(e)}}catch(i){}if(!n)break;const e=n.parentElement;if(!e)break;n=e}}(e,o)}catch(t){}}catch(t){}}function nt(){Array.from(document.querySelectorAll("video")).forEach(e=>{try{const t=e.getBoundingClientRect();if(t.width<20||t.height<20)return}catch(t){}tt(e)})}function ot(){try{if(!function(){try{const e=window.location.hostname.toLowerCase();return"x.com"===e||e.endsWith(".twitter.com")||e.includes("twitter.com")||"pbs.twimg.com"===e||e.endsWith(".twimg.com")||e.includes("twimg.com")||e.includes("pbs.twimg")}catch{return!1}}())return void console.log("[XVideoCopy] skipping init: not X/Twitter host");setTimeout(nt,200),new MutationObserver(e=>{let t=!1;e.forEach(e=>{"childList"!==e.type&&"attributes"!==e.type||(t=!0)}),t&&setTimeout(nt,120)}).observe(document.body,{childList:!0,subtree:!0,attributes:!0}),console.log("[XVideoCopy] initialized")}catch(e){console.error("[XVideoCopy] init failed",e)}}function it(){try{const e=window.location.hostname;if(console.log("[XOneClick] initX called on host:",e),!function(){try{const e=window.location.hostname.toLowerCase();return"x.com"===e||e.endsWith(".x.com")||"twitter.com"===e||e.endsWith(".twitter.com")||e.includes("twitter.com")}catch{return!1}}())return void console.log(`[XOneClick] skipping init: not X/Twitter host (hostname=${e})`);setTimeout(()=>{Ve(),Ze()},200),ot(),console.log("[XOneClick] initialized")}catch(e){console.error("[XOneClick] init failed",e)}}function rt(){try{const e=window.location.hostname;if(console.log("[XOneClick] initPbs called on host:",e),!function(){try{const e=window.location.hostname.toLowerCase();return"pbs.twimg.com"===e||e.endsWith(".twimg.com")||e.includes("twimg.com")||e.includes("pbs.twimg")}catch{return!1}}())return void console.log(`[XOneClick] skipping pbs init: not pbs/twimg host (hostname=${e})`);setTimeout(()=>{Ve(),Ze()},200),console.log("[XOneClick] pbs initialized")}catch(e){console.error("[XOneClick] initPbs failed",e)}}function st(e){try{const t=e.parentElement||e;if(!t)return;if(t.querySelector&&t.querySelector(".xhs-emoji-add-btn"))return;const n=t,o=window.getComputedStyle(n);"static"!==o.position&&o.position||(n.style.position="relative");const i=e.getAttribute("src")||e.src||Pe(e);if(!i)return;const r=function(e){const t=document.createElement("button");return t.className="xhs-emoji-add-btn",t.type="button",t.title="æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",t.innerText="æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",t.style.cssText="\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    z-index: 2147483647;\n    background: rgba(0,0,0,0.7);\n    color: #fff;\n    border: none;\n    padding: 8px 12px;\n    min-width: 110px;\n    line-height: 1;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    border-radius: 8px;\n    cursor: pointer;\n    font-size: 13px;\n    box-shadow: 0 2px 6px rgba(0,0,0,0.25);\n  ",We(t,e),t}({name:Be(i),url:i});n.appendChild(r)}catch(t){}}function at(){const e=new Set;["img.note-slider-img",".img-container img",".swiper-slide img"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{if(t instanceof HTMLImageElement)e.add(t);else{const n=t.querySelector("img");n&&e.add(n)}})}),e.forEach(e=>st(e))}var ct=null,lt=null;function dt(){try{const e=window.location.hostname;if(console.log("[XHSOneClick] initXhs called on host:",e),!function(){try{const e=window.location.hostname.toLowerCase();return e.includes("xiaohongshu")||e.includes("xhs")}catch{return!1}}())return void console.log("[XHSOneClick] skipping init: not xhs host");setTimeout(()=>{at(),function(){if(ct)return ct;ct=new MutationObserver(e=>{let t=!1;for(const o of e){if("childList"===o.type)for(const e of Array.from(o.addedNodes)){if(1!==e.nodeType)continue;const o=e;if("IMG"===o.tagName&&o.classList.contains("note-slider-img")){t=!0;break}try{if(o.querySelector&&o.querySelector("img.note-slider-img")){t=!0;break}}catch(n){}}else if("attributes"===o.type){const e=o.target;"IMG"===e.tagName&&e.classList.contains("note-slider-img")&&(t=!0)}if(t)break}t&&(lt&&clearTimeout(lt),lt=window.setTimeout(()=>{at(),lt=null},250))});try{ct.observe(document.body,{childList:!0,subtree:!0,attributes:!0})}catch(e){}}()},200),console.log("[XHSOneClick] initialized")}catch(e){console.error("[XHSOneClick] init failed",e)}}function ut(e){try{if(!e)return!1;if(e.getAttribute&&"presentation"===e.getAttribute("role"))return!!e.querySelector("img");const t=e.className||"";return!(!t.includes("media-lightbox-img")&&!t.includes("preview-img"))&&!!e.querySelector("img")}catch(t){return!1}}function pt(e){try{if(!e)return;if(e.querySelector(".reddit-emoji-add-btn")||e.querySelector(".emoji-add-link-pixiv"))return;const n=function(e){try{const t=e.querySelector("img");if(!t||!t.src)return null;let n=t.getAttribute("src")||t.src||"";const o=t.getAttribute("srcset")||"";if(n&&!n.startsWith("data:")||!o||(n=((o.split(",").pop()||"").split(" ")[0]||"").trim()||n),!n||!n.startsWith("http"))return null;let i=(t.getAttribute("alt")||t.getAttribute("title")||"")?.trim()||"";return(!i||i.length<2)&&(i="reddit-emoji"),{name:i,url:n}}catch(t){return null}}(e);if(!n)return;const o=function(e){const t=document.createElement("button");t.className="reddit-emoji-add-btn",t.type="button",t.title="æ·»åŠ åˆ°æœªåˆ†ç»„è¡¨æƒ…",t.innerHTML="â•",t.style.cssText="position:absolute;right:8px;top:8px;z-index:100000;cursor:pointer;border-radius:6px;padding:6px 8px;background:rgba(0,0,0,0.6);color:#fff;border:none;font-weight:700;";const n=async n=>{try{n.preventDefault(),n.stopPropagation()}catch(o){}try{const n=window.chrome;if(!n||!n.runtime||!n.runtime.sendMessage)return void console.error("[RedditAddEmoji] Chrome runtime not available");n.runtime.sendMessage({action:"addEmojiFromWeb",emojiData:e},e=>{try{e&&e.success?(t.innerHTML="å·²æ·»åŠ ",t.style.background="linear-gradient(135deg, #10b981, #059669)",setTimeout(()=>{t.innerHTML="â•",t.style.cssText="position:absolute;right:8px;top:8px;z-index:100000;cursor:pointer;border-radius:6px;padding:6px 8px;background:rgba(0,0,0,0.6);color:#fff;border:none;font-weight:700;"},1500)):(t.innerHTML="å¤±è´¥",t.style.background="linear-gradient(135deg, #ef4444, #dc2626)",setTimeout(()=>{t.innerHTML="â•",t.style.cssText="position:absolute;right:8px;top:8px;z-index:100000;cursor:pointer;border-radius:6px;padding:6px 8px;background:rgba(0,0,0,0.6);color:#fff;border:none;font-weight:700;"},1500))}catch(o){}})}catch(i){console.error("[RedditAddEmoji] sendMessage failed",i)}};return t.addEventListener("click",n),t.addEventListener("pointerdown",n),t}(n);try{const t=e,n=window.getComputedStyle(t);"static"!==n.position&&n.position||(t.style.position="relative")}catch(t){}e.appendChild(o)}catch(n){console.error("[RedditAddEmoji] addEmojiButtonToContainer failed",n)}}function mt(){try{Array.from(document.querySelectorAll('[role="presentation"], .media-lightbox-img, .preview-img')).forEach(e=>{ut(e)&&pt(e)});const e=Array.from(document.querySelectorAll("img"));for(const t of e){const e=t.parentElement;if(!e)continue;if(e.querySelector(".reddit-emoji-add")||e.querySelector(".emoji-add-link-pixiv"))continue;const n=e.className||"";(n.includes("media-lightbox-img")||n.includes("preview-img")||"post-content"===e.getAttribute("data-test-id"))&&pt(e)}}catch(e){console.error("[RedditAddEmoji] scan failed",e)}}function gt(){try{const e=window.location.hostname.toLowerCase();if(!e.includes("reddit.com")&&!e.includes("redd.it"))return;setTimeout(mt,200),new MutationObserver(e=>{let t=!1;e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{if(e.nodeType!==Node.ELEMENT_NODE)return;const n=e;(ut(n)||n.querySelector&&n.querySelector("img"))&&(t=!0)})}),t&&setTimeout(mt,120)}).observe(document.body,{childList:!0,subtree:!0}),console.log("[RedditAddEmoji] initialized")}catch(e){console.error("[RedditAddEmoji] init failed",e)}}console.log("[Emoji Extension] Content script loaded (entry)"),!function(){if(document.querySelectorAll('meta[name*="discourse"], meta[content*="discourse"], meta[property*="discourse"]').length>0)return console.log("[Emoji Extension] Discourse detected via meta tags"),!0;const e=document.querySelector('meta[name="generator"]');if(e){const t=e.getAttribute("content")?.toLowerCase()||"";if(t.includes("discourse")||t.includes("flarum")||t.includes("phpbb"))return console.log("[Emoji Extension] Forum platform detected via generator meta"),!0}const t=window.location.hostname.toLowerCase();return["linux.do","meta.discourse.org"].some(e=>t.includes(e))?(console.log("[Emoji Extension] Allowed domain detected:",t),!0):document.querySelectorAll("textarea.d-editor-input, .ProseMirror.d-editor-input, .composer-input, .reply-area textarea").length>0?(console.log("[Emoji Extension] Discussion editor detected"),!0):(console.log("[Emoji Extension] No compatible platform detected"),!1)}()?(!function(){try{he()}catch(e){console.error("[OneClickAdd] initPixiv failed",e)}try{$e()}catch(e){console.error("[OneClickAdd] initBilibili failed",e)}try{gt()}catch(e){console.error("[OneClickAdd] initReddit failed",e)}try{!async function(){try{const t=await U("enableXcomExtraSelectors"),n=null==t||!0===t;if(null==t?console.log("[XOneClick] enableXcomExtraSelectors unavailable; defaulting to enabled for X injection"):console.log("[XOneClick] fetched enableXcomExtraSelectors from background:",t),console.log("[XOneClick] init decision - enabled:",n),n)try{it(),rt(),console.log("[XOneClick] initX invoked")}catch(e){console.error("[XOneClick] initX threw an error during invocation",e)}else console.log("[XOneClick] skipping init: enableXcomExtraSelectors disabled in settings")}catch(t){console.error("[OneClickAdd] initX check failed",t)}}()}catch(e){console.error("[OneClickAdd] initX failed",e)}try{dt()}catch(t){console.error("[XOneClick] initXhs failed",t)}}(),console.log("[Emoji Extension] Skipping injection - incompatible platform")):(console.log("[Emoji Extension] Initializing emoji feature"),async function e(n=10,o=1e3){console.log("[Emoji Extension] Initializing (module)..."),await t(),X(),function(){const e=['button.btn.btn-icon-text.btn-primary.create.topic-footer-button[title*="å›å¤"]','button.btn.no-text.btn-icon.btn-default.create.reply-to-post[title*="å›å¤"]','button.btn.btn-icon-text.post-action-menu__reply.reply.create[title*="å›å¤"]'];document.addEventListener("click",t=>{const n=t.target;e.some(e=>{try{return n.matches(e)||n.closest(e)}catch(t){return!1}})&&(console.log("[Emoji Extension] Reply button clicked, checking for injection needs..."),setTimeout(()=>{se()},500),setTimeout(()=>{se()},2e3))}),new MutationObserver(t=>{let n=!1;t.forEach(t=>{t.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){const o=t;e.some(e=>{try{return o.matches(e)||o.querySelector(e)}catch(t){return!1}})&&(n=!0)}})}),n&&(console.log("[Emoji Extension] Reply buttons detected in DOM changes, checking injection..."),setTimeout(()=>{se()},500))}).observe(document.body,{childList:!0,subtree:!0}),console.log("[Emoji Extension] Reply button listeners initialized")}();let i=0;function r(){i++;const t=w();let s=0;t.forEach(e=>{e.querySelector(".emoji-extension-button")||e.querySelector(".image-upload-button")||(console.log("[Emoji Extension] Toolbar found, injecting buttons."),C(e),s++)}),s>0||t.length>0||(i<n?(console.log(`[Emoji Extension] Toolbar not found, attempt ${i}/${n}. Retrying ${o/1e3} s.`),setTimeout(r,o)):n<20?e(20,2e3):n<40?e(40,4e3):n<80?e(80,8e3):n<160?e(160,16e3):n<320?e(320,32e3):n<640?e(640,64e3):(console.error("[Emoji Extension] Failed to find toolbar after multiple attempts. Button injection failed. æˆ‘æ„Ÿè§‰ä½ æ˜¯äººæœº"),console.log("[Emoji Extension] Showing floating button as fallback"),Q()))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",r):r();try{re()}catch(s){console.warn("[Emoji Extension] Failed to start read tracker",s)}window.chrome?.storage?.onChanged&&window.chrome.storage.onChanged.addListener((e,n)=>{if("local"===n){const n=["emojiGroups","emojiGroupIndex","appSettings"];Object.keys(e).some(e=>n.includes(e)||e.startsWith("emojiGroup_"))&&(console.log("[Emoji Extension] Storage change detected (module), reloading data"),t())}}),window.chrome?.runtime?.onMessage&&window.chrome.runtime.onMessage.addListener((e,n,o)=>{"SETTINGS_UPDATED"===e.type&&(console.log("[Emoji Extension] Settings updated from background, reloading data"),t())}),setInterval(()=>{w().forEach(e=>{e.querySelector(".emoji-extension-button")||e.querySelector(".image-upload-button")||(console.log("[Emoji Extension] Toolbar found but buttons missing, injecting... (module)"),C(e))})},3e4),setInterval(()=>{Y()},5e3),setInterval(()=>{console.log("[Emoji Extension] Periodic data reload (module)"),t()},12e4)}()),window.location.hostname.includes("linux.do")&&chrome.runtime.onMessage.addListener((e,t,n)=>{if("GET_CSRF_TOKEN"===e.type)try{const e=document.querySelector('meta[name="csrf-token"]');if(e)return n({csrfToken:e.content}),!0;const t=document.cookie.match(/csrf_token=([^;]+)/);if(t)return n({csrfToken:decodeURIComponent(t[1])}),!0;const o=document.querySelector('input[name="authenticity_token"]');return o?(n({csrfToken:o.value}),!0):(n({csrfToken:""}),!0)}catch(o){return console.warn("[Emoji Extension] Failed to get CSRF token:",o),n({csrfToken:""}),!0}return!1});try{window.location.hostname.includes("linux.do")&&(window.postTimings=d,window.autoReadAllRepliesV2=g)}catch(ft){console.warn("[Emoji Extension] failed to expose postTimings to window",ft)}