async function e(){try{if("undefined"==typeof fetch)return null;const e=await fetch("/assets/defaultEmojiGroups.json",{cache:"no-cache"});return e.ok?await e.json():null}catch(e){return null}}async function t(){const t=await e();return t&&Array.isArray(t.groups)?t.groups:[]}async function o(){const o=await e();return o||{groups:await t(),settings:{imageScale:30,defaultGroup:"nachoneko",showSearchBar:!0,gridColumns:4,outputFormat:"markdown",forceMobileMode:!1,enableLinuxDoInjection:!1,enableXcomExtraSelectors:!0,lastModified:Date.now(),tenorApiKey:"AIzaSyC-P6_qz3FzCoXGLk6tgitZo4jEJ5mLzD8"}}}var s={imageScale:100,defaultGroup:"nachoneko",showSearchBar:!0,gridColumns:4,outputFormat:"markdown",forceMobileMode:!1,enableHoverPreview:!0,enableLinuxDoInjection:!0,enableXcomExtraSelectors:!1,enableCalloutSuggestions:!0,customColorScheme:"default",customPrimaryColor:"#1890ff"};function r(){if("undefined"!=typeof browser&&browser.runtime)return a();if("undefined"!=typeof chrome&&chrome.runtime)return n();if("undefined"!=typeof globalThis){if(globalThis.browser?.runtime)return a();if(globalThis.chrome?.runtime)return n()}return null}function a(){const e=browser;return{storage:{local:{get:t=>e.storage.local.get(t),set:t=>e.storage.local.set(t),remove:t=>e.storage.local.remove(t),clear:()=>e.storage.local.clear()},sync:{get:t=>e.storage.sync.get(t),set:t=>e.storage.sync.set(t),remove:t=>e.storage.sync.remove(t),clear:()=>e.storage.sync.clear()},onChanged:e.storage.onChanged},runtime:{onMessage:e.runtime.onMessage,sendMessage:t=>e.runtime.sendMessage(t),onInstalled:e.runtime.onInstalled,get lastError(){return e.runtime.lastError}},tabs:{query:t=>e.tabs.query(t),sendMessage:(t,o)=>e.tabs.sendMessage(t,o),executeScript:e.tabs.executeScript?(t,o)=>e.tabs.executeScript(t,o):void 0},scripting:e.scripting?{executeScript:t=>e.scripting.executeScript(t)}:void 0,contextMenus:e.contextMenus?{create:t=>e.contextMenus.create(t),onClicked:e.contextMenus.onClicked}:void 0,downloads:e.downloads?{download:t=>e.downloads.download(t)}:void 0,cookies:e.cookies?{get:t=>e.cookies.get(t),set:t=>e.cookies.set(t)}:void 0}}function n(){const e=chrome;function t(t,o){return(...s)=>new Promise((r,a)=>{t.apply(o,[...s,t=>{e.runtime.lastError?a(e.runtime.lastError):r(t)}])})}return{storage:{local:{get:t(e.storage.local.get,e.storage.local),set:t(e.storage.local.set,e.storage.local),remove:t(e.storage.local.remove,e.storage.local),clear:t(e.storage.local.clear,e.storage.local)},sync:{get:t(e.storage.sync.get,e.storage.sync),set:t(e.storage.sync.set,e.storage.sync),remove:t(e.storage.sync.remove,e.storage.sync),clear:t(e.storage.sync.clear,e.storage.sync)},onChanged:e.storage.onChanged},runtime:{onMessage:e.runtime.onMessage,sendMessage:t(e.runtime.sendMessage,e.runtime),onInstalled:e.runtime.onInstalled,get lastError(){return e.runtime.lastError}},tabs:{query:t(e.tabs.query,e.tabs),sendMessage:t(e.tabs.sendMessage,e.tabs),executeScript:e.tabs.executeScript?t(e.tabs.executeScript,e.tabs):void 0},scripting:e.scripting?{executeScript:t(e.scripting.executeScript,e.scripting)}:void 0,contextMenus:e.contextMenus?{create:t=>e.contextMenus.create(t),onClicked:e.contextMenus.onClicked}:void 0,downloads:e.downloads?{download:t(e.downloads.download,e.downloads)}:void 0,cookies:e.cookies?{get:t(e.cookies.get,e.cookies),set:t(e.cookies.set,e.cookies)}:void 0}}const i={SETTINGS:"appSettings",FAVORITES:"favorites",GROUP_INDEX:"emojiGroupIndex",GROUP_PREFIX:"emojiGroup_"},c="emojiExtensionBackup";function l(){return r()}function u(e,t,o,s){const r=`[Storage ${(new Date).toISOString()}]`;if(s)console.error(`${r} ${e} FAILED for "${t}":`,s);else{const s=["MULTI_SET_SUCCESS","IDB_SET","RESET_DEFAULTS","SYNC_BACKUP"].includes(e)?" - success":"";if(void 0!==o){const a=function(e){try{const t=JSON.stringify(e),o=t.length;return o>2e3?{preview:t.slice(0,500)+"... (truncated)",size:o}:{preview:JSON.parse(t),size:o}}catch{try{return{preview:String(e)}}catch{return{preview:"[unserializable data]"}}}}(o);console.log(`${r} ${e} for "${t}" - size: ${a.size??"unknown"}${s}`,a.preview)}else console.log(`${r} ${e} for "${t}"${s}`)}}function g(e){try{return JSON.parse(JSON.stringify(e))}catch(t){if(u("SERIALIZE_CLEAN","data",void 0,t),"object"==typeof e&&null!==e&&!Array.isArray(e)){const t={};for(const[o,s]of Object.entries(e))try{JSON.stringify(s),t[o]=s}catch{u("SERIALIZE_CLEAN",`skipped property: ${o}`,void 0,"unserializable")}return t}return Array.isArray(e)?e.map(e=>g(e)):e}}var S=class{async get(e){try{if("undefined"==typeof localStorage)return null;const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return u("LOCAL_GET",e,void 0,t),null}}async set(e,t){try{if("undefined"==typeof localStorage)return;localStorage.setItem(e,JSON.stringify(t)),u("LOCAL_SET",e,t)}catch(o){throw u("LOCAL_SET",e,void 0,o),o}}async remove(e){try{if("undefined"==typeof localStorage)return;localStorage.removeItem(e),u("LOCAL_REMOVE",e)}catch(t){u("LOCAL_REMOVE",e,void 0,t)}}},d=class{async get(e){try{if("undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return u("SESSION_GET",e,void 0,t),null}}async set(e,t){try{if("undefined"==typeof sessionStorage)return;sessionStorage.setItem(e,JSON.stringify(t)),u("SESSION_SET",e,t)}catch(o){throw u("SESSION_SET",e,void 0,o),o}}async remove(e){try{if("undefined"==typeof sessionStorage)return;sessionStorage.removeItem(e),u("SESSION_REMOVE",e)}catch(t){u("SESSION_REMOVE",e,void 0,t)}}},E=class{async get(e){const t=l();if(!t?.storage?.local)return u("EXT_GET",e,{available:!1,reason:"Browser Storage API not available"}),null;try{const o=(await t.storage.local.get({[e]:null}))[e];return u("EXT_GET",e,o),o}catch(o){return u("EXT_GET",e,void 0,o),null}}async set(e,t){const o=l();if(o?.storage?.local)try{await o.storage.local.set({[e]:t}),u("EXT_SET",e,t)}catch(s){throw u("EXT_SET",e,void 0,s),s}else u("EXT_SET",e,{available:!1,reason:"Browser Storage API not available"})}async remove(e){const t=l();if(t?.storage?.local)try{await t.storage.local.remove(e),u("EXT_REMOVE",e)}catch(o){throw u("EXT_REMOVE",e,void 0,o),o}else u("EXT_REMOVE",e,{available:!1,reason:"Browser Storage API not available"})}},m=new class{localStorage=new S;sessionStorage=new d;extensionStorage=new E;writeTimers=new Map;async get(e){u("MULTI_GET_START",e);let t=await this.localStorage.get(e);return null!=t?(u("MULTI_GET_SUCCESS",e,{source:"localStorage",value:t}),t):(t=await this.sessionStorage.get(e),null!=t?(u("MULTI_GET_SUCCESS",e,{source:"sessionStorage",value:t}),t):(t=await this.extensionStorage.get(e),null!=t?(u("MULTI_GET_SUCCESS",e,{source:"extensionStorage",value:t}),t):(u("MULTI_GET_FAILED",e),null)))}async set(e,t,o){const s={data:g(t),timestamp:o||Date.now()};if(u("MULTI_SET_START",e,s),this.writeTimers.has(e)){const t=this.writeTimers.get(e);t&&clearTimeout(t)}try{await this.localStorage.set(e,s),setTimeout(async()=>{try{await this.sessionStorage.set(e,s)}catch(t){u("MULTI_SET_SESSION_FAILED",e,void 0,t)}},100),setTimeout(async()=>{try{await this.extensionStorage.set(e,s)}catch(t){u("MULTI_SET_EXTENSION_FAILED",e,void 0,t)}},500),u("MULTI_SET_SUCCESS",e,s)}catch(r){throw u("MULTI_SET_FAILED",e,void 0,r),r}}async remove(e){if(u("MULTI_REMOVE",e),this.writeTimers.has(e)){const t=this.writeTimers.get(e);t&&clearTimeout(t),this.writeTimers.delete(e)}await Promise.allSettled([this.localStorage.remove(e),this.sessionStorage.remove(e),this.extensionStorage.remove(e)])}async getWithConflictResolution(e){const t=await Promise.allSettled([this.localStorage.get(e),this.sessionStorage.get(e),this.extensionStorage.get(e)]);let o=null,s=0;return t.forEach((e,t)=>{if("fulfilled"===e.status&&e.value){const t=e.value.timestamp||0;t>s&&(s=t,o=e.value.data)}}),null!==o?(u("CONFLICT_RESOLUTION",e,{timestamp:s,value:o}),o):null}};const y={getEmojiGroupIndex:async()=>await m.getWithConflictResolution(i.GROUP_INDEX)||[],async setEmojiGroupIndex(e){await m.set(i.GROUP_INDEX,e)},getEmojiGroup:async e=>await m.getWithConflictResolution(i.GROUP_PREFIX+e),async setEmojiGroup(e,t){await m.set(i.GROUP_PREFIX+e,t)},async removeEmojiGroup(e){await m.remove(i.GROUP_PREFIX+e)},async getAllEmojiGroups(){const e=await this.getEmojiGroupIndex();if(!e.length){try{const e=await t();if(e&&e.length)return e}catch(o){}return[]}return(await Promise.all(e.map(async e=>{const t=await this.getEmojiGroup(e.id);return t?{...t,order:e.order}:null}))).filter(e=>null!==e).sort((e,t)=>e.order-t.order)},async setAllEmojiGroups(e){const t=e.map((e,t)=>({id:e.id,order:t}));await this.setEmojiGroupIndex(t),await Promise.all(e.map(e=>this.setEmojiGroup(e.id,e)))},async getSettings(){const e=await m.getWithConflictResolution(i.SETTINGS);if(e&&"object"==typeof e)return{...s,...e};try{const e=await o();if(e&&e.settings&&Object.keys(e.settings).length>0)return{...s,...e.settings}}catch(t){}return{...s}},async setSettings(e){const t={...e,lastModified:Date.now()};await m.set(i.SETTINGS,t)},getFavorites:async()=>await m.getWithConflictResolution(i.FAVORITES)||[],async setFavorites(e){await m.set(i.FAVORITES,e)},async backupToSync(e,t,o){const s=l();if(!s?.storage?.sync)return void u("SYNC_BACKUP","failed",void 0,"Chrome Sync Storage API not available");const r={groups:e,settings:t,favorites:o,timestamp:Date.now(),version:"3.0"};return new Promise((e,t)=>{try{s.storage.sync.set({[c]:r},()=>{s.runtime.lastError?(u("SYNC_BACKUP","failed",void 0,s.runtime.lastError),t(s.runtime.lastError)):(u("SYNC_BACKUP","success",r),e())})}catch(o){u("SYNC_BACKUP","failed",void 0,o),t(o)}})},async restoreFromSync(){const e=l();return e?.storage?.sync?new Promise(t=>{try{e.storage.sync.get({[c]:null},async o=>{if(e.runtime.lastError)u("SYNC_RESTORE","failed",void 0,e.runtime.lastError),t(null);else{const e=o[c];e&&e.groups?(u("SYNC_RESTORE","found backup",e),await this.setAllEmojiGroups(e.groups),await this.setSettings(e.settings||s),await this.setFavorites(e.favorites||[]),t({groups:e.groups,settings:e.settings||s,favorites:e.favorites||[],timestamp:e.timestamp||0})):(u("SYNC_RESTORE","no backup found"),t(null))}})}catch(o){u("SYNC_RESTORE","failed",void 0,o),t(null)}}):(u("SYNC_RESTORE","failed",void 0,"Chrome Sync Storage API not available"),null)},async resetToDefaults(){u("RESET_DEFAULTS","start");try{try{const e=await o();await this.setAllEmojiGroups(e&&e.groups&&e.groups.length?e.groups:[])}catch(e){await this.setAllEmojiGroups([])}await this.setSettings(s),await this.setFavorites([]),u("RESET_DEFAULTS","success")}catch(t){throw u("RESET_DEFAULTS","failed",void 0,t),t}}};export{t as a,s as i,y as n,o,r,i as t};